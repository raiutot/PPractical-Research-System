<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Practical Research 2 Management System of GRP#4</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            display: flex;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ecf0f1;
        }
        .member-btn {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background: none;
            border: none;
            color: #ecf0f1;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .member-btn:hover {
            background-color: #34495e;
        }
        .member-btn.active {
            background-color: #3498db;
            font-weight: bold;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            background-color: #ecf0f1;
        }
        .dashboard {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .dashboard h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        .btn-success:hover {
            background-color: #27ae60;
        }
        .member-details {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .member-details h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        .stat-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .stat-item h4 {
            margin: 0 0 10px 0;
            color: #7f8c8d;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: none;
            border: none;
            font-weight: bold;
            color: #7f8c8d;
            transition: all 0.3s ease;
            position: relative;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab:hover {
            background-color: #f8f9fa;
            color: #2c3e50;
        }
        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            background-color: #f8f9fa;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .event-item, .meeting-item {
            background-color: white;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .event-title, .meeting-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .event-details, .meeting-details {
            color: #7f8c8d;
            font-size: 14px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .close {
            font-size: 24px;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        
        /* Login Screen Styles */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .login-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 400px;
        }
        
        .login-title {
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: bold;
        }
        
        .login-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .login-input {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .login-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .login-btn {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
        }
        
        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .role-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .role-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .admin-only {
            display: none;
        }
        
        .member-view .admin-only {
            display: none !important;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .members-list {
            margin: 15px 0;
        }
        .member-checkbox {
            margin-bottom: 8px;
        }
        .checkbox-group {
            margin: 15px 0;
        }
        .checkbox-item {
            margin-bottom: 10px;
        }
        .reason-input {
            margin-top: 15px;
            display: none;
        }
        .clickable-stat {
            transition: color 0.3s, transform 0.2s;
        }
        .clickable-stat:hover {
            color: #3498db !important;
            transform: scale(1.05);
        }
        .member-specific-reason {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container" style="justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div style="background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 100%; max-width: 450px; text-align: center;">
            <div style="margin-bottom: 30px;">
                <h1 style="color: #2c3e50; margin: 0 0 10px 0; font-size: 28px;">üìö PR2 Management System</h1>
                <p style="color: #7f8c8d; margin: 0; font-size: 16px;">Group #4 - Practical Research 2</p>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h2 style="color: #34495e; margin: 0 0 20px 0; font-size: 20px;">üë§ Member Login</h2>
                <div class="form-group" style="text-align: left;">
                    <label for="member-select" style="color: #2c3e50; font-weight: bold;">Select Your Name:</label>
                    <select id="member-select" class="form-control" style="font-size: 16px; padding: 12px;">
                        <option value="">-- Choose Your Name --</option>
                    </select>
                </div>
                <div class="form-group" style="text-align: left; margin-top: 15px;">
                    <label for="member-password" style="color: #2c3e50; font-weight: bold;">Password:</label>
                    <input type="password" id="member-password" class="form-control" placeholder="Enter your password" value="" style="font-size: 16px; padding: 12px;">
                </div>
                <button onclick="attemptLogin()" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px; margin-top: 20px; background: linear-gradient(135deg, #3498db, #2980b9);">üîì Login</button>
                <button onclick="populateLoginMembers()" class="btn" style="width: 100%; padding: 8px; font-size: 12px; margin-top: 10px; background: #6c757d; color: white;">üîÑ Refresh Member List</button>
            </div>
            
            <div style="border-top: 1px solid #ecf0f1; padding-top: 20px;">
                <h3 style="color: #e74c3c; margin: 0 0 15px 0; font-size: 18px;">üõ†Ô∏è Admin Access</h3>
                <button onclick="adminLogin()" class="btn" style="width: 100%; padding: 10px; font-size: 14px; background: #34495e; color: white;">üëë Login as Administrator</button>
            </div>
            
            <div style="margin-top: 25px; padding: 15px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #3498db;">
                <h4 style="margin: 0 0 10px 0; color: #2c3e50; font-size: 14px;">üí° Default Passwords:</h4>
                <p style="margin: 0; font-size: 12px; color: #7f8c8d;">Each member has their own unique password | Admin: <strong>admin123</strong></p>
                <p style="margin: 5px 0 0 0; font-size: 11px; color: #95a5a6; font-style: italic;">Ask your group leader to change passwords for security.</p>
            </div>
        </div>
    </div>
    
    <!-- User Info Display -->
    <div class="user-info" id="user-info" style="display: none;">
        <!-- User info moved to sidebar -->
    </div>
    <div class="container" id="main-app" style="display: none;">
        <!-- Sidebar with member buttons -->
        <div class="sidebar">
            <div style="padding: 15px; border-bottom: 1px solid #34495e; text-align: center;">
                <div style="color: #ecf0f1; font-size: 14px; margin-bottom: 8px;">Logged in as:</div>
                <div id="logged-user-name" style="color: #3498db; font-weight: bold; font-size: 16px;"></div>
            </div>
            
            <h2>Group Members</h2>
            <div id="member-buttons-container">
                <button class="member-btn" onclick="showMember('patalinghug')">Patalinghug, Raijin (Leader)</button>
                <button class="member-btn" onclick="showMember('sibal')">Sibal, Mary (Secretary)</button>
                <button class="member-btn" onclick="showMember('abon')">Abon, Althea Reese</button>
                <button class="member-btn" onclick="showMember('caritativo')">Caritativo, Pete Ezra</button>
                <button class="member-btn" onclick="showMember('delossantos')">Delos Santos, John Zachary</button>
                <button class="member-btn" onclick="showMember('martos')">Martos, Markjoshua</button>
            </div>
            
            <!-- Navigation Section -->
            <div style="margin-top: 30px; padding: 15px; border-top: 1px solid #34495e;">
                <h4 style="color: #ecf0f1; margin: 0 0 10px 0; font-size: 14px; text-align: center;">Navigation</h4>
                <button class="member-btn" onclick="showMySessionsModal()" style="background: #34495e; margin-bottom: 5px;">üìù My Sessions</button>
                <button class="member-btn" onclick="showContributionSummary()" style="background: #34495e; margin-bottom: 5px;">üí∞ Money Summary</button>
                <button class="member-btn admin-only" onclick="openManageMembersModal()" style="background: #27ae60; margin-bottom: 5px;">üë§ Manage Members</button>
                <button class="member-btn admin-only" onclick="openApprovalRequestsModal()" style="background: #e67e22; margin-bottom: 5px;">üìã Approval Requests <span id="pending-requests-count" style="background: #e74c3c; color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; margin-left: 5px; display: none;">0</span></button>
            </div>
            
            <!-- Recently Deleted Section - Positioned at Bottom -->
            <div style="margin-top: 30px; padding: 15px; border-top: 1px solid #34495e; background-color: #2c3e50; width: 100%; box-sizing: border-box;">
                <h4 style="color: #ecf0f1; margin: 0 0 10px 0; font-size: 14px; text-align: center;">Recently Deleted</h4>
                <div id="recently-deleted-list" style="max-height: 150px; overflow-y: auto;">
                    <!-- Recently deleted items will appear here -->
                </div>
                <div style="text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #34495e;" class="admin-only">
                    <button onclick="clearAllDeleted()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 11px; cursor: pointer;">Clear All</button>
                </div>
            </div>
            
            <!-- Change Password Section - Admin Only -->
            <div style="margin-top: 30px; padding: 15px; border-top: 1px solid #34495e;" class="admin-only">
                <button onclick="openChangePasswordModal()" style="background: #f39c12; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: bold; width: 100%; text-align: center; margin-bottom: 10px;">
                    üîë Change Passwords
                </button>
            </div>
            
            <!-- Logout Section at Bottom -->
            <div style="margin-top: 30px; padding: 15px; border-top: 1px solid #34495e;">
                <button onclick="logout()" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: bold; width: 100%; text-align: center;">
                    üö™ Logout
                </button>
            </div>
        </div>

        <!-- Main content area -->
        <div class="main-content">
            <!-- System Title Header -->
            <div style="background: linear-gradient(135deg, #3498db, #2c3e50); padding: 12px 20px; margin-bottom: 20px; border-radius: 0 0 8px 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                <h1 style="color: #ffffff; margin: 0; font-size: 20px; font-weight: 600; text-align: center; text-shadow: 0 1px 3px rgba(0,0,0,0.3); letter-spacing: 1px;">
                    Practical Research 2 Management System of GRP#4
                </h1>
            </div>
            
            <!-- Quick Actions -->
            <div class="dashboard admin-only">
                <h2>Quick Actions</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary admin-only" onclick="openSessionModal()">Add Session</button>
                    <button class="btn btn-primary admin-only" onclick="openContributionModal()">Money Contributions</button>
                    <button class="btn admin-only" onclick="exportData()" style="background-color: #17a2b8; color: white;">Export Data</button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn admin-only" onclick="document.getElementById('import-file').click()" style="background-color: #6c757d; color: white;">Import Data</button>
                </div>
            </div>
            
            <!-- Member details section -->
            <div class="member-details">
                <h3 id="member-name">Select a member to view details</h3>
                <div class="stats">
                    <div class="stat-item">
                        <h4>Number of tardiness</h4>
                        <div class="stat-value clickable-stat" id="tardiness" onclick="showAttendanceDetails('tardiness')" style="cursor: pointer; text-decoration: underline;">0</div>
                        <input type="number" id="tardiness-input" class="form-control" style="margin-top: 5px; display: none;" min="0">
                    </div>
                    <div class="stat-item">
                        <h4>Number of absences</h4>
                        <div class="stat-value clickable-stat" id="absences" onclick="showAttendanceDetails('absences')" style="cursor: pointer; text-decoration: underline;">0</div>
                        <input type="number" id="absences-input" class="form-control" style="margin-top: 5px; display: none;" min="0">
                    </div>
                    <div class="stat-item">
                        <h4>Number of missed activities</h4>
                        <div class="stat-value clickable-stat" id="missed-activities" onclick="showAttendanceDetails('missedActivities')" style="cursor: pointer; text-decoration: underline;">0</div>
                        <input type="number" id="missed-activities-input" class="form-control" style="margin-top: 5px; display: none;" min="0">
                    </div>
                    <div class="stat-item">
                        <h4>Number of late submissions</h4>
                        <div class="stat-value clickable-stat" id="late-submissions" onclick="showAttendanceDetails('lateSubmissions')" style="cursor: pointer; text-decoration: underline;">0</div>
                        <input type="number" id="late-submissions-input" class="form-control" style="margin-top: 5px; display: none;" min="0">
                    </div>
                    <div class="stat-item">
                        <h4>Deductions</h4>
                        <div class="stat-value clickable-stat" id="deductions" onclick="showDeductionDetails()" style="cursor: pointer; text-decoration: underline;">0</div>
                        <input type="number" id="deductions-input" class="form-control" style="margin-top: 5px; display: none;" min="0" step="0.5">
                    </div>
                </div>
                <div id="member-actions" style="margin-top: 20px; display: none;">
                    <button class="btn btn-primary" onclick="toggleEditMode()">Edit Stats</button>
                    <button class="btn btn-success" onclick="saveStats()" style="display: none;" id="save-btn">Save Changes</button>
                    <button class="btn" onclick="cancelEdit()" style="display: none;" id="cancel-btn">Cancel</button>
                    <button class="btn btn-primary" onclick="openPaymentModal()" style="margin-left: 10px;">Manage Payments</button>
                    <button class="btn btn-primary" onclick="openNotesModal()" style="margin-left: 10px;">Member Notes</button>
                </div>
                
                <!-- Payment Status -->
                <div id="payment-status" style="margin-top: 20px; display: none;">
                    <h4>Payment Status</h4>
                    <div id="payment-list">
                        <!-- Payment status will be shown here -->
                    </div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('sessions')">Sessions</button>
                <button class="tab" onclick="switchTab('contributions')">Money Contributions</button>
                <button class="tab" onclick="switchTab('grades')">Grades</button>
                <button class="tab" onclick="switchTab('alerts')">Alerts</button>
                <button class="tab" onclick="switchTab('budget')">Budget</button>
                <button class="tab" onclick="switchTab('notes')">Notes</button>
                <button class="tab" onclick="switchTab('data')">Data</button>
                <button class="tab" onclick="switchTab('achievements')">Achievements</button>
            </div>

            <div id="sessions-tab" class="tab-content active">
                <h3>Recent Sessions</h3>
                <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px;">
                    <h4>Filter Sessions</h4>
                    <div style="display: flex; gap: 15px; align-items: center;">
                        <select id="sessions-filter-category" class="form-control" style="width: 200px;">
                            <option value="all">All Categories</option>
                            <option value="Meeting ONLY">Meeting ONLY</option>
                            <option value="Meeting /w PAPERWORKS">Meeting /w PAPERWORKS</option>
                            <option value="Defense">Defense</option>
                            <option value="Consultation">Consultation</option>
                            <option value="Activity / Task">Activity / Task</option>
                        </select>
                        <select id="sessions-filter-status" class="form-control" style="width: 150px;">
                            <option value="all">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                        <select id="sessions-filter-member" class="form-control" style="width: 200px;">
                            <option value="all">All Members</option>
                            <option value="patalinghug">Patalinghug, Raijin (Leader)</option>
                            <option value="sibal">Sibal, Mary (Secretary)</option>
                            <option value="abon">Abon, Althea Reese</option>
                            <option value="caritativo">Caritativo, Pete Ezra</option>
                            <option value="delossantos">Delos Santos, John Zachary</option>
                            <option value="martos">Martos, Markjoshua</option>
                        </select>
                        <input type="date" id="sessions-filter-date" class="form-control" style="width: 150px;">
                        <button class="btn btn-primary" onclick="filterSessions()">Filter</button>
                        <button class="btn" onclick="clearSessionFilters()">Clear</button>
                    </div>
                </div>
                <div id="sessions-list">
                    <!-- Recent sessions will be listed here -->
                </div>
            </div>

            <div id="contributions-tab" class="tab-content">
                <h3>Money Contributions</h3>
                <div id="contributions-list">
                    <!-- Money Contributions will be listed here -->
                </div>
            </div>

            <div id="grades-tab" class="tab-content">
                <h3>Grade Calculation</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Grading Criteria</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label>Tardiness Penalty:</label>
                            <input type="number" id="tardiness-penalty" value="-1" step="0.1" class="form-control admin-only">
                            <div class="member-view" style="display: none; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">-1.0 points per incident</div>
                        </div>
                        <div>
                            <label>Absence Penalty:</label>
                            <input type="number" id="absence-penalty" value="-2" step="0.1" class="form-control admin-only">
                            <div class="member-view" style="display: none; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">-2.0 points per incident</div>
                        </div>
                        <div>
                            <label>Missed Activity Penalty:</label>
                            <input type="number" id="missed-activity-penalty" value="-3" step="0.1" class="form-control admin-only">
                            <div class="member-view" style="display: none; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">-3.0 points per incident</div>
                        </div>
                        <div>
                            <label>Late Submission Penalty:</label>
                            <input type="number" id="late-submission-penalty" value="-1" step="0.1" class="form-control admin-only">
                            <div class="member-view" style="display: none; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-top: 5px;">-1.0 points per incident</div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="calculateGrades()">Calculate Grades</button>
                </div>
                <div id="grades-list">
                    <!-- Calculated grades will be shown here -->
                </div>
            </div>

            <div id="alerts-tab" class="tab-content">
                <h3>Alerts & Notifications</h3>
                <div id="alerts-list">
                    <!-- Alerts will be shown here -->
                </div>
            </div>
            
            <div id="budget-tab" class="tab-content">
                <h3>Budget Tracking</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Add Expense</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label>Description:</label>
                            <input type="text" id="expense-description" class="form-control" placeholder="What was purchased?">
                        </div>
                        <div>
                            <label>Amount:</label>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-weight: bold;">‚Ç±</span>
                                <input type="number" id="expense-amount" class="form-control" placeholder="0.00" step="0.01" min="0">
                            </div>
                        </div>
                        <div>
                            <label>Category:</label>
                            <select id="expense-category" class="form-control">
                                <option value="supplies">Supplies</option>
                                <option value="food">Food</option>
                                <option value="transportation">Transportation</option>
                                <option value="materials">Materials</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label>Date:</label>
                            <input type="date" id="expense-date" class="form-control">
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="addExpense()">Add Expense</button>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Budget Summary</h4>
                    <div id="budget-summary">
                        <!-- Budget summary will be populated here -->
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h4>Expense History</h4>
                    <div id="expense-list">
                        <!-- Expense history will be shown here -->
                    </div>
                </div>
            </div>
            
            <div id="notes-tab" class="tab-content">
                <h3>All Notes & Comments</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Filter Notes</h4>
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                        <select id="notes-filter-member" class="form-control" style="width: 200px;">
                            <option value="all">All Members</option>
                            <option value="patalinghug">Patalinghug, Raijin (Leader)</option>
                            <option value="abon">Abon, Althea Reese</option>
                            <option value="caritativo">Caritativo, Pete Ezra</option>
                            <option value="delossantos">Delos Santos, John Zachary</option>
                            <option value="martos">Martos, Markjoshua</option>
                        </select>
                        <select id="notes-filter-category" class="form-control" style="width: 150px;">
                            <option value="all">All Categories</option>
                            <option value="general">General</option>
                            <option value="attendance">Attendance</option>
                            <option value="performance">Performance</option>
                            <option value="behavior">Behavior</option>
                            <option value="financial">Financial</option>
                        </select>
                        <button class="btn btn-primary" onclick="filterNotes()">Filter</button>
                    </div>
                </div>
                <div id="all-notes-list">
                    <!-- All notes will be displayed here -->
                </div>
            </div>
            
            <div id="data-tab" class="tab-content">
                <h3>Data Management</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Export Options</h4>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="exportData()">Export All Data (JSON)</button>
                        <button class="btn btn-success" onclick="exportAttendanceCSV()">Export Attendance Report (CSV)</button>
                        <button class="btn" onclick="backupData()" style="background-color: #fd7e14; color: white;">Create Backup</button>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Data Management</h4>
                    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                        <button class="btn admin-only" onclick="clearAllSessions()" style="background-color: #e74c3c; color: white;">üóëÔ∏è Clear All Sessions</button>
                        <button class="btn admin-only" onclick="clearAllContributions()" style="background-color: #e67e22; color: white;">üóëÔ∏è Clear All Contributions</button>
                        <button class="btn admin-only" onclick="resetAllMemberStats()" style="background-color: #9b59b6; color: white;">üîÑ Reset Member Stats</button>
                    </div>
                    <div style="background: #ffebee; border: 1px solid #f44336; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        <p style="margin: 0; font-size: 12px; color: #d32f2f;">
                            <strong>‚ö†Ô∏è Warning:</strong> These operations will permanently delete data and cannot be undone. Make sure to create a backup first!
                        </p>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Import Options</h4>
                    <p>Import previously exported data files to restore or transfer data.</p>
                    <input type="file" id="data-import-file" accept=".json" style="margin-bottom: 10px;" onchange="importData(event)">
                    <br>
                    <small style="color: #666;">‚ö†Ô∏è Warning: Importing will replace all current data. Make sure to backup first!</small>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h4>System Information</h4>
                    <div style="font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 4px;">
                        <div><strong>Total Members:</strong> <span id="stats-members">4</span></div>
                        <div><strong>Total Sessions:</strong> <span id="stats-sessions">0</span></div>
                        <div><strong>Total Contributions:</strong> <span id="stats-contributions">0</span></div>
                        <div><strong>Total Expenses:</strong> <span id="stats-expenses">0</span></div>
                        <div><strong>Total Notes:</strong> <span id="stats-notes">0</span></div>
                        <div><strong>Last Updated:</strong> <span id="stats-updated">-</span></div>
                    </div>
                    <button class="btn btn-primary" onclick="updateSystemStats()" style="margin-top: 10px;">Refresh Stats</button>
                </div>
            </div>
            
            <div id="achievements-tab" class="tab-content">
                <h3>Achievements & Rankings</h3>
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Performance Leaderboard</h4>
                    <button class="btn btn-primary" onclick="generateLeaderboard(); generateAchievementBadges(); generateImprovementTracking();" style="float: right; font-size: 12px; padding: 5px 10px; margin-top: -15px;">Refresh Rankings</button>
                    <div id="leaderboard">
                        <!-- Leaderboard will be populated here -->
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Achievement Badges</h4>
                    <div id="achievement-badges">
                        <!-- Achievement badges will be shown here -->
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h4>Improvement Tracking</h4>
                    <div id="improvement-tracking">
                        <!-- Improvement stats will be shown here -->
                    </div>
                </div>
            </div>
            
            <!-- Analytics Dashboard -->
            <div class="dashboard" style="margin-top: 30px;">
                <h2>Analytics Dashboard</h2>
                
                <!-- Global Search -->
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <h4>Global Search</h4>
                    <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                        <input type="text" id="global-search" class="form-control" placeholder="Search all data..." style="flex: 1;">
                        <select id="search-type" class="form-control" style="width: 150px;">
                            <option value="all">All Data</option>
                            <option value="events">Events Only</option>
                            <option value="meetings">Meetings Only</option>
                            <option value="contributions">Contributions Only</option>
                            <option value="expenses">Expenses Only</option>
                        </select>
                        <input type="date" id="search-date-from" class="form-control" style="width: 150px;" placeholder="From date">
                        <input type="date" id="search-date-to" class="form-control" style="width: 150px;" placeholder="To date">
                        <button class="btn btn-primary" onclick="globalSearch()">Search</button>
                        <button class="btn" onclick="clearSearch()">Clear</button>
                    </div>
                    <div id="search-results" style="display: none; margin-top: 15px;">
                        <h5>Search Results:</h5>
                        <div id="search-results-content"></div>
                    </div>
                </div>
                
                <!-- Performance Charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <h4>Performance Overview</h4>
                        <canvas id="performanceChart" width="300" height="200"></canvas>
                        <div style="margin-top: 10px; font-size: 12px; color: #666;">
                            <div style="display: flex; gap: 15px; justify-content: center;">
                                <span><span style="color: #f39c12;">‚ñ†</span> Tardiness</span>
                                <span><span style="color: #e74c3c;">‚ñ†</span> Absences</span>
                                <span><span style="color: #9b59b6;">‚ñ†</span> Missed Activities</span>
                                <span><span style="color: #3498db;">‚ñ†</span> Late Submissions</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <h4>Financial Overview</h4>
                        <div id="financialSummary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <!-- Financial summary will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for adding sessions -->
    <div id="session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Session</h2>
                <span class="close" onclick="closeSessionModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="session-category">Session Category</label>
                <select id="session-category" class="form-control">
                    <option value="Meeting ONLY">Meeting ONLY</option>
                    <option value="Meeting /w PAPERWORKS">Meeting /w PAPERWORKS</option>
                    <option value="Defense">Defense</option>
                    <option value="Consultation">Consultation</option>
                    <option value="Activity / Task">Activity / Task</option>
                </select>
            </div>
            <div class="form-group">
                <label for="session-name">Session Name</label>
                <input type="text" id="session-name" class="form-control" placeholder="Enter specific name for this session">
            </div>
            <div class="form-group">
                <label for="session-start">Start of Session</label>
                <input type="datetime-local" id="session-start" class="form-control">
            </div>
            <div class="form-group">
                <label for="session-end">End of Session (Deadline)</label>
                <input type="datetime-local" id="session-end" class="form-control">
            </div>
            <div class="form-group">
                <label>Attendees</label>
                <div class="members-list">
                    <div class="member-checkbox" style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <label for="session-patalinghug" style="margin: 0; flex: 1;">Patalinghug, Raijin (Leader)</label>
                        <input type="checkbox" id="session-patalinghug" value="patalinghug" style="margin: 0;">
                    </div>
                    <div class="member-checkbox" style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <label for="session-abon" style="margin: 0; flex: 1;">Abon, Althea Reese</label>
                        <input type="checkbox" id="session-abon" value="abon" style="margin: 0;">
                    </div>
                    <div class="member-checkbox" style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <label for="session-caritativo" style="margin: 0; flex: 1;">Caritativo, Pete Ezra</label>
                        <input type="checkbox" id="session-caritativo" value="caritativo" style="margin: 0;">
                    </div>
                    <div class="member-checkbox" style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <label for="session-delossantos" style="margin: 0; flex: 1;">Delos Santos, John Zachary</label>
                        <input type="checkbox" id="session-delossantos" value="delossantos" style="margin: 0;">
                    </div>
                    <div class="member-checkbox" style="display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;">
                        <label for="session-martos" style="margin: 0; flex: 1;">Martos, Markjoshua</label>
                        <input type="checkbox" id="session-martos" value="martos" style="margin: 0;">
                    </div>
                </div>
                <button class="btn" onclick="selectAll('session')">Select All</button>
            </div>
            <button class="btn btn-primary" onclick="saveSession()">Save Session</button>
        </div>
    </div>

    <!-- Modal for completing events -->
    <div id="complete-event-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Complete Event: <span id="complete-event-title"></span></h2>
                <span class="close" onclick="closeCompleteEventModal()">&times;</span>
            </div>
            <div class="checkbox-group">
                <h4>Mark members who missed the activity or submitted late:</h4>
                <div id="event-members-checklist">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            <div id="event-reason-input" class="reason-input" style="display: block;">
                <label for="event-reason">General completion reason (required):</label>
                <textarea id="event-reason" class="form-control" placeholder="Enter general reason for completing this event (e.g., 'Completed project presentation', 'Finished research review')"></textarea>
                <small style="color: #666; font-style: italic;">Note: If you mark members with issues, you'll be asked for specific reasons for each person.</small>
            </div>
            <button class="btn btn-primary" onclick="submitEventCompletion()">Submit</button>
        </div>
    </div>

    <!-- Modal for completing meetings -->
    <!-- Modal for adding money contributions -->
    <div id="contribution-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contribution-modal-title">Money Contributions</h2>
                <span class="close" onclick="closeContributionModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="contribution-amount">Amount to be contributed</label>
                <div style="display: flex; align-items: center; gap: 5px;">
                    <span style="font-weight: bold; font-size: 16px;">‚Ç±</span>
                    <input type="number" id="contribution-amount" class="form-control" placeholder="Enter amount" step="0.01" min="0" oninput="calculatePerMember()">
                </div>
                <div id="per-member-display" style="margin-top: 8px; font-size: 14px; color: #666; font-weight: bold;">
                    <!-- Per member calculation will appear here -->
                </div>
            </div>
            <div class="form-group">
                <label for="contribution-purpose">The money will be spent for:</label>
                <textarea id="contribution-purpose" class="form-control" placeholder="Describe what the money will be used for" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="contribution-deadline">Deadline</label>
                <input type="datetime-local" id="contribution-deadline" class="form-control">
            </div>
            <button class="btn btn-primary" id="save-contribution-btn" onclick="saveContribution()">Save Contribution</button>
            <button class="btn btn-secondary" id="cancel-edit-btn" onclick="cancelEditContribution()" style="display: none; margin-left: 10px;">Cancel</button>
        </div>
    </div>

    <!-- Modal for managing member notes -->
    <div id="notes-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Member Notes - <span id="notes-member-name"></span></h2>
                <span class="close" onclick="closeNotesModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="note-text">Add New Note:</label>
                <textarea id="note-text" class="form-control" placeholder="Enter your note about this member..." rows="3"></textarea>
                <div style="margin-top: 10px;">
                    <select id="note-category" class="form-control" style="width: 200px; display: inline-block; margin-right: 10px;">
                        <option value="general">General</option>
                        <option value="attendance">Attendance</option>
                        <option value="performance">Performance</option>
                        <option value="behavior">Behavior</option>
                        <option value="financial">Financial</option>
                    </select>
                    <button class="btn btn-primary admin-only" onclick="addMemberNote()">Add Note</button>
                </div>
            </div>
            <div id="notes-history">
                <h4>Previous Notes:</h4>
                <div id="notes-list">
                    <!-- Notes will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for approval requests -->
    <div id="approval-requests-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìã Approval Requests</h2>
                <span class="close" onclick="closeApprovalRequestsModal()">&times;</span>
            </div>
            <div style="margin-bottom: 20px;">
                <p style="color: #666; font-size: 14px; margin: 0;">Review and approve/reject member requests for session management, expenses, and payments. Approved requests will be processed immediately.</p>
            </div>
            <div id="approval-requests-list">
                <!-- Approval requests will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for managing payment history -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Payments - <span id="payment-member-name"></span></h2>
                <span class="close" onclick="closePaymentModal()">&times;</span>
            </div>
            <div id="contribution-payments">
                <!-- Contributions and payment status will be listed here -->
            </div>
        </div>
    </div>

    <!-- Modal for contribution summary -->
    <div id="contribution-summary-modal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>üí∞ Money Contribution Summary</h2>
                <span class="close" onclick="closeContributionSummaryModal()">&times;</span>
            </div>
            <div id="contribution-summary-content">
                <!-- Summary will be populated here -->
            </div>
        </div>
    </div>

    <!-- Modal for My Sessions -->
    <div id="my-sessions-modal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2>üìù My Sessions Overview</h2>
                <span class="close" onclick="closeMySessionsModal()">&times;</span>
            </div>
            
            <!-- Session Statistics -->
            <div style="background: linear-gradient(135deg, #3498db, #2c3e50); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; text-align: center;">üìà Sessions Overview</h3>
                <div id="session-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                    <!-- Statistics will be populated here -->
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0;">‚ö° Quick Actions</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-primary admin-only" onclick="openSessionModal(); closeMySessionsModal()">‚ûï Add New Session</button>
                    <button class="btn btn-success" onclick="filterMySessionsByStatus('pending')">‚ö° Show Active Only</button>
                    <button class="btn btn-warning" onclick="filterMySessionsByStatus('completed')">‚úÖ Show Completed Only</button>
                    <button class="btn btn-danger" onclick="filterMySessionsByStatus('cancelled')">‚ùå Show Canceled Only</button>
                    <button class="btn" onclick="renderMySessions()">üîÑ Show All</button>
                    <button class="btn btn-danger admin-only" onclick="showBulkDeleteOptions()" style="background: #dc3545;">üóëÔ∏è Bulk Delete</button>
                    <button class="btn admin-only" onclick="deleteCompletedSessions()" style="background: #6c757d; color: #adb5bd; font-size: 12px;">üóëÔ∏è Delete Completed</button>
                    <button class="btn admin-only" onclick="selectiveDeleteCompleted()" style="background: #95a5a6; color: #ecf0f1; font-size: 12px;">‚òëÔ∏è Select & Delete</button>
                </div>
            </div>
            
            <!-- Sessions Sections -->
            <!-- Active Sessions Section -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #f39c12;">‚ö° Active Sessions</h3>
                    <div id="active-sessions-count" style="background: #f39c12; color: white; padding: 5px 12px; border-radius: 15px; font-size: 14px; font-weight: bold;">
                        0 sessions
                    </div>
                </div>
                <div id="active-sessions-list">
                    <!-- Active sessions will be populated here -->
                </div>
            </div>
            
            <!-- Completed Sessions Section -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #27ae60;">‚úÖ Completed Sessions</h3>
                    <div id="completed-sessions-count" style="background: #27ae60; color: white; padding: 5px 12px; border-radius: 15px; font-size: 14px; font-weight: bold;">
                        0 sessions
                    </div>
                </div>
                <div id="completed-sessions-list">
                    <!-- Completed sessions will be populated here -->
                </div>
            </div>
            
            <!-- Canceled Sessions Section -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #e74c3c;">‚ùå Canceled Sessions</h3>
                    <div id="canceled-sessions-count" style="background: #e74c3c; color: white; padding: 5px 12px; border-radius: 15px; font-size: 14px; font-weight: bold;">
                        0 sessions
                    </div>
                </div>
                <div id="canceled-sessions-list">
                    <!-- Canceled sessions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for completing sessions -->
    <div id="complete-session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Complete Session: <span id="complete-session-title"></span></h2>
                <span class="close" onclick="closeCompleteSessionModal()">&times;</span>
            </div>
            <div class="checkbox-group">
                <h4>Attendance Issues:</h4>
                <div id="session-members-checklist">
                    <!-- Will be populated dynamically based on session category -->
                </div>
            </div>
            <div class="form-group">
                <label for="session-completion-reason">General completion reason (required):</label>
                <textarea id="session-completion-reason" class="form-control" placeholder="Enter reason for completing this session"></textarea>
            </div>
            <div id="manual-deduction-section" style="background: #f8f9fa; padding: 15px; margin: 15px 0; border-radius: 6px; border-left: 4px solid #17a2b8;">
                <h5>Manual Deductions (Optional)</h5>
                <div id="deduction-entries">
                    <!-- Dynamic deduction entries will appear here -->
                </div>
                <button type="button" class="btn btn-secondary" onclick="addDeductionEntry()" style="margin-top: 10px;">Add Deduction</button>
            </div>
            <button class="btn btn-primary" onclick="submitSessionCompletion()">Submit</button>
        </div>
    </div>

    <!-- Modal for showing deduction details -->
    <div id="deduction-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Deduction Details - <span id="deduction-details-member"></span></h2>
                <span class="close" onclick="closeDeductionDetailsModal()">&times;</span>
            </div>
            <div id="deduction-details-content">
                <!-- Deduction details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Modal for rescheduling sessions -->
    <div id="reschedule-session-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Reschedule Session: <span id="reschedule-session-title"></span></h2>
                <span class="close" onclick="closeRescheduleModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="reschedule-start">New Start Time</label>
                <input type="datetime-local" id="reschedule-start" class="form-control">
            </div>
            <div class="form-group">
                <label for="reschedule-end">New End Time</label>
                <input type="datetime-local" id="reschedule-end" class="form-control">
            </div>
            <div class="form-group">
                <label for="reschedule-reason">Reason for Rescheduling</label>
                <textarea id="reschedule-reason" class="form-control" placeholder="Enter reason for rescheduling this session" rows="3"></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitReschedule()">Reschedule Session</button>
            <button class="btn btn-secondary" onclick="closeRescheduleModal()" style="margin-left: 10px;">Cancel</button>
        </div>
    </div>

    <div id="complete-meeting-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Complete Meeting: <span id="complete-meeting-title"></span></h2>
                <span class="close" onclick="closeCompleteMeetingModal()">&times;</span>
            </div>
            <div class="checkbox-group">
                <h4>Mark members who were tardy or absent:</h4>
                <div id="meeting-members-checklist">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            <div id="meeting-reason-input" class="reason-input" style="display: block;">
                <label for="meeting-reason">General completion reason (required):</label>
                <textarea id="meeting-reason" class="form-control" placeholder="Enter general reason for completing this meeting (e.g., 'Discussed project progress', 'Planned next steps')"></textarea>
                <small style="color: #666; font-style: italic;">Note: If you mark members with issues, you'll be asked for specific reasons for each person.</small>
            </div>
            <button class="btn btn-primary" onclick="submitMeetingCompletion()">Submit</button>
        </div>
    </div>

    <!-- Modal for viewing attendance details -->
    <div id="attendance-details-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Attendance Details - <span id="attendance-details-member"></span></h2>
                <span class="close" onclick="closeAttendanceDetailsModal()">&times;</span>
            </div>
            <div id="attendance-details-content">
                <!-- Details will be populated here -->
            </div>
        </div>
    </div>

    <!-- Modal for managing group members -->
    <div id="manage-members-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üë§ Manage Group Members</h2>
                <span class="close" onclick="closeManageMembersModal()">&times;</span>
            </div>
            
            <div style="margin-bottom: 25px;">
                <h3 style="color: #27ae60; margin-bottom: 15px;">‚ûï Add New Member</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="new-member-lastname">Last Name:</label>
                        <input type="text" id="new-member-lastname" class="form-control" placeholder="Enter last name">
                    </div>
                    <div class="form-group">
                        <label for="new-member-firstname">First Name:</label>
                        <input type="text" id="new-member-firstname" class="form-control" placeholder="Enter first name">
                    </div>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="new-member-leader" style="margin-right: 8px;">
                        Mark as Group Leader
                    </label>
                </div>
                <button class="btn btn-success" onclick="addNewMember()">‚ûï Add Member</button>
            </div>
            
            <div>
                <h3 style="color: #e74c3c; margin-bottom: 15px;">üóëÔ∏è Remove Members</h3>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #856404; font-size: 14px;">
                        <strong>Warning:</strong> Removing a member will permanently delete all their data including attendance records, notes, payments, and deductions. This action cannot be undone.
                    </p>
                </div>
                <div id="current-members-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Current members will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('Script loaded successfully');
        // Authentication System
        let currentUser = null;
        let userRole = null; // 'member' or 'admin'
        let userPasswords = {
            patalinghug: 'raiutotpogi26',
            admin: 'admin123',
            sibal: 'maarysibal',
            abon: 'abonara',
            delossantos: 'Bobo_Slayer',
            caritativo: 'Enzooogi123',
            martos: 'Kalapato123',
            member: 'member123' // fallback for old compatibility
        };
        
        // Authentication Functions
        function attemptLogin() {
            const selectedMember = document.getElementById('member-select').value;
            const password = document.getElementById('member-password').value;
            
            if (!selectedMember) {
                alert('Please select your name from the dropdown.');
                return;
            }
            
            // Check if the entered password matches the specific member's password
            if (password !== userPasswords[selectedMember]) {
                alert('Incorrect password for ' + members[selectedMember].name + '. Please check your password.');
                return;
            }
            
            // Set current user as member
            currentUser = selectedMember;
            userRole = 'member';
            
            // Show main interface
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            
            // Update UI for member view
            initializeMemberView(selectedMember);
        }
        
        function adminLogin() {
            console.log('adminLogin function called');
            const password = prompt('Enter administrator password:');
            
            if (!password) {
                return;
            }
            
            if (password !== userPasswords.admin) {
                alert('Incorrect administrator password. Current admin password required.');
                return;
            }
            
            // Set current user as admin
            currentUser = 'admin';
            userRole = 'admin';
            
            // Show main interface
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            
            // Update UI for admin view
            initializeAdminView();
        }
        
        function initializeMemberView(memberId) {
            // Update logged user name in sidebar
            document.getElementById('logged-user-name').textContent = members[memberId].name;
            
            // Add member view class to body
            document.body.classList.add('member-view');
            
            // Hide admin-only elements
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show member view elements (penalty displays)
            document.querySelectorAll('.member-view').forEach(el => {
                el.style.display = 'block';
            });
            
            // Update penalty displays with current values
            updatePenaltyDisplays();
            
            // Auto-select the member's own data (members can only see their own by default)
            showMember(memberId);
            
            // Initialize the interface
            init();
        }
        
        function initializeAdminView() {
            // Update logged user name in sidebar
            document.getElementById('logged-user-name').textContent = 'Administrator';
            
            // Remove member view class from body
            document.body.classList.remove('member-view');
            
            // Show admin-only elements
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'block';
            });
            
            // Hide member view elements (penalty displays) for admin
            document.querySelectorAll('.member-view').forEach(el => {
                el.style.display = 'none';
            });
            
            // Update pending requests count
            updatePendingRequestsCount();
            
            // Initialize the interface
            init();
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Reset user data
                currentUser = null;
                userRole = null;
                currentMember = null;
                
                // Show login screen
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-screen').style.display = 'flex';
                
                // Clear sidebar user name
                document.getElementById('logged-user-name').textContent = '';
                
                // Clear any sensitive data display
                document.getElementById('member-name').textContent = 'Select a member to view details';
                document.getElementById('member-actions').style.display = 'none';
                document.getElementById('payment-status').style.display = 'none';
                
                // Remove member view class
                document.body.classList.remove('member-view');
            }
        }
        
        function checkAccess(action) {
            if (userRole === 'admin') return true;
            
            // Member can only view their own data (read-only)
            if (action === 'view' && currentMember === currentUser) return true;
            if (action === 'view-others') return false; // Members need password to see others' status
            if (action === 'manage') return false; // Only admins can manage
            if (action === 'edit') return false; // Only admins can edit
            
            return false;
        }
        
        function changePassword(role) {
            if (!checkAccess('manage')) return;
            
            const newPassword = document.getElementById(`new-${role}-password`).value.trim();
            if (!newPassword) {
                alert('Please enter a new password.');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }
            
            userPasswords[role] = newPassword;
            saveToLocalStorage();
            
            // Clear the input
            document.getElementById(`new-${role}-password`).value = '';
            
            alert(`${role.charAt(0).toUpperCase() + role.slice(1)} password has been changed successfully!`);
        }
        
        // Data storage
        let members = {
            patalinghug: { name: "Patalinghug, Raijin (Leader)", password: "raiutotpogi26", tardiness: 0, absences: 0, missedActivities: 0, lateSubmissions: 0, deductions: 0, payments: [], notes: [], attendanceRecords: [], deductionRecords: [] },
            sibal: { name: "Sibal, Mary (Secretary)", password: "maarysibal", tardiness: 0, absences: 0, missedActivities: 0, lateSubmissions: 0, deductions: 0, payments: [], notes: [], attendanceRecords: [], deductionRecords: [] },
            abon: { name: "Abon, Althea Reese", password: "abonara", tardiness: 0, absences: 0, missedActivities: 0, lateSubmissions: 0, deductions: 0, payments: [], notes: [], attendanceRecords: [], deductionRecords: [] },
            caritativo: { name: "Caritativo, Pete Ezra", password: "Enzooogi123", tardiness: 0, absences: 0, missedActivities: 0, lateSubmissions: 0, deductions: 0, payments: [], notes: [], attendanceRecords: [], deductionRecords: [] },
            delossantos: { name: "Delos Santos, John Zachary", password: "Bobo_Slayer", tardiness: 0, absences: 0, missedActivities: 0, lateSubmissions: 0, deductions: 0, payments: [], notes: [], attendanceRecords: [], deductionRecords: [] },
            martos: { name: "Martos, Markjoshua", password: "Kalapato123", tardiness: 0, absences: 0, missedActivities: 0, lateSubmissions: 0, deductions: 0, payments: [], notes: [], attendanceRecords: [], deductionRecords: [] }
        };

        let sessions = [
            {
                id: 1,
                category: 'Meeting ONLY',
                name: 'Project Planning Meeting',
                startTime: '2024-01-15T10:00',
                endTime: '2024-01-15T12:00',
                attendees: ['patalinghug', 'abon', 'caritativo'],
                completed: true,
                completionDate: '2024-01-15T12:15:00',
                reason: 'Meeting completed successfully',
                issues: [],
                createdDate: 'January 15, 2024'
            },
            {
                id: 2,
                category: 'Activity / Task',
                name: 'Chapter 1 Research',
                startTime: '2024-01-20T09:00',
                endTime: '2024-01-22T17:00',
                attendees: ['patalinghug', 'abon', 'caritativo', 'delossantos', 'martos'],
                completed: false,
                issues: [],
                createdDate: 'January 20, 2024'
            }
        ]; // Combined events and meetings
        let contributions = [];
        let currentSession = null;
        let currentMember = null;
        let editMode = false;
        let recentlyDeleted = []; // Store recently deleted attendance records
        let pendingPaymentRequests = [];
        let pendingSessionRequests = [];
        let pendingExpenseRequests = []; // Store pending payment approval requests
        let gradingCriteria = {
            tardinessPenalty: -1,
            absencePenalty: -2,
            missedActivityPenalty: -3,
            lateSubmissionPenalty: -1,
            baseGrade: 100
        };
        let expenses = [];
        
        // Function to show attendance details
        function showAttendanceDetails(type) {
            if (!currentMember) {
                alert('Please select a member first');
                return;
            }
            
            const member = members[currentMember];
            const memberName = member.name;
            const records = member.attendanceRecords || [];
            
            // Filter records by type for this specific member
            const typeMap = {
                'tardiness': 'tardy',
                'absences': 'absent', 
                'missedActivities': 'missed_activity',
                'lateSubmissions': 'late_submission'
            };
            
            const filteredRecords = records.filter(record => record.type === typeMap[type]);
            
            document.getElementById('attendance-details-member').textContent = memberName;
            const contentDiv = document.getElementById('attendance-details-content');
            
            const typeDisplayNames = {
                'tardiness': 'tardiness incidents',
                'absences': 'absences',
                'missedActivities': 'missed activities',
                'lateSubmissions': 'late submissions'
            };
            
            if (filteredRecords.length === 0) {
                contentDiv.innerHTML = `<div class="event-item"><div class="event-title">No ${typeDisplayNames[type]} recorded for ${memberName.split(',')[0]}.</div></div>`;
            } else {
                contentDiv.innerHTML = `<h4>${memberName.split(',')[0]} - ${filteredRecords.length} ${typeDisplayNames[type]} recorded:</h4>`;
                
                filteredRecords.forEach((record, index) => {
                    const recordItem = document.createElement('div');
                    recordItem.className = 'event-item';
                    recordItem.style.marginBottom = '10px';
                    
                    const typeLabels = {
                        'tardy': 'Tardiness',
                        'absent': 'Absence',
                        'missed_activity': 'Missed Activity', 
                        'late_submission': 'Late Submission'
                    };
                    
                    recordItem.innerHTML = `
                        <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${typeLabels[record.type]} Incident #${index + 1}</span>
                            <button class="btn btn-danger admin-only" onclick="deleteAttendanceRecord('${currentMember}', '${record.type}', ${index})" style="padding: 4px 8px; font-size: 12px;">√ó Delete</button>
                        </div>
                        <div class="event-details">
                            <strong>Date:</strong> ${record.date}<br>
                            <strong>Activity:</strong> ${record.sessionName || record.eventName || record.meetingType || 'Manual Entry'}<br>
                            <div class="member-specific-reason">
                                <strong>Specific reason for ${memberName.split(',')[0]}:</strong><br>
                                ${record.reason || 'No specific reason recorded'}
                            </div>
                        </div>
                    `;
                    
                    contentDiv.appendChild(recordItem);
                });
            }
            
            document.getElementById('attendance-details-modal').style.display = 'flex';
        }
        
        // Function to close attendance details modal
        function closeAttendanceDetailsModal() {
            document.getElementById('attendance-details-modal').style.display = 'none';
        }
        
        // Function to open session modal
        function openSessionModal() {
            if (!checkAccess('add')) return;
            document.getElementById('session-modal').style.display = 'flex';
        }
        
        // Function to close session modal
        function closeSessionModal() {
            document.getElementById('session-modal').style.display = 'none';
        }
        
        // Function to save session
        function saveSession() {
            const category = document.getElementById('session-category').value;
            const name = document.getElementById('session-name').value;
            const startTime = document.getElementById('session-start').value;
            const endTime = document.getElementById('session-end').value;
            
            if (!name || !startTime || !endTime) {
                alert('Please fill in all required fields');
                return;
            }
            
            if (new Date(startTime) >= new Date(endTime)) {
                alert('End time must be after start time');
                return;
            }

            const attendees = [];
            // Dynamically check all member checkboxes
            Object.keys(members).forEach(memberId => {
                const checkbox = document.getElementById(`session-${memberId}`);
                if (checkbox && checkbox.checked) {
                    attendees.push(memberId);
                }
            });

            if (attendees.length === 0) {
                alert('Please select at least one attendee');
                return;
            }

            const session = {
                id: Date.now(),
                category,
                name,
                startTime,
                endTime,
                attendees,
                completed: false,
                issues: [],
                createdDate: new Date().toLocaleString()
            };

            sessions.push(session);
            renderSessions();
            closeSessionModal();

            // Clear form
            document.getElementById('session-name').value = '';
            document.getElementById('session-start').value = '';
            document.getElementById('session-end').value = '';
            document.querySelectorAll('#session-modal input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // Function to render sessions (recent 4 only)
        function renderSessions() {
            const sessionsList = document.getElementById('sessions-list');
            sessionsList.innerHTML = '';
            
            if (sessions.length === 0) {
                sessionsList.innerHTML = '<p>No sessions recorded yet.</p>';
                return;
            }
            
            // Sort sessions: pending first, then by creation date (newest first)
            const sortedSessions = [...sessions].sort((a, b) => {
                const aIsPending = !a.completed && !a.cancelled;
                const bIsPending = !b.completed && !b.cancelled;
                
                // If one is pending and the other is not, prioritize pending
                if (aIsPending && !bIsPending) return -1;
                if (!aIsPending && bIsPending) return 1;
                
                // If both have same status, sort by creation date (newest first)
                return new Date(b.createdDate) - new Date(a.createdDate);
            });
            
            // Take only the first 4 sessions
            const recentSessions = sortedSessions.slice(0, 4);
            
            recentSessions.forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'event-item';
                
                let attendees = '';
                session.attendees.forEach(a => {
                    attendees += members[a].name.split(',')[0] + ', ';
                });
                attendees = attendees.slice(0, -2);
                
                let status = session.completed ? 
                    `<span style="color: green;">Completed</span>` : 
                    session.cancelled ? 
                    `<span style="color: red;">Cancelled</span>` :
                    `<span style="color: orange;">Pending</span>`;
                
                let issues = '';
                let completionButton = '';
                
                if (session.completed) {
                    if (session.issues.length > 0) {
                        issues = `<div style="color: red; margin-top: 5px;">Issues recorded: ${session.reason}</div>`;
                    } else {
                        issues = `<div style="color: green; margin-top: 5px;">No issues recorded - ${session.reason}</div>`;
                    }
                    if (session.completionDate) {
                        issues += `<div style="color: #666; font-size: 12px; margin-top: 3px;">Completed on: ${session.completionDate}</div>`;
                    }
                } else if (session.cancelled) {
                    issues = `<div style="color: red; margin-top: 5px;">Cancelled: ${session.cancellationReason}</div>`;
                    if (session.cancellationDate) {
                        issues += `<div style="color: #666; font-size: 12px; margin-top: 3px;">Cancelled on: ${session.cancellationDate}</div>`;
                    }
                } else {
                    completionButton = `<button class="btn btn-success" onclick="completeSession(${session.id})" style="margin-top: 10px; font-size: 12px;">Complete Session</button>`;
                    completionButton += ` <button class="btn btn-primary" onclick="manualCompleteSession(${session.id})" style="margin-top: 10px; font-size: 12px; margin-left: 5px;">Manual Complete</button>`;
                    completionButton += ` <button class="btn btn-warning" onclick="rescheduleSession(${session.id})" style="margin-top: 10px; font-size: 12px; margin-left: 5px;">Reschedule</button>`;
                    completionButton += ` <button class="btn btn-danger" onclick="cancelSession(${session.id})" style="margin-top: 10px; font-size: 12px; margin-left: 5px;">Cancel</button>`;
                    
                    // Show reschedule history if exists
                    if (session.rescheduleHistory && session.rescheduleHistory.length > 0) {
                        issues += `<div style="color: #007bff; margin-top: 5px; font-size: 12px;">Rescheduled ${session.rescheduleHistory.length} time(s)</div>`;
                    }
                }
                
                sessionItem.innerHTML = `
                    <div class="event-title">${session.category} - ${session.name} ${status}</div>
                    <div class="event-details">
                        Start: ${new Date(session.startTime).toLocaleString()}<br>
                        End: ${new Date(session.endTime).toLocaleString()}<br>
                        Attendees: ${attendees}
                        ${issues}
                        ${completionButton}
                    </div>
                `;
                
                sessionsList.appendChild(sessionItem);
            });
        }
        
        // Function to complete session (automatic based on end time)
        function completeSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session || session.completed) return;
            
            // Check if user is a member - create approval request
            if (userRole === 'member') {
                createSessionApprovalRequest('complete', sessionId, 'Request to complete session automatically');
                return;
            }
            
            const now = new Date();
            const endTime = new Date(session.endTime);
            
            if (now < endTime) {
                alert('Cannot complete session before end time. Use Manual Complete instead.');
                return;
            }
            
            openCompleteSessionModal(session);
        }
        
        // Function to manually complete session
        function manualCompleteSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session || session.completed) return;
            
            // Check if user is a member - create approval request
            if (userRole === 'member') {
                createSessionApprovalRequest('manual_complete', sessionId, 'Request to manually complete session');
                return;
            }
            
            openCompleteSessionModal(session);
        }
        
        // Function to open session completion modal
        function openCompleteSessionModal(session) {
            currentSession = session;
            document.getElementById('complete-session-title').textContent = `${session.category} - ${session.name}`;
            
            // Clear previous entries
            document.getElementById('session-members-checklist').innerHTML = '';
            document.getElementById('session-completion-reason').value = '';
            document.getElementById('deduction-entries').innerHTML = '';
            
            // Generate attendance questions based on category
            generateAttendanceQuestions(session);
            
            document.getElementById('complete-session-modal').style.display = 'flex';
        }
        
        // Function to close session completion modal
        function closeCompleteSessionModal() {
            document.getElementById('complete-session-modal').style.display = 'none';
            currentSession = null;
        }
        
        // Function to generate attendance questions based on session category
        function generateAttendanceQuestions(session) {
            const checklistDiv = document.getElementById('session-members-checklist');
            const category = session.category;
            
            // Add "No Issues" option at the top
            const noIssuesDiv = document.createElement('div');
            noIssuesDiv.style.marginBottom = '20px';
            noIssuesDiv.style.padding = '15px';
            noIssuesDiv.style.border = '2px solid #28a745';
            noIssuesDiv.style.borderRadius = '6px';
            noIssuesDiv.style.backgroundColor = '#d4edda';
            
            noIssuesDiv.innerHTML = `
                <label style="display: flex; align-items: center; gap: 10px; font-weight: bold; color: #155724;">
                    <input type="checkbox" id="no-issues-checkbox" onchange="toggleNoIssues()" style="transform: scale(1.2);">
                    ‚úì No Issues - Everyone attended/completed successfully
                </label>
                <small style="color: #155724; font-style: italic; margin-left: 30px;">Check this if there were no attendance or completion issues</small>
            `;
            
            checklistDiv.appendChild(noIssuesDiv);
            
            // Create container for individual member issues
            const memberIssuesDiv = document.createElement('div');
            memberIssuesDiv.id = 'member-issues-container';
            
            // Define question sets based on category
            let questions = [];
            if (category === 'Meeting ONLY' || category === 'Defense' || category === 'Consultation') {
                questions = [
                    { type: 'tardy', label: 'Attended late', statKey: 'tardiness' },
                    { type: 'absent', label: 'Did not attend', statKey: 'absences' }
                ];
            } else if (category === 'Activity / Task' || category === 'Meeting /w PAPERWORKS') {
                questions = [
                    { type: 'missed_activity', label: 'Did not complete the task', statKey: 'missedActivities' },
                    { type: 'late_submission', label: 'Submitted the task late', statKey: 'lateSubmissions' }
                ];
            }
            
            // Add "Other issues" option for all categories
            questions.push({ type: 'other', label: 'Other issues (specify)', statKey: null });
            
            session.attendees.forEach(attendeeId => {
                const member = members[attendeeId];
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-issue-section';
                memberDiv.style.marginBottom = '20px';
                memberDiv.style.padding = '15px';
                memberDiv.style.border = '1px solid #ddd';
                memberDiv.style.borderRadius = '6px';
                memberDiv.style.backgroundColor = '#f9f9f9';
                
                let memberHTML = `<h5>${member.name.split(',')[0]}</h5>`;
                
                questions.forEach(question => {
                    const checkboxId = `session-${question.type}-${attendeeId}`;
                    memberHTML += `
                        <div class="checkbox-item" style="margin-bottom: 10px;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="${checkboxId}" class="issue-checkbox" onchange="toggleReasonInput('${checkboxId}', '${attendeeId}', '${question.type}')">
                                ${question.label}
                            </label>
                            <div id="reason-${checkboxId}" class="reason-input" style="display: none; margin-top: 10px;">
                                <textarea class="form-control" placeholder="Specify reason for ${member.name.split(',')[0]}" rows="2"></textarea>
                            </div>
                        </div>
                    `;
                });
                
                memberDiv.innerHTML = memberHTML;
                memberIssuesDiv.appendChild(memberDiv);
            });
            
            checklistDiv.appendChild(memberIssuesDiv);
        }
        
        // Function to toggle "No Issues" mode
        function toggleNoIssues() {
            const noIssuesCheckbox = document.getElementById('no-issues-checkbox');
            const memberIssuesContainer = document.getElementById('member-issues-container');
            const allIssueCheckboxes = document.querySelectorAll('.issue-checkbox');
            const allReasonInputs = document.querySelectorAll('.reason-input');
            
            if (noIssuesCheckbox.checked) {
                // Disable and hide member issues section
                memberIssuesContainer.style.opacity = '0.5';
                memberIssuesContainer.style.pointerEvents = 'none';
                
                // Uncheck all issue checkboxes and hide reason inputs
                allIssueCheckboxes.forEach(checkbox => {
                    checkbox.checked = false;
                    checkbox.disabled = true;
                });
                
                allReasonInputs.forEach(input => {
                    input.style.display = 'none';
                    input.querySelector('textarea').value = '';
                });
            } else {
                // Re-enable member issues section
                memberIssuesContainer.style.opacity = '1';
                memberIssuesContainer.style.pointerEvents = 'auto';
                
                // Re-enable all issue checkboxes
                allIssueCheckboxes.forEach(checkbox => {
                    checkbox.disabled = false;
                });
            }
        }
        
        // Function to toggle reason input visibility
        function toggleReasonInput(checkboxId, attendeeId, type) {
            const checkbox = document.getElementById(checkboxId);
            const reasonDiv = document.getElementById(`reason-${checkboxId}`);
            const noIssuesCheckbox = document.getElementById('no-issues-checkbox');
            
            // If any issue is checked, uncheck "No Issues"
            if (checkbox.checked && noIssuesCheckbox) {
                noIssuesCheckbox.checked = false;
                toggleNoIssues(); // Re-enable the interface
            }
            
            if (checkbox.checked) {
                reasonDiv.style.display = 'block';
            } else {
                reasonDiv.style.display = 'none';
                reasonDiv.querySelector('textarea').value = '';
            }
        }
        
        // Helper function to safely get member ID from active button
        function getActiveMemberId() {
            const activeMember = document.querySelector('.member-btn.active');
            if (!activeMember) return null;
            
            // Try to get member ID from onclick attribute or from button's data
            let memberId = null;
            if (activeMember.onclick && typeof activeMember.onclick === 'function') {
                // For dynamically created buttons with arrow functions
                const onclickStr = activeMember.onclick.toString();
                const match = onclickStr.match(/showMember\(['"]([^'"]+)['"]\)/);
                if (match) {
                    memberId = match[1];
                }
            } else if (activeMember.getAttribute('onclick')) {
                // For static HTML buttons with string onclick
                const onclickAttr = activeMember.getAttribute('onclick');
                const match = onclickAttr.match(/showMember\(['"]([^'"]+)['"]\)/);
                if (match) {
                    memberId = match[1];
                }
            }
            
            return memberId;
        }
        
        // Function to add deduction entry
        function addDeductionEntry() {
            const deductionEntries = document.getElementById('deduction-entries');
            const entryDiv = document.createElement('div');
            entryDiv.style.marginBottom = '15px';
            entryDiv.style.padding = '10px';
            entryDiv.style.border = '1px solid #ccc';
            entryDiv.style.borderRadius = '4px';
            entryDiv.style.backgroundColor = '#fff';
            
            entryDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 100px 1fr auto; gap: 10px; align-items: start;">
                    <select class="form-control deduction-member" style="width: 100%;">
                        <option value="">Select Member</option>
                        ${Object.keys(members).map(memberId => 
                            `<option value="${memberId}">${members[memberId].name.split(',')[0]}</option>`
                        ).join('')}
                    </select>
                    <input type="number" class="form-control deduction-amount" placeholder="Amount" step="0.5" min="0" style="width: 100%;">
                    <textarea class="form-control deduction-reason" placeholder="Reason for deduction" rows="2" style="width: 100%;"></textarea>
                    <button type="button" class="btn btn-danger" onclick="removeDeductionEntry(this)" style="padding: 8px;">√ó</button>
                </div>
            `;
            
            deductionEntries.appendChild(entryDiv);
        }
        
        // Function to remove deduction entry
        function removeDeductionEntry(button) {
            button.parentElement.parentElement.remove();
        }
        
        // Function to submit session completion
        function submitSessionCompletion() {
            const session = currentSession;
            if (!session) return;
            
            const generalReason = document.getElementById('session-completion-reason').value.trim();
            if (!generalReason) {
                alert('Please provide a general completion reason');
                return;
            }
            
            const noIssuesCheckbox = document.getElementById('no-issues-checkbox');
            const issues = [];
            const attendanceUpdates = {};
            
            // Check if "No Issues" is selected
            if (noIssuesCheckbox && noIssuesCheckbox.checked) {
                // No issues mode - skip all issue processing
                session.completed = true;
                session.completionDate = new Date().toLocaleString();
                session.reason = generalReason;
                session.issues = [];
                
                // Still process manual deductions if any
                const deductionEntries = document.querySelectorAll('#deduction-entries > div');
                deductionEntries.forEach(entry => {
                    const memberSelect = entry.querySelector('.deduction-member');
                    const amountInput = entry.querySelector('.deduction-amount');
                    const reasonTextarea = entry.querySelector('.deduction-reason');
                    
                    const memberId = memberSelect.value;
                    const amount = parseFloat(amountInput.value) || 0;
                    const reason = reasonTextarea.value.trim();
                    
                    if (memberId && amount > 0 && reason) {
                        members[memberId].deductions += amount;
                        
                        if (!members[memberId].deductionRecords) {
                            members[memberId].deductionRecords = [];
                        }
                        
                        members[memberId].deductionRecords.push({
                            amount: amount,
                            reason: reason,
                            date: new Date().toLocaleString(),
                            sessionName: session.name,
                            sessionCategory: session.category
                        });
                    }
                });
                
                // Update display and close modal
                const activeMember = document.querySelector('.member-btn.active');
                if (activeMember) {
                    const memberId = getActiveMemberId();
                    if (memberId) {
                        showMember(memberId);
                    }
                }
                
                renderSessions();
                closeCompleteSessionModal();
                
                alert(`Session "${session.name}" has been completed with no issues recorded!`);
                return;
            }
            
            // Process attendance issues (original logic)
            session.attendees.forEach(attendeeId => {
                const member = members[attendeeId];
                
                // Define question types based on category
                let questionTypes = [];
                if (session.category === 'Meeting ONLY' || session.category === 'Defense' || session.category === 'Consultation') {
                    questionTypes = ['tardy', 'absent'];
                } else if (session.category === 'Activity / Task' || session.category === 'Meeting /w PAPERWORKS') {
                    questionTypes = ['missed_activity', 'late_submission'];
                }
                questionTypes.push('other');
                
                questionTypes.forEach(type => {
                    const checkboxId = `session-${type}-${attendeeId}`;
                    const checkbox = document.getElementById(checkboxId);
                    
                    if (checkbox && checkbox.checked) {
                        const reasonTextarea = document.querySelector(`#reason-${checkboxId} textarea`);
                        const reason = reasonTextarea ? reasonTextarea.value.trim() : '';
                        
                        if (!reason && type !== 'other') {
                            alert(`Please provide a reason for ${member.name.split(',')[0]} - ${type}`);
                            return;
                        }
                        
                        if (type === 'other' && !reason) {
                            alert(`Please specify the other issue for ${member.name.split(',')[0]}`);
                            return;
                        }
                        
                        // Record the issue
                        issues.push({
                            memberId: attendeeId,
                            type: type,
                            reason: reason
                        });
                        
                        // Update member stats
                        if (type === 'tardy') {
                            members[attendeeId].tardiness++;
                        } else if (type === 'absent') {
                            members[attendeeId].absences++;
                        } else if (type === 'missed_activity') {
                            members[attendeeId].missedActivities++;
                        } else if (type === 'late_submission') {
                            members[attendeeId].lateSubmissions++;
                        }
                        
                        // Record attendance history
                        if (!members[attendeeId].attendanceRecords) {
                            members[attendeeId].attendanceRecords = [];
                        }
                        
                        members[attendeeId].attendanceRecords.push({
                            type: type,
                            date: new Date().toLocaleString(),
                            sessionName: session.name,
                            sessionCategory: session.category,
                            reason: reason
                        });
                    }
                });
            });
            
            // Process manual deductions
            const deductionEntries = document.querySelectorAll('#deduction-entries > div');
            deductionEntries.forEach(entry => {
                const memberSelect = entry.querySelector('.deduction-member');
                const amountInput = entry.querySelector('.deduction-amount');
                const reasonTextarea = entry.querySelector('.deduction-reason');
                
                const memberId = memberSelect.value;
                const amount = parseFloat(amountInput.value) || 0;
                const reason = reasonTextarea.value.trim();
                
                if (memberId && amount > 0 && reason) {
                    members[memberId].deductions += amount;
                    
                    // Record deduction history
                    if (!members[memberId].deductionRecords) {
                        members[memberId].deductionRecords = [];
                    }
                    
                    members[memberId].deductionRecords.push({
                        amount: amount,
                        reason: reason,
                        date: new Date().toLocaleString(),
                        sessionName: session.name,
                        sessionCategory: session.category
                    });
                }
            });
            
            // Update session
            session.completed = true;
            session.completionDate = new Date().toLocaleString();
            session.reason = generalReason;
            session.issues = issues;
            
            // Update display if viewing an affected member
            const activeMember = document.querySelector('.member-btn.active');
            if (activeMember) {
                const memberId = getActiveMemberId();
                if (memberId) {
                    showMember(memberId);
                }
            }
            
            renderSessions();
            closeCompleteSessionModal();
            
            let issuesSummary = issues.length > 0 ? 
                `\n\nIssues recorded: ${issues.length} total` : 
                '\n\nNo issues recorded';
            
            alert(`Session "${session.name}" has been completed!${issuesSummary}`);
        }
        
        // Function to filter sessions
        function filterSessions() {
            const categoryFilter = document.getElementById('sessions-filter-category').value;
            const statusFilter = document.getElementById('sessions-filter-status').value;
            const memberFilter = document.getElementById('sessions-filter-member').value;
            const dateFilter = document.getElementById('sessions-filter-date').value;
            
            let filteredSessions = sessions.filter(session => {
                if (categoryFilter !== 'all' && session.category !== categoryFilter) return false;
                
                if (statusFilter !== 'all') {
                    if (statusFilter === 'completed' && !session.completed) return false;
                    if (statusFilter === 'pending' && (session.completed || session.cancelled)) return false;
                    if (statusFilter === 'cancelled' && !session.cancelled) return false;
                }
                
                if (memberFilter !== 'all') {
                    if (!session.attendees.includes(memberFilter)) return false;
                }
                
                if (dateFilter) {
                    const sessionDate = new Date(session.startTime).toISOString().split('T')[0];
                    if (sessionDate !== dateFilter) return false;
                }
                
                return true;
            });
            
            renderFilteredSessions(filteredSessions);
        }
        
        // Function to render filtered sessions
        function renderFilteredSessions(filteredSessions) {
            const sessionsList = document.getElementById('sessions-list');
            sessionsList.innerHTML = '';
            
            if (filteredSessions.length === 0) {
                sessionsList.innerHTML = '<p>No sessions match the selected filters.</p>';
                return;
            }
            
            filteredSessions.forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'event-item';
                
                let attendees = '';
                session.attendees.forEach(a => {
                    attendees += members[a].name.split(',')[0] + ', ';
                });
                attendees = attendees.slice(0, -2);
                
                let status = session.completed ? 
                    `<span style="color: green;">Completed</span>` : 
                    session.cancelled ? 
                    `<span style="color: red;">Cancelled</span>` :
                    `<span style="color: orange;">Pending</span>`;
                
                let issues = '';
                let completionButton = '';
                
                if (session.completed) {
                    if (session.issues && session.issues.length > 0) {
                        issues = `<div style="color: red; margin-top: 5px;">Issues recorded: ${session.reason}</div>`;
                    } else {
                        issues = `<div style="color: green; margin-top: 5px;">No issues recorded - ${session.reason}</div>`;
                    }
                    if (session.completionDate) {
                        issues += `<div style="color: #666; font-size: 12px; margin-top: 3px;">Completed on: ${session.completionDate}</div>`;
                    }
                } else if (session.cancelled) {
                    issues = `<div style="color: red; margin-top: 5px;">Cancelled: ${session.cancellationReason}</div>`;
                    if (session.cancellationDate) {
                        issues += `<div style="color: #666; font-size: 12px; margin-top: 3px;">Cancelled on: ${session.cancellationDate}</div>`;
                    }
                } else {
                    completionButton = `<button class="btn btn-success" onclick="completeSession(${session.id})" style="margin-top: 10px; font-size: 12px;">Complete Session</button>`;
                    completionButton += ` <button class="btn btn-primary" onclick="manualCompleteSession(${session.id})" style="margin-top: 10px; font-size: 12px; margin-left: 5px;">Manual Complete</button>`;
                    completionButton += ` <button class="btn btn-warning" onclick="rescheduleSession(${session.id})" style="margin-top: 10px; font-size: 12px; margin-left: 5px;">Reschedule</button>`;
                    completionButton += ` <button class="btn btn-danger" onclick="cancelSession(${session.id})" style="margin-top: 10px; font-size: 12px; margin-left: 5px;">Cancel</button>`;
                    
                    // Show reschedule history if exists
                    if (session.rescheduleHistory && session.rescheduleHistory.length > 0) {
                        issues += `<div style="color: #007bff; margin-top: 5px; font-size: 12px;">Rescheduled ${session.rescheduleHistory.length} time(s)</div>`;
                    }
                }
                
                sessionItem.innerHTML = `
                    <div class="event-title">${session.category} - ${session.name} ${status}</div>
                    <div class="event-details">
                        Start: ${new Date(session.startTime).toLocaleString()}<br>
                        End: ${new Date(session.endTime).toLocaleString()}<br>
                        Attendees: ${attendees}
                        ${issues}
                        ${completionButton}
                    </div>
                `;
                
                sessionsList.appendChild(sessionItem);
            });
        }
        
        // Function to clear session filters
        function clearSessionFilters() {
            document.getElementById('sessions-filter-category').value = 'all';
            document.getElementById('sessions-filter-status').value = 'all';
            document.getElementById('sessions-filter-member').value = 'all';
            document.getElementById('sessions-filter-date').value = '';
            renderSessions(); // Show all sessions
        }
        
        // Quick login function for debugging/testing
        function quickLogin() {
            console.log('Quick admin login triggered');
            
            // Set current user as admin
            currentUser = 'admin';
            userRole = 'admin';
            
            // Show main interface
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            
            // Update UI for admin view
            initializeAdminView();
            
            alert('Quick admin login successful! You can now access all features including All Sessions.');
        }
        
        // Function to clear all sessions (Admin only)
        function clearAllSessions() {
            // Check admin access
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can clear all sessions.');
                return;
            }
            
            if (sessions.length === 0) {
                alert('No sessions to clear.');
                return;
            }
            
            const sessionCount = sessions.length;
            const confirmMessage = `Are you sure you want to delete ALL ${sessionCount} sessions?

This will permanently remove:
- All session records
- All attendance data
- All completion history

This action CANNOT be undone!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Double confirmation for safety
            const finalConfirm = prompt(`Type "DELETE ALL SESSIONS" to confirm deletion of ${sessionCount} sessions:`);
            if (finalConfirm !== 'DELETE ALL SESSIONS') {
                alert('Deletion cancelled. Sessions were not deleted.');
                return;
            }
            
            // Clear all session-related issues from member records
            sessions.forEach(session => {
                if (session.issues && session.issues.length > 0) {
                    session.issues.forEach(issue => {
                        const member = members[issue.memberId];
                        if (member) {
                            // Decrease member stats
                            if (issue.type === 'tardy') {
                                member.tardiness = Math.max(0, member.tardiness - 1);
                            } else if (issue.type === 'absent') {
                                member.absences = Math.max(0, member.absences - 1);
                            } else if (issue.type === 'missed_activity') {
                                member.missedActivities = Math.max(0, member.missedActivities - 1);
                            } else if (issue.type === 'late_submission') {
                                member.lateSubmissions = Math.max(0, member.lateSubmissions - 1);
                            }
                            
                            // Remove session-related attendance records
                            if (member.attendanceRecords) {
                                member.attendanceRecords = member.attendanceRecords.filter(record => {
                                    // Remove records that match this session
                                    return record.sessionName !== session.name;
                                });
                            }
                            
                            // Recalculate deductions
                            const autoDeductions = member.tardiness * 0.5 + 
                                                  member.absences * 1 + 
                                                  member.missedActivities * 1.5 + 
                                                  member.lateSubmissions * 0.5;
                            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
                            member.deductions = autoDeductions + manualDeductions;
                        }
                    });
                }
            });
            
            // Clear the sessions array
            sessions = [];
            
            // Update all related displays
            renderSessions();

            updateSystemStats();
            
            // Save changes immediately
            saveToLocalStorage();
            
            alert(`Successfully deleted ${sessionCount} sessions and cleaned up all associated member attendance issues. All session data has been cleared.`);
        }
        
        // Function to clear all contributions (Admin only)
        function clearAllContributions() {
            // Check admin access
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can clear all contributions.');
                return;
            }
            
            if (contributions.length === 0) {
                alert('No contributions to clear.');
                return;
            }
            
            const contributionCount = contributions.length;
            const confirmMessage = `Are you sure you want to delete ALL ${contributionCount} contributions?

This will permanently remove all money contribution records.

This action CANNOT be undone!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Clear contributions and reset member payment records
            contributions = [];
            
            // Reset payment records for all members
            Object.values(members).forEach(member => {
                if (member.payments) {
                    member.payments = [];
                }
            });
            
            // Update displays
            renderContributions();
            updateSystemStats();
            
            // Save changes immediately
            saveToLocalStorage();
            
            alert(`Successfully deleted ${contributionCount} contributions. All contribution data has been cleared.`);
        }
        
        // Function to reset all member statistics (Admin only)
        function resetAllMemberStats() {
            // Check admin access
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can reset member statistics.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to reset ALL member statistics?

This will reset to zero:
- Tardiness counts
- Absence counts
- Missed activities
- Late submissions
- Deductions

This action CANNOT be undone!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Reset all member statistics
            Object.values(members).forEach(member => {
                member.tardiness = 0;
                member.absences = 0;
                member.missedActivities = 0;
                member.lateSubmissions = 0;
                member.deductions = 0;
                
                // Clear attendance and deduction records
                member.attendanceRecords = [];
                member.deductionRecords = [];
            });
            
            // Update current member display if viewing a member
            if (currentMember) {
                showMember(currentMember);
            }
            
            // Save changes immediately
            saveToLocalStorage();
            
            alert('Successfully reset all member statistics. All counts have been set to zero.');
        }
        

        

        

        

        
        // Function to open manage members modal
        function openManageMembersModal() {
            if (!checkAccess('manage')) return;
            document.getElementById('manage-members-modal').style.display = 'flex';
            updateCurrentMembersList();
        }
        
        // Function to close manage members modal
        function closeManageMembersModal() {
            document.getElementById('manage-members-modal').style.display = 'none';
            // Clear form
            document.getElementById('new-member-lastname').value = '';
            document.getElementById('new-member-firstname').value = '';
            document.getElementById('new-member-leader').checked = false;
        }
        
        // Function to generate member ID from name
        function generateMemberId(lastName, firstName) {
            // Create a simple ID from lastname (lowercase, no spaces)
            return lastName.toLowerCase().replace(/[^a-z]/g, '');
        }
        
        // Function to add new member
        function addNewMember() {
            const lastName = document.getElementById('new-member-lastname').value.trim();
            const firstName = document.getElementById('new-member-firstname').value.trim();
            const isLeader = document.getElementById('new-member-leader').checked;
            
            if (!lastName || !firstName) {
                alert('Please fill in both first name and last name.');
                return;
            }
            
            // Generate member ID
            const memberId = generateMemberId(lastName, firstName);
            
            // Check if member already exists
            if (members[memberId]) {
                alert('A member with this last name already exists. Please use a different name or modify the existing member.');
                return;
            }
            
            // Create member object
            const fullName = `${lastName}, ${firstName}${isLeader ? ' (Leader)' : ''}`;
            members[memberId] = {
                name: fullName,
                tardiness: 0,
                absences: 0,
                missedActivities: 0,
                lateSubmissions: 0,
                deductions: 0,
                payments: [],
                notes: [],
                attendanceRecords: [],
                deductionRecords: []
            };
            
            // Update UI
            updateMemberButtons();
            updateSessionModalAttendees();
            updateFilterDropdowns();
            updateCurrentMembersList();
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Clear form
            document.getElementById('new-member-lastname').value = '';
            document.getElementById('new-member-firstname').value = '';
            document.getElementById('new-member-leader').checked = false;
            
            alert(`Member "${fullName}" has been added successfully!`);
        }
        
        // Function to remove member
        function removeMember(memberId) {
            const member = members[memberId];
            if (!member) return;
            
            const memberName = member.name;
            
            // Confirmation with detailed warning
            const hasData = member.attendanceRecords.length > 0 || 
                           member.notes.length > 0 || 
                           member.payments.length > 0 || 
                           member.deductionRecords.length > 0 ||
                           member.tardiness > 0 || member.absences > 0 || 
                           member.missedActivities > 0 || member.lateSubmissions > 0;
            
            let warningMessage = `Are you sure you want to remove "${memberName}"?\n`;
            if (hasData) {
                warningMessage += `\nThis member has data that will be permanently deleted:\n`;
                if (member.attendanceRecords.length > 0) warningMessage += `- ${member.attendanceRecords.length} attendance records\n`;
                if (member.notes.length > 0) warningMessage += `- ${member.notes.length} notes\n`;
                if (member.payments.length > 0) warningMessage += `- ${member.payments.length} payment records\n`;
                if (member.deductionRecords.length > 0) warningMessage += `- ${member.deductionRecords.length} manual deductions\n`;
                if (member.tardiness > 0 || member.absences > 0 || member.missedActivities > 0 || member.lateSubmissions > 0) {
                    warningMessage += `- Attendance statistics (${member.tardiness} tardiness, ${member.absences} absences, ${member.missedActivities} missed activities, ${member.lateSubmissions} late submissions)\n`;
                }
                warningMessage += `\nThis action cannot be undone!`;
            }
            
            if (!confirm(warningMessage)) {
                return;
            }
            
            // Remove member from all sessions
            sessions.forEach(session => {
                const index = session.attendees.indexOf(memberId);
                if (index > -1) {
                    session.attendees.splice(index, 1);
                }
            });
            
            // Remove member from contributions (if any payments exist)
            // Note: We keep the contributions but remove the member's payment records
            
            // Delete the member
            delete members[memberId];
            
            // Update UI
            updateMemberButtons();
            updateSessionModalAttendees();
            updateFilterDropdowns();
            updateCurrentMembersList();
            
            // Clear current member view if this member was selected
            if (currentMember === memberId) {
                currentMember = null;
                document.getElementById('member-name').textContent = 'Select a member to view details';
                document.getElementById('member-actions').style.display = 'none';
                document.getElementById('payment-status').style.display = 'none';
                // Reset stats display
                document.getElementById('tardiness').textContent = '0';
                document.getElementById('absences').textContent = '0';
                document.getElementById('missed-activities').textContent = '0';
                document.getElementById('late-submissions').textContent = '0';
                document.getElementById('deductions').textContent = '0';
            }
            
            // Save to localStorage
            saveToLocalStorage();
            
            alert(`Member "${memberName}" has been removed successfully.`);
        }
        
        // Function to update member buttons in sidebar
        function updateMemberButtons() {
            const container = document.getElementById('member-buttons-container');
            container.innerHTML = '';
            
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                const button = document.createElement('button');
                button.className = 'member-btn';
                button.onclick = () => showMember(memberId);
                button.textContent = member.name;
                container.appendChild(button);
            });
        }
        
        // Function to update session modal attendees checkboxes
        function updateSessionModalAttendees() {
            const membersList = document.querySelector('#session-modal .members-list');
            if (!membersList) return;
            
            membersList.innerHTML = '';
            
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                const div = document.createElement('div');
                div.className = 'member-checkbox';
                div.style.cssText = 'display: flex; align-items: center; justify-content: space-between; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 5px;';
                
                div.innerHTML = `
                    <label for="session-${memberId}" style="margin: 0; flex: 1;">${member.name}</label>
                    <input type="checkbox" id="session-${memberId}" value="${memberId}" style="margin: 0;">
                `;
                
                membersList.appendChild(div);
            });
        }
        
        // Function to update filter dropdowns
        function updateFilterDropdowns() {
            // Update sessions filter member dropdown
            const sessionsFilter = document.getElementById('sessions-filter-member');
            const notesFilter = document.getElementById('notes-filter-member');
            
            const memberOptions = Object.keys(members).map(memberId => {
                const member = members[memberId];
                return `<option value="${memberId}">${member.name}</option>`;
            }).join('');
            
            if (sessionsFilter) {
                sessionsFilter.innerHTML = '<option value="all">All Members</option>' + memberOptions;
            }
            if (notesFilter) {
                notesFilter.innerHTML = '<option value="all">All Members</option>' + memberOptions;
            }
        }
        
        // Function to update current members list in manage modal
        function updateCurrentMembersList() {
            const container = document.getElementById('current-members-list');
            container.innerHTML = '';
            
            const memberIds = Object.keys(members);
            if (memberIds.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No members found.</p>';
                return;
            }
            
            memberIds.forEach(memberId => {
                const member = members[memberId];
                const memberItem = document.createElement('div');
                memberItem.className = 'event-item';
                memberItem.style.marginBottom = '10px';
                
                const dataStats = `${member.attendanceRecords.length} records, ${member.notes.length} notes, ${member.payments.length} payments`;
                
                memberItem.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${member.name}</strong>
                            <div style="font-size: 12px; color: #666; font-weight: normal; margin-top: 2px;">${dataStats}</div>
                        </div>
                        <button class="btn btn-danger" onclick="removeMember('${memberId}')" style="font-size: 12px; padding: 6px 12px;">
                            üóëÔ∏è Remove
                        </button>
                    </div>
                    <div class="event-details" style="font-size: 13px; color: #555;">
                        Stats: ${member.tardiness} tardiness, ${member.absences} absences, ${member.missedActivities} missed activities, ${member.lateSubmissions} late submissions
                    </div>
                `;
                
                container.appendChild(memberItem);
            });
        }
        
        // Function to show deduction details
        function showDeductionDetails() {
            if (!currentMember) {
                alert('Please select a member first');
                return;
            }
            
            const member = members[currentMember];
            const memberName = member.name;
            const deductionRecords = member.deductionRecords || [];
            const attendanceRecords = member.attendanceRecords || [];
            
            document.getElementById('deduction-details-member').textContent = memberName;
            const contentDiv = document.getElementById('deduction-details-content');
            
            // Calculate automatic deductions
            const autoDeductions = {
                tardiness: { count: member.tardiness, rate: 0.5, total: member.tardiness * 0.5 },
                absences: { count: member.absences, rate: 1.0, total: member.absences * 1.0 },
                missedActivities: { count: member.missedActivities, rate: 1.5, total: member.missedActivities * 1.5 },
                lateSubmissions: { count: member.lateSubmissions, rate: 0.5, total: member.lateSubmissions * 0.5 }
            };
            
            const totalAutoDeductions = Object.values(autoDeductions).reduce((sum, item) => sum + item.total, 0);
            const totalManualDeductions = deductionRecords.reduce((total, record) => total + record.amount, 0);
            const grandTotal = totalAutoDeductions + totalManualDeductions;
            
            contentDiv.innerHTML = `<h4>${memberName.split(',')[0]} - Complete Deduction Breakdown:</h4>`;
            
            // Summary Section
            const summaryDiv = document.createElement('div');
            summaryDiv.style.marginBottom = '20px';
            summaryDiv.style.padding = '15px';
            summaryDiv.style.backgroundColor = '#f8f9fa';
            summaryDiv.style.borderRadius = '6px';
            summaryDiv.style.borderLeft = '4px solid #dc3545';
            
            summaryDiv.innerHTML = `
                <h5>üìä Deduction Summary:</h5>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 10px 0;">
                    <div style="text-align: center; padding: 10px; background: #fff3cd; border-radius: 4px;">
                        <strong>Automatic Deductions</strong><br>
                        <span style="font-size: 18px; color: #856404;">${totalAutoDeductions.toFixed(1)} pts</span>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #f8d7da; border-radius: 4px;">
                        <strong>Manual Deductions</strong><br>
                        <span style="font-size: 18px; color: #721c24;">${totalManualDeductions.toFixed(1)} pts</span>
                    </div>
                    <div style="text-align: center; padding: 10px; background: #d1ecf1; border-radius: 4px;">
                        <strong>Total Deductions</strong><br>
                        <span style="font-size: 20px; font-weight: bold; color: #0c5460;">${grandTotal.toFixed(1)} pts</span>
                    </div>
                </div>
            `;
            
            contentDiv.appendChild(summaryDiv);
            
            // Automatic Deductions Section
            if (totalAutoDeductions > 0) {
                const autoSection = document.createElement('div');
                autoSection.style.marginBottom = '20px';
                autoSection.innerHTML = `<h5>‚ö° Automatic Deductions (${totalAutoDeductions.toFixed(1)} points):</h5>`;
                
                Object.entries(autoDeductions).forEach(([type, data]) => {
                    if (data.count > 0) {
                        const autoItem = document.createElement('div');
                        autoItem.className = 'event-item';
                        autoItem.style.marginBottom = '10px';
                        autoItem.style.borderLeft = '4px solid #ffc107';
                        
                        const typeNames = {
                            tardiness: 'Tardiness',
                            absences: 'Absences',
                            missedActivities: 'Missed Activities',
                            lateSubmissions: 'Late Submissions'
                        };
                        
                        autoItem.innerHTML = `
                            <div class="event-title">${typeNames[type]} - ${data.total.toFixed(1)} points</div>
                            <div class="event-details">
                                <strong>Count:</strong> ${data.count} incidents<br>
                                <strong>Rate:</strong> ${data.rate} points per incident<br>
                                <strong>Calculation:</strong> ${data.count} √ó ${data.rate} = ${data.total.toFixed(1)} points<br>
                                <div style="margin-top: 8px; font-size: 12px; color: #666;">
                                    <strong>Related Sessions:</strong> 
                                    <span onclick="showRelatedSessions('${type}')" style="color: #007bff; cursor: pointer; text-decoration: underline;">View ${data.count} incident(s)</span>
                                </div>
                            </div>
                        `;
                        
                        autoSection.appendChild(autoItem);
                    }
                });
                
                contentDiv.appendChild(autoSection);
            }
            
            // Manual Deductions Section
            if (deductionRecords.length > 0) {
                const manualSection = document.createElement('div');
                manualSection.style.marginBottom = '20px';
                manualSection.innerHTML = `<h5>üë§ Manual Deductions (${totalManualDeductions.toFixed(1)} points):</h5>`;
                
                deductionRecords.forEach((record, index) => {
                    const recordItem = document.createElement('div');
                    recordItem.className = 'event-item';
                    recordItem.style.marginBottom = '10px';
                    recordItem.style.borderLeft = '4px solid #dc3545';
                    
                    recordItem.innerHTML = `
                        <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>Manual Deduction #${index + 1} - ${record.amount} points</span>
                            <button class="btn btn-danger admin-only" onclick="deleteManualDeduction('${currentMember}', ${index})" style="padding: 4px 8px; font-size: 12px;">√ó Delete</button>
                        </div>
                        <div class="event-details">
                            <strong>Date:</strong> ${record.date}<br>
                            <strong>Session:</strong> ${record.sessionName || 'Manual Entry'} (${record.sessionCategory || 'N/A'})<br>
                            <div class="member-specific-reason">
                                <strong>Reason:</strong><br>
                                ${record.reason}
                            </div>
                        </div>
                    `;
                    
                    manualSection.appendChild(recordItem);
                });
                
                contentDiv.appendChild(manualSection);
            } else if (totalAutoDeductions === 0) {
                contentDiv.innerHTML += `<div class="event-item"><div class="event-title">No deductions recorded for ${memberName.split(',')[0]}.</div></div>`;
            }
            
            // Show impact on grade
            if (grandTotal > 0) {
                const impactDiv = document.createElement('div');
                impactDiv.style.marginTop = '15px';
                impactDiv.style.padding = '10px';
                impactDiv.style.backgroundColor = '#e2e3e5';
                impactDiv.style.borderRadius = '6px';
                impactDiv.style.borderLeft = '4px solid #6c757d';
                
                const currentGrade = 100 - grandTotal;
                const gradeColor = currentGrade >= 80 ? 'green' : currentGrade >= 70 ? 'orange' : 'red';
                
                impactDiv.innerHTML = `
                    <h5>üìà Grade Impact:</h5>
                    <div><strong>Base Grade:</strong> 100 points</div>
                    <div><strong>Total Deductions:</strong> -${grandTotal.toFixed(1)} points</div>
                    <div style="font-weight: bold; margin-top: 10px; color: ${gradeColor};"><strong>Current Grade:</strong> ${Math.max(0, currentGrade).toFixed(1)} points</div>
                `;
                
                contentDiv.appendChild(impactDiv);
            }
            
            document.getElementById('deduction-details-modal').style.display = 'flex';
        }
        
        // Function to show related sessions for a specific deduction type
        function showRelatedSessions(deductionType) {
            if (!currentMember) return;
            
            const member = members[currentMember];
            const attendanceRecords = member.attendanceRecords || [];
            
            const typeMap = {
                'tardiness': 'tardy',
                'absences': 'absent',
                'missedActivities': 'missed_activity', 
                'lateSubmissions': 'late_submission'
            };
            
            const relatedRecords = attendanceRecords.filter(record => record.type === typeMap[deductionType]);
            
            // Create a mini modal or alert showing the related sessions
            let sessionsList = relatedRecords.map((record, index) => 
                `${index + 1}. ${record.sessionName || record.eventName || 'Manual Entry'} - ${record.date}`
            ).join('\n');
            
            if (sessionsList) {
                alert(`Related Sessions for ${deductionType}:\n\n${sessionsList}`);
            } else {
                alert('No related sessions found.');
            }
        }
        
        // Function to delete manual deduction
        function deleteManualDeduction(memberId, deductionIndex) {
            // Check if user has permission to delete
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can delete deduction records.');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this manual deduction? This action cannot be undone.')) {
                return;
            }
            
            const member = members[memberId];
            if (!member || !member.deductionRecords || deductionIndex >= member.deductionRecords.length) {
                alert('Invalid deduction record.');
                return;
            }
            
            const deletedRecord = member.deductionRecords[deductionIndex];
            
            // Remove the deduction record
            member.deductionRecords.splice(deductionIndex, 1);
            
            // Recalculate total deductions
            const autoDeductions = member.tardiness * 0.5 + 
                                  member.absences * 1 + 
                                  member.missedActivities * 1.5 + 
                                  member.lateSubmissions * 0.5;
            
            const manualDeductions = member.deductionRecords.reduce((total, record) => total + record.amount, 0);
            member.deductions = autoDeductions + manualDeductions;
            
            // Update the display
            showMember(memberId);
            showDeductionDetails(); // Refresh the deduction details modal
            
            alert(`Manual deduction of ${deletedRecord.amount} points deleted successfully!`);
        }
        
        // Function to close deduction details modal
        function closeDeductionDetailsModal() {
            document.getElementById('deduction-details-modal').style.display = 'none';
        }
        
        // Function to delete attendance record
        function deleteAttendanceRecord(memberId, recordType, recordIndex) {
            // Check if user has permission to delete
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can delete attendance records.');
                return;
            }
            
            if (!confirm('Move this attendance record to Recently Deleted? You can permanently delete it later.')) {
                return;
            }
            
            const member = members[memberId];
            if (!member || !member.attendanceRecords) return;
            
            // Filter records by type to find the correct index
            const typeMap = {
                'tardy': 'tardy',
                'absent': 'absent', 
                'missed_activity': 'missed_activity',
                'late_submission': 'late_submission'
            };
            
            const recordsOfType = member.attendanceRecords.filter(record => record.type === recordType);
            
            if (recordIndex >= 0 && recordIndex < recordsOfType.length) {
                const recordToDelete = recordsOfType[recordIndex];
                
                // Find the actual index in the full attendanceRecords array
                const actualIndex = member.attendanceRecords.indexOf(recordToDelete);
                
                if (actualIndex !== -1) {
                    // Move to recently deleted instead of permanent deletion
                    const deletedRecord = {
                        ...recordToDelete,
                        memberName: member.name,
                        memberId: memberId,
                        deletedDate: new Date().toLocaleString(),
                        originalIndex: actualIndex
                    };
                    
                    recentlyDeleted.unshift(deletedRecord); // Add to beginning
                    
                    // Keep only last 20 deleted records
                    if (recentlyDeleted.length > 20) {
                        recentlyDeleted = recentlyDeleted.slice(0, 20);
                    }
                    
                    // Remove the record from member's records
                    member.attendanceRecords.splice(actualIndex, 1);
                    
                    // Update the corresponding stat
                    if (recordType === 'tardy') {
                        member.tardiness = Math.max(0, member.tardiness - 1);
                    } else if (recordType === 'absent') {
                        member.absences = Math.max(0, member.absences - 1);
                    } else if (recordType === 'missed_activity') {
                        member.missedActivities = Math.max(0, member.missedActivities - 1);
                    } else if (recordType === 'late_submission') {
                        member.lateSubmissions = Math.max(0, member.lateSubmissions - 1);
                    }
                    
                    // Recalculate automatic deductions
                    const autoDeductions = member.tardiness * 0.5 + 
                                          member.absences * 1 + 
                                          member.missedActivities * 1.5 + 
                                          member.lateSubmissions * 0.5;
                    
                    const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
                    member.deductions = autoDeductions + manualDeductions;
                    
                    // Update displays
                    showMember(memberId);
                    updateRecentlyDeletedDisplay();
                    
                    // Save the changes immediately
                    saveToLocalStorage();
                    
                    // Refresh the attendance details modal
                    const typeDisplayMap = {
                        'tardy': 'tardiness',
                        'absent': 'absences',
                        'missed_activity': 'missedActivities',
                        'late_submission': 'lateSubmissions'
                    };
                    
                    showAttendanceDetails(typeDisplayMap[recordType]);
                    
                    alert('Attendance record moved to Recently Deleted!');
                }
            }
        }
        
        // Function to update recently deleted display
        function updateRecentlyDeletedDisplay() {
            const container = document.getElementById('recently-deleted-list');
            
            if (recentlyDeleted.length === 0) {
                container.innerHTML = '<div style="color: #95a5a6; font-size: 11px; text-align: center; font-style: italic;">No recently deleted items</div>';
                return;
            }
            
            container.innerHTML = '';
            
            recentlyDeleted.forEach((record, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'background: #34495e; margin: 3px 0; padding: 8px; border-radius: 4px; font-size: 11px; border-left: 3px solid #e74c3c;';
                
                const typeLabels = {
                    'tardy': 'Tardiness',
                    'absent': 'Absence',
                    'missed_activity': 'Missed Activity',
                    'late_submission': 'Late Submission'
                };
                
                item.innerHTML = `
                    <div style="color: #ecf0f1; font-weight: bold; margin-bottom: 3px;">${record.memberName.split(',')[0]}</div>
                    <div style="color: #bdc3c7; font-size: 10px;">${typeLabels[record.type]}</div>
                    <div style="color: #95a5a6; font-size: 9px; margin-top: 2px;">${record.deletedDate}</div>
                    <div style="margin-top: 5px; text-align: center;" class="admin-only">
                        <button onclick="restoreRecord(${index})" style="background: #27ae60; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 9px; margin-right: 3px; cursor: pointer;">Restore</button>
                        <button onclick="permanentlyDelete(${index})" style="background: #c0392b; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 9px; cursor: pointer;">Delete</button>
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // Function to restore a deleted record
        function restoreRecord(index) {
            const record = deletedRecords[index];
            record.deleted = false;
            record.deletedDate = null;
            deletedRecords.splice(index, 1);
            records.push(record);
            updateRecentlyDeletedDisplay();
        }
        
        // Function to permanently delete a record
        function permanentlyDelete(index) {
            deletedRecords.splice(index, 1);
            updateRecentlyDeletedDisplay();
        }
        
        function restoreRecord(index) {
            // Check if user has permission to restore
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can restore deleted records.');
                return;
            }
            
            if (index < 0 || index >= recentlyDeleted.length) return;
            
            const record = recentlyDeleted[index];
            const member = members[record.memberId];
            
            if (!member) {
                alert('Cannot restore: Member not found');
                return;
            }
            
            // Restore to member's attendance records
            if (!member.attendanceRecords) {
                member.attendanceRecords = [];
            }
            
            // Create clean record without the extra deleted info
            const restoredRecord = {
                type: record.type,
                date: record.date,
                sessionName: record.sessionName,
                sessionCategory: record.sessionCategory,
                reason: record.reason
            };
            
            member.attendanceRecords.push(restoredRecord);
            
            // Update stats
            if (record.type === 'tardy') {
                member.tardiness++;
            } else if (record.type === 'absent') {
                member.absences++;
            } else if (record.type === 'missed_activity') {
                member.missedActivities++;
            } else if (record.type === 'late_submission') {
                member.lateSubmissions++;
            }
            
            // Recalculate deductions
            const autoDeductions = member.tardiness * 0.5 + 
                                  member.absences * 1 + 
                                  member.missedActivities * 1.5 + 
                                  member.lateSubmissions * 0.5;
            
            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
            member.deductions = autoDeductions + manualDeductions;
            
            // Remove from recently deleted
            recentlyDeleted.splice(index, 1);
            
            // Update displays
            updateRecentlyDeletedDisplay();
            if (currentMember === record.memberId) {
                showMember(record.memberId);
            }
            
            // Save the changes immediately
            saveToLocalStorage();
            
            alert(`Restored ${record.memberName.split(',')[0]}'s record successfully!`);
        }
        
        // Function to permanently delete a record
        function permanentlyDelete(index) {
            // Check if user has permission to permanently delete
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can permanently delete records.');
                return;
            }
            
            if (!confirm('Permanently delete this record? This cannot be undone.')) {
                return;
            }
            
            const record = recentlyDeleted[index];
            recentlyDeleted.splice(index, 1);
            updateRecentlyDeletedDisplay();
            
            // Save the changes immediately
            saveToLocalStorage();
            
            alert(`${record.memberName.split(',')[0]}'s record permanently deleted.`);
        }
        
        // Function to clear all recently deleted records
        function clearAllDeleted() {
            // Check if user has permission to clear all deleted records
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can clear all deleted records.');
                return;
            }
            
            if (recentlyDeleted.length === 0) {
                alert('No recently deleted records to clear.');
                return;
            }
            
            if (!confirm(`Permanently delete all ${recentlyDeleted.length} recently deleted records? This cannot be undone.`)) {
                return;
            }
            
            recentlyDeleted = [];
            updateRecentlyDeletedDisplay();
            
            // Save the changes immediately
            saveToLocalStorage();
            
            alert('All recently deleted records cleared permanently.');
        }
        
        // Function to cancel session
        function cancelSession(sessionId) {
            // Check if user is a member - create approval request
            if (userRole === 'member') {
                const reason = prompt('Please provide a reason for canceling this session:');
                if (!reason || !reason.trim()) {
                    alert('Please provide a reason for the cancellation request.');
                    return;
                }
                createSessionApprovalRequest('cancel', sessionId, `Request to cancel session. Reason: ${reason.trim()}`);
                return;
            }
            
            if (!confirm('Are you sure you want to cancel this session? This action cannot be undone.')) {
                return;
            }
            
            const reason = prompt('Please provide a reason for canceling this session:');
            if (!reason || !reason.trim()) {
                alert('Please provide a reason for canceling the session.');
                return;
            }
            
            const sessionIndex = sessions.findIndex(s => s.id === sessionId);
            if (sessionIndex !== -1) {
                const session = sessions[sessionIndex];
                
                // Add cancellation information
                session.cancelled = true;
                session.cancellationDate = new Date().toLocaleString();
                session.cancellationReason = reason.trim();
                
                renderSessions();
                alert(`Session "${session.name}" has been cancelled successfully.`);
            }
        }
        
        // Function to reschedule session
        function rescheduleSession(sessionId) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session || session.completed) {
                alert('Cannot reschedule a completed session.');
                return;
            }
            
            // Check if user is a member - create approval request
            if (userRole === 'member') {
                const reason = prompt('Please provide a reason for rescheduling this session:');
                if (!reason || !reason.trim()) {
                    alert('Please provide a reason for the reschedule request.');
                    return;
                }
                createSessionApprovalRequest('reschedule', sessionId, `Request to reschedule session. Reason: ${reason.trim()}`);
                return;
            }
            
            currentSession = session;
            document.getElementById('reschedule-session-title').textContent = `${session.category} - ${session.name}`;
            
            // Pre-fill current times
            const startTime = new Date(session.startTime);
            const endTime = new Date(session.endTime);
            
            // Format for datetime-local input
            const formatForInput = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day}T${hours}:${minutes}`;
            };
            
            document.getElementById('reschedule-start').value = formatForInput(startTime);
            document.getElementById('reschedule-end').value = formatForInput(endTime);
            document.getElementById('reschedule-reason').value = '';
            
            document.getElementById('reschedule-session-modal').style.display = 'flex';
        }
        
        // Function to close reschedule modal
        function closeRescheduleModal() {
            document.getElementById('reschedule-session-modal').style.display = 'none';
            currentSession = null;
        }
        
        // Function to submit reschedule
        function submitReschedule() {
            const session = currentSession;
            if (!session) return;
            
            const newStartTime = document.getElementById('reschedule-start').value;
            const newEndTime = document.getElementById('reschedule-end').value;
            const reason = document.getElementById('reschedule-reason').value.trim();
            
            if (!newStartTime || !newEndTime) {
                alert('Please provide both start and end times.');
                return;
            }
            
            if (!reason) {
                alert('Please provide a reason for rescheduling.');
                return;
            }
            
            if (new Date(newStartTime) >= new Date(newEndTime)) {
                alert('End time must be after start time.');
                return;
            }
            
            // Store original times for history
            if (!session.rescheduleHistory) {
                session.rescheduleHistory = [];
            }
            
            session.rescheduleHistory.push({
                originalStart: session.startTime,
                originalEnd: session.endTime,
                newStart: newStartTime,
                newEnd: newEndTime,
                reason: reason,
                rescheduleDate: new Date().toLocaleString()
            });
            
            // Update session times
            session.startTime = newStartTime;
            session.endTime = newEndTime;
            session.lastRescheduled = new Date().toLocaleString();
            
            renderSessions();
            closeRescheduleModal();
            
            alert(`Session "${session.name}" has been rescheduled successfully!`);
        }
        
        // Function to create session approval request
        function createSessionApprovalRequest(type, sessionId, description) {
            const session = sessions.find(s => s.id === sessionId);
            if (!session) return;
            
            const request = {
                id: Date.now(),
                type: type, // 'complete', 'manual_complete', 'reschedule', 'cancel', 'delete'
                sessionId: sessionId,
                sessionName: session.name,
                sessionCategory: session.category,
                memberId: currentUser,
                memberName: members[currentUser].name,
                description: description,
                requestDate: new Date().toLocaleString(),
                status: 'pending'
            };
            
            pendingSessionRequests.push(request);
            updatePendingRequestsCount();
            saveToLocalStorage();
            
            alert(`${getActionDisplayName(type)} request submitted for admin approval.\n\nSession: ${session.name}\nRequest: ${description}`);
        }
        
        // Function to get action display name
        function getActionDisplayName(type) {
            const names = {
                'complete': 'Session Completion',
                'manual_complete': 'Manual Session Completion',
                'reschedule': 'Session Reschedule',
                'cancel': 'Session Cancellation',
                'delete': 'Session Deletion'
            };
            return names[type] || type;
        }
        
        // Function to manually complete an event
        function manualCompleteEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event || event.completed) return;
            
            // Ask for completion date
            const completionDate = prompt('Enter the completion date (leave empty for current date/time):');
            let finalCompletionDate;
            
            if (completionDate && completionDate.trim()) {
                // Validate and parse the provided date
                const parsedDate = new Date(completionDate.trim());
                if (isNaN(parsedDate.getTime())) {
                    alert('Invalid date format. Please use a valid date (e.g., 2024-01-15 or January 15, 2024)');
                    return;
                }
                finalCompletionDate = parsedDate.toLocaleString();
            } else {
                finalCompletionDate = new Date().toLocaleString();
            }
            
            // Ask for general completion reason
            const reason = prompt('Enter a general reason for completing this event:');
            if (!reason || !reason.trim()) {
                alert('Please provide a reason for completing this event');
                return;
            }
            
            // Ask about attendance issues
            const checkAttendance = confirm('Do you want to record any attendance issues (missed activities or late submissions)?');
            
            let missed = [];
            let late = [];
            
            if (checkAttendance) {
                // Check for missed activities
                event.participants.forEach(participantId => {
                    const memberName = members[participantId].name.split(',')[0];
                    if (confirm(`Did ${memberName} miss this activity?`)) {
                        const specificReason = prompt(`Please provide a specific reason why ${memberName} missed this activity:`);
                        if (specificReason && specificReason.trim()) {
                            missed.push(participantId);
                            members[participantId].missedActivities++;
                            
                            // Record detailed attendance data
                            if (!members[participantId].attendanceRecords) {
                                members[participantId].attendanceRecords = [];
                            }
                            members[participantId].attendanceRecords.push({
                                type: 'missed_activity',
                                date: finalCompletionDate,
                                eventName: event.name,
                                reason: specificReason.trim()
                            });
                            
                            // Update deductions
                            members[participantId].deductions = members[participantId].tardiness * 0.5 + 
                                                              members[participantId].absences * 1 + 
                                                              members[participantId].missedActivities * 1.5 + 
                                                              members[participantId].lateSubmissions * 0.5;
                        }
                    }
                });
                
                // Check for late submissions
                event.participants.forEach(participantId => {
                    const memberName = members[participantId].name.split(',')[0];
                    if (confirm(`Did ${memberName} submit late for this activity?`)) {
                        const specificReason = prompt(`Please provide a specific reason why ${memberName} submitted late:`);
                        if (specificReason && specificReason.trim()) {
                            late.push(participantId);
                            members[participantId].lateSubmissions++;
                            
                            // Record detailed attendance data
                            if (!members[participantId].attendanceRecords) {
                                members[participantId].attendanceRecords = [];
                            }
                            members[participantId].attendanceRecords.push({
                                type: 'late_submission',
                                date: finalCompletionDate,
                                eventName: event.name,
                                reason: specificReason.trim()
                            });
                            
                            // Update deductions
                            members[participantId].deductions = members[participantId].tardiness * 0.5 + 
                                                              members[participantId].absences * 1 + 
                                                              members[participantId].missedActivities * 1.5 + 
                                                              members[participantId].lateSubmissions * 0.5;
                        }
                    }
                });
            }
            
            // Mark as completed
            event.completed = true;
            event.completionDate = finalCompletionDate;
            event.reason = reason.trim();
            event.missed = missed;
            event.late = late;
            event.manualCompletion = true;
            
            // Update display if viewing a member who was affected
            const activeMember = document.querySelector('.member-btn.active');
            if (activeMember) {
                const memberId = getActiveMemberId();
                showMember(memberId);
            }
            
            // Refresh the display
            renderEvents();
            renderFilteredEvents(events); // Update filtered view if active
            
            let issuesSummary = '';
            if (missed.length > 0 || late.length > 0) {
                issuesSummary = `\n\nAttendance issues recorded:\n`;
                if (missed.length > 0) {
                    issuesSummary += `- Missed: ${missed.map(id => members[id].name.split(',')[0]).join(', ')}\n`;
                }
                if (late.length > 0) {
                    issuesSummary += `- Late submissions: ${late.map(id => members[id].name.split(',')[0]).join(', ')}`;
                }
            }
            
            alert(`Event "${event.name}" has been marked as completed on ${finalCompletionDate}${issuesSummary}`);
        }
        
        // Function to manually complete a meeting
        function manualCompleteMeeting(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting || meeting.completed) return;
            
            // Ask for completion date
            const completionDate = prompt('Enter the completion date (leave empty for current date/time):');
            let finalCompletionDate;
            
            if (completionDate && completionDate.trim()) {
                // Validate and parse the provided date
                const parsedDate = new Date(completionDate.trim());
                if (isNaN(parsedDate.getTime())) {
                    alert('Invalid date format. Please use a valid date (e.g., 2024-01-15 or January 15, 2024)');
                    return;
                }
                finalCompletionDate = parsedDate.toLocaleString();
            } else {
                finalCompletionDate = new Date().toLocaleString();
            }
            
            // Ask for general completion reason
            const reason = prompt('Enter a general reason for completing this meeting:');
            if (!reason || !reason.trim()) {
                alert('Please provide a reason for completing this meeting');
                return;
            }
            
            // Ask about attendance issues
            const checkAttendance = confirm('Do you want to record any attendance issues (tardiness or absences)?');
            
            let tardy = [];
            let absent = [];
            
            if (checkAttendance) {
                // Check for tardiness
                meeting.attendees.forEach(attendeeId => {
                    const memberName = members[attendeeId].name.split(',')[0];
                    if (confirm(`Was ${memberName} tardy to this meeting?`)) {
                        const specificReason = prompt(`Please provide a specific reason why ${memberName} was tardy:`);
                        if (specificReason && specificReason.trim()) {
                            tardy.push(attendeeId);
                            members[attendeeId].tardiness++;
                            
                            // Record detailed attendance data
                            if (!members[attendeeId].attendanceRecords) {
                                members[attendeeId].attendanceRecords = [];
                            }
                            members[attendeeId].attendanceRecords.push({
                                type: 'tardy',
                                date: finalCompletionDate,
                                meetingType: meeting.type,
                                reason: specificReason.trim()
                            });
                            
                            // Update deductions
                            members[attendeeId].deductions = members[attendeeId].tardiness * 0.5 + 
                                                            members[attendeeId].absences * 1 + 
                                                            members[attendeeId].missedActivities * 1.5 + 
                                                            members[attendeeId].lateSubmissions * 0.5;
                        }
                    }
                });
                
                // Check for absences
                meeting.attendees.forEach(attendeeId => {
                    const memberName = members[attendeeId].name.split(',')[0];
                    if (confirm(`Was ${memberName} absent from this meeting?`)) {
                        const specificReason = prompt(`Please provide a specific reason why ${memberName} was absent:`);
                        if (specificReason && specificReason.trim()) {
                            absent.push(attendeeId);
                            members[attendeeId].absences++;
                            
                            // Record detailed attendance data
                            if (!members[attendeeId].attendanceRecords) {
                                members[attendeeId].attendanceRecords = [];
                            }
                            members[attendeeId].attendanceRecords.push({
                                type: 'absent',
                                date: finalCompletionDate,
                                meetingType: meeting.type,
                                reason: specificReason.trim()
                            });
                            
                            // Update deductions
                            members[attendeeId].deductions = members[attendeeId].tardiness * 0.5 + 
                                                            members[attendeeId].absences * 1 + 
                                                            members[attendeeId].missedActivities * 1.5 + 
                                                            members[attendeeId].lateSubmissions * 0.5;
                        }
                    }
                });
            }
            
            // Mark as completed
            meeting.completed = true;
            meeting.completionDate = finalCompletionDate;
            meeting.reason = reason.trim();
            meeting.tardy = tardy;
            meeting.absent = absent;
            meeting.manualCompletion = true;
            
            // Update display if viewing a member who was affected
            const activeMember = document.querySelector('.member-btn.active');
            if (activeMember) {
                const memberId = getActiveMemberId();
                showMember(memberId);
            }
            
            // Refresh the display
            renderMeetings();
            renderFilteredMeetings(meetings); // Update filtered view if active
            
            let issuesSummary = '';
            if (tardy.length > 0 || absent.length > 0) {
                issuesSummary = `\n\nAttendance issues recorded:\n`;
                if (tardy.length > 0) {
                    issuesSummary += `- Tardy: ${tardy.map(id => members[id].name.split(',')[0]).join(', ')}\n`;
                }
                if (absent.length > 0) {
                    issuesSummary += `- Absent: ${absent.map(id => members[id].name.split(',')[0]).join(', ')}`;
                }
            }
            
            alert(`Meeting "${meeting.type}" has been marked as completed on ${finalCompletionDate}${issuesSummary}`);
        }
        function showMember(memberId) {
            // If user is a member and trying to view someone else's data, require password
            if (userRole === 'member' && memberId !== currentUser) {
                const targetMember = members[memberId];
                const password = prompt(`Enter ${targetMember.name.split(',')[0]}'s password to view their status:`);
                if (!password) {
                    return; // User cancelled
                }
                
                // Check against the specific member's password
                if (password !== targetMember.password) {
                    alert('Incorrect password. Access denied.');
                    return;
                }
            }
            
            currentMember = memberId;
            const member = members[memberId];
            document.getElementById('member-name').textContent = member.name;
            document.getElementById('tardiness').textContent = member.tardiness;
            document.getElementById('absences').textContent = member.absences;
            document.getElementById('missed-activities').textContent = member.missedActivities;
            document.getElementById('late-submissions').textContent = member.lateSubmissions;
            document.getElementById('deductions').textContent = member.deductions;

            // Show member actions only if user has access
            if (userRole === 'admin' || (userRole === 'member' && memberId === currentUser)) {
                document.getElementById('member-actions').style.display = 'block';
                
                // Hide edit button for members (read-only access)
                const editButton = document.querySelector('button[onclick="toggleEditMode()"]');
                if (editButton) {
                    editButton.style.display = userRole === 'admin' ? 'inline-block' : 'none';
                }
            } else {
                document.getElementById('member-actions').style.display = 'none';
            }
            
            document.getElementById('payment-status').style.display = 'block';
            
            // Update payment status
            updatePaymentStatus(memberId);

            // Update active button
            const buttons = document.querySelectorAll('.member-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        // Function to update payment status display
        function updatePaymentStatus(memberId) {
            const paymentList = document.getElementById('payment-list');
            if (!paymentList) return;
            
            const member = members[memberId];
            if (!member) return;
            
            paymentList.innerHTML = '';
            
            if (contributions.length === 0) {
                paymentList.innerHTML = '<p style="color: #666; font-style: italic;">No contributions available.</p>';
                return;
            }
            
            contributions.forEach(contribution => {
                const payment = member.payments.find(p => p.contributionId === contribution.id);
                
                // Calculate per-member amount
                const totalMembers = Object.keys(members).length;
                const perMemberAmount = contribution.amount / totalMembers;
                
                const isPaid = payment ? payment.paid : false;
                const partialAmount = payment ? payment.partialAmount || 0 : 0;
                const isPartial = partialAmount > 0 && partialAmount < perMemberAmount;
                
                let statusText = 'NOT PAID';
                let statusColor = '#e74c3c';
                let statusIcon = '‚ùå';
                
                if (isPaid) {
                    statusText = 'PAID';
                    statusColor = '#27ae60';
                    statusIcon = '‚úÖ';
                } else if (isPartial) {
                    statusText = `PARTIAL (‚Ç±${partialAmount.toFixed(2)} / ‚Ç±${perMemberAmount.toFixed(2)})`;
                    statusColor = '#f39c12';
                    statusIcon = 'üîÑ';
                }
                
                const paymentItem = document.createElement('div');
                paymentItem.className = 'event-item';
                paymentItem.style.marginBottom = '10px';
                
                paymentItem.innerHTML = `
                    <div class="event-title">${statusIcon} ${contribution.purpose}</div>
                    <div class="event-details">
                        <strong>Amount:</strong> ‚Ç±${perMemberAmount.toFixed(2)}<br>
                        <strong>Deadline:</strong> ${new Date(contribution.deadline).toLocaleDateString()}<br>
                        <strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                    </div>
                `;
                
                paymentList.appendChild(paymentItem);
            });
        }

        // Function to toggle edit mode
        function toggleEditMode() {
            editMode = true;
            const member = members[currentMember];
            
            // Hide stat values and show manual issue management interface
            document.getElementById('tardiness').style.display = 'none';
            document.getElementById('absences').style.display = 'none';
            document.getElementById('missed-activities').style.display = 'none';
            document.getElementById('late-submissions').style.display = 'none';
            document.getElementById('deductions').style.display = 'none';
            
            // Create manual issue management interface
            createManualIssueInterface();
            
            // Show save and cancel buttons
            document.getElementById('save-btn').style.display = 'inline-block';
            document.getElementById('cancel-btn').style.display = 'inline-block';
            event.target.style.display = 'none';
        }
        
        // Function to create manual issue management interface
        function createManualIssueInterface() {
            const member = members[currentMember];
            
            // Add header message about admin access
            const statsDiv = document.querySelector('.stats');
            const headerDiv = document.createElement('div');
            headerDiv.id = 'edit-mode-header';
            headerDiv.style.cssText = `
                margin: 15px 0;
                padding: 15px;
                background: ${userRole === 'admin' ? '#d4edda' : '#f8d7da'};
                border: 1px solid ${userRole === 'admin' ? '#c3e6cb' : '#f5c6cb'};
                border-radius: 6px;
                color: ${userRole === 'admin' ? '#155724' : '#721c24'};
                text-align: center;
            `;
            
            if (userRole === 'admin') {
                headerDiv.innerHTML = `
                    <strong>‚úì Admin Mode Active</strong><br>
                    <small>You can add and remove individual issues with detailed information.</small>
                `;
            } else {
                headerDiv.innerHTML = `
                    <strong>‚ö†Ô∏è View-Only Mode</strong><br>
                    <small>Admin login required to add or remove issues. Current user role: ${userRole || 'member'}</small>
                `;
            }
            
            statsDiv.parentNode.insertBefore(headerDiv, statsDiv.nextSibling);
            
            // Create containers for each stat type
            const statTypes = [
                { id: 'tardiness', name: 'Tardiness', records: member.attendanceRecords?.filter(r => r.type === 'tardy') || [] },
                { id: 'absences', name: 'Absences', records: member.attendanceRecords?.filter(r => r.type === 'absent') || [] },
                { id: 'missed-activities', name: 'Missed Activities', records: member.attendanceRecords?.filter(r => r.type === 'missed_activity') || [] },
                { id: 'late-submissions', name: 'Late Submissions', records: member.attendanceRecords?.filter(r => r.type === 'late_submission') || [] }
            ];
            
            statTypes.forEach(statType => {
                const statContainer = document.getElementById(statType.id).parentNode;
                
                // Create management interface
                const managementDiv = document.createElement('div');
                managementDiv.id = `${statType.id}-management`;
                managementDiv.style.marginTop = '10px';
                managementDiv.style.padding = '15px';
                managementDiv.style.backgroundColor = '#f8f9fa';
                managementDiv.style.borderRadius = '6px';
                managementDiv.style.border = '1px solid #dee2e6';
                
                let managementHTML = `
                    <h5 style="margin: 0 0 10px 0; color: #495057;">${statType.name} Management</h5>
                    <div style="margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="addManualIssue('${statType.id}')" style="font-size: 12px; padding: 6px 12px; ${userRole !== 'admin' ? 'background-color: #6c757d; cursor: not-allowed;' : ''}" ${userRole !== 'admin' ? 'disabled title="Admin access required"' : ''}>
                            + Add ${statType.name.slice(0, -1)}
                        </button>
                        <span style="margin-left: 10px; color: #6c757d; font-weight: bold;">Total: ${statType.records.length}</span>
                        ${userRole !== 'admin' ? '<div style="font-size: 11px; color: #dc3545; margin-top: 5px;">‚ö†Ô∏è Admin access required to add/remove issues</div>' : ''}
                    </div>
                    <div id="${statType.id}-records" style="max-height: 200px; overflow-y: auto;">
                `;
                
                // Display existing records
                statType.records.forEach((record, index) => {
                    managementHTML += `
                        <div class="issue-record" style="background: white; padding: 10px; margin-bottom: 8px; border-radius: 4px; border-left: 4px solid #dc3545;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; color: #495057; margin-bottom: 3px;">${record.title || 'Manual Entry'}</div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 2px;">Date: ${record.date}</div>
                                    <div style="font-size: 12px; color: #6c757d; margin-bottom: 2px;">Activity: ${record.sessionName || record.eventName || record.meetingType || 'N/A'}</div>
                                    <div style="font-size: 12px; color: #495057;">Reason: ${record.reason || 'No reason provided'}</div>
                                </div>
                                <button class="btn btn-danger" onclick="removeManualIssue('${statType.id}', ${index})" style="font-size: 10px; padding: 4px 8px; margin-left: 10px; ${userRole !== 'admin' ? 'background-color: #6c757d; cursor: not-allowed;' : ''}" ${userRole !== 'admin' ? 'disabled title="Admin access required"' : ''}>
                                    √ó Remove
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                if (statType.records.length === 0) {
                    managementHTML += '<div style="color: #6c757d; font-style: italic; text-align: center; padding: 20px;">No records found</div>';
                }
                
                managementHTML += '</div>';
                managementDiv.innerHTML = managementHTML;
                
                statContainer.appendChild(managementDiv);
            });
            
            // Handle deductions separately - show detailed automatic deductions
            const deductionsContainer = document.getElementById('deductions').parentNode;
            const deductionsDiv = document.createElement('div');
            deductionsDiv.id = 'deductions-management';
            deductionsDiv.style.cssText = `
                margin-top: 15px;
                padding: 25px;
                background-color: #f8f9fa;
                border-radius: 8px;
                border: 1px solid #dee2e6;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                min-width: 600px;
            `;
            
            // Calculate individual deduction components
            const tardinessDeductions = member.tardiness * 0.5;
            const absenceDeductions = member.absences * 1;
            const missedActivityDeductions = member.missedActivities * 1.5;
            const lateSubmissionDeductions = member.lateSubmissions * 0.5;
            const autoDeductions = tardinessDeductions + absenceDeductions + missedActivityDeductions + lateSubmissionDeductions;
            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
            
            let deductionsHTML = `
                <h5 style="margin: 0 0 20px 0; color: #495057; font-size: 16px; font-weight: 600;">
                    üìä Deductions Management
                </h5>
                
                <!-- Automatic Deductions Section -->
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 20px;">
                    <h6 style="margin: 0 0 15px 0; color: #495057; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
                        <span>‚ö° Automatic Deductions: <span style="color: #dc3545; font-weight: bold; font-size: 16px;">${autoDeductions.toFixed(1)} pts</span></span>
                        <button class="btn btn-success" onclick="addAutomaticDeduction()" style="font-size: 12px; padding: 6px 12px; ${userRole !== 'admin' ? 'background-color: #6c757d; cursor: not-allowed;' : ''}" ${userRole !== 'admin' ? 'disabled title="Admin access required"' : ''}>
                            + Add Auto
                        </button>
                    </h6>
            `;
            
            // Individual automatic deduction breakdowns
            const deductionTypes = [
                { type: 'Tardiness', count: member.tardiness, rate: 0.5, total: tardinessDeductions, color: '#ffc107', icon: '‚è∞', recordType: 'tardy' },
                { type: 'Absences', count: member.absences, rate: 1.0, total: absenceDeductions, color: '#dc3545', icon: '‚ùå', recordType: 'absent' },
                { type: 'Missed Activities', count: member.missedActivities, rate: 1.5, total: missedActivityDeductions, color: '#e74c3c', icon: 'üìù', recordType: 'missed_activity' },
                { type: 'Late Submissions', count: member.lateSubmissions, rate: 0.5, total: lateSubmissionDeductions, color: '#fd7e14', icon: 'üìÖ', recordType: 'late_submission' }
            ];
            
            deductionTypes.forEach(item => {
                if (item.count > 0) {
                    deductionsHTML += `
                        <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid ${item.color};">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1; padding-right: 15px;">
                                    <div style="font-weight: bold; color: #495057; margin-bottom: 5px; font-size: 15px;">
                                        ${item.icon} ${item.type}
                                    </div>
                                    <div style="font-size: 13px; color: #6c757d; margin-bottom: 8px;">
                                        ${item.count} √ó ${item.rate} pts each = <strong style="color: ${item.color};">${item.total.toFixed(1)} pts</strong>
                                    </div>
                                    <div style="font-size: 12px; color: #495057;">
                                        <strong>Recent incidents:</strong><br>
                    `;
                    
                    // Show recent incidents for this type
                    const recentRecords = (member.attendanceRecords || []).filter(r => r.type === item.recordType).slice(-3);
                    if (recentRecords.length > 0) {
                        recentRecords.forEach((record, index) => {
                            deductionsHTML += `
                                <div style="background: white; padding: 8px; margin: 4px 0; border-radius: 3px; font-size: 11px; position: relative;">
                                    <div style="font-weight: bold;">${record.title || 'Manual Entry'}</div>
                                    <div style="color: #6c757d;">${record.date} - ${record.sessionName || 'N/A'}</div>
                                    <div style="color: #495057;">${record.reason || 'No reason provided'}</div>
                                    <button onclick="removeSpecificAutoDeduction('${item.recordType}', ${member.attendanceRecords.indexOf(record)})" 
                                            style="position: absolute; top: 2px; right: 2px; background: #dc3545; color: white; border: none; border-radius: 2px; padding: 2px 4px; font-size: 10px; cursor: pointer; ${userRole !== 'admin' ? 'display: none;' : ''}" 
                                            title="Remove this incident">
                                        √ó
                                    </button>
                                </div>
                            `;
                        });
                    } else {
                        deductionsHTML += '<div style="color: #6c757d; font-style: italic;">No detailed records available</div>';
                    }
                    
                    deductionsHTML += `
                                    </div>
                                </div>
                                <div style="text-align: right; color: ${item.color}; font-weight: bold; font-size: 16px; min-width: 80px;">
                                    ${item.total.toFixed(1)} pts
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    deductionsHTML += `
                        <div style="background: #d4edda; padding: 12px; margin-bottom: 8px; border-radius: 6px; border-left: 4px solid #28a745;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="color: #155724; font-size: 14px; flex: 1; padding-right: 15px;">
                                    ${item.icon} ${item.type}: <strong>No issues</strong>
                                </div>
                                <div style="color: #28a745; font-weight: bold; font-size: 14px; min-width: 80px; text-align: right;">
                                    0.0 pts
                                </div>
                            </div>
                        </div>
                    `;
                }
            });
            
            deductionsHTML += '</div>';
            
            // Manual Deductions Section
            deductionsHTML += `
                <div style="background: white; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef; margin-bottom: 20px;">
                    <h6 style="margin: 0 0 15px 0; color: #495057; font-size: 15px; font-weight: 600; display: flex; align-items: center; justify-content: space-between;">
                        <span>üë§ Manual Deductions: <span style="color: #dc3545; font-weight: bold; font-size: 16px;">${manualDeductions.toFixed(1)} pts</span></span>
                        <button class="btn btn-primary" onclick="addManualDeduction()" style="font-size: 12px; padding: 6px 12px; ${userRole !== 'admin' ? 'background-color: #6c757d; cursor: not-allowed;' : ''}" ${userRole !== 'admin' ? 'disabled title="Admin access required"' : ''}>
                            + Add Manual
                        </button>
                    </h6>
            `;
            
            // Display manual deduction records
            const manualRecords = member.deductionRecords || [];
            if (manualRecords.length > 0) {
                manualRecords.forEach((record, index) => {
                    deductionsHTML += `
                        <div style="background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #dc3545;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div style="flex: 1; padding-right: 15px;">
                                    <div style="font-weight: bold; color: #495057; margin-bottom: 5px; font-size: 15px;">
                                        Manual Deduction #${index + 1}
                                    </div>
                                    <div style="font-size: 13px; color: #6c757d; margin-bottom: 3px;">
                                        <strong>Date:</strong> ${record.date}
                                    </div>
                                    <div style="font-size: 13px; color: #6c757d; margin-bottom: 3px;">
                                        <strong>Session:</strong> ${record.sessionName || 'Manual Entry'}
                                    </div>
                                    <div style="font-size: 13px; color: #495057;">
                                        <strong>Reason:</strong> ${record.reason}
                                    </div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                    <div style="color: #dc3545; font-weight: bold; font-size: 16px; margin-bottom: 8px;">
                                        ${record.amount.toFixed(1)} pts
                                    </div>
                                    <button onclick="removeManualDeduction(${index})" 
                                            style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; ${userRole !== 'admin' ? 'display: none;' : ''}" 
                                            title="Remove this deduction">
                                        √ó Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                deductionsHTML += '<div style="color: #6c757d; font-style: italic; text-align: center; padding: 20px;">No manual deductions recorded</div>';
            }
            
            deductionsHTML += '</div>';
            
            // Total Summary
            deductionsHTML += `
                <div style="background: linear-gradient(135deg, #6c757d, #495057); color: white; padding: 18px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 6px;">
                        Total Deductions: <span style="font-size: 18px;">${(autoDeductions + manualDeductions).toFixed(1)} pts</span>
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        Current Grade: <strong style="font-size: 14px;">${Math.max(0, 100 - (autoDeductions + manualDeductions)).toFixed(1)}/100</strong>
                    </div>
                </div>
            `;
            
            deductionsDiv.innerHTML = deductionsHTML;
            deductionsContainer.appendChild(deductionsDiv);
        }
        
        // Function to add manual issue
        function addManualIssue(statType) {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can add issues.');
                return;
            }
            
            const member = members[currentMember];
            
            // Get issue details from user
            const title = prompt('Enter the title/name of when this happened:');
            if (!title || !title.trim()) {
                alert('Title is required.');
                return;
            }
            
            const dateInput = prompt('Enter the date (YYYY-MM-DD format):');
            if (!dateInput || !dateInput.trim()) {
                alert('Date is required.');
                return;
            }
            
            // Validate date format
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(dateInput)) {
                alert('Please enter date in YYYY-MM-DD format (e.g., 2024-01-15)');
                return;
            }
            
            const activity = prompt('Enter the activity/session name:');
            if (!activity || !activity.trim()) {
                alert('Activity name is required.');
                return;
            }
            
            const reason = prompt('Enter the reason for this issue:');
            if (!reason || !reason.trim()) {
                alert('Reason is required.');
                return;
            }
            
            // Map stat type to record type
            const typeMap = {
                'tardiness': 'tardy',
                'absences': 'absent',
                'missed-activities': 'missed_activity',
                'late-submissions': 'late_submission'
            };
            
            const recordType = typeMap[statType];
            
            // Create attendance record
            if (!member.attendanceRecords) {
                member.attendanceRecords = [];
            }
            
            member.attendanceRecords.push({
                type: recordType,
                title: title.trim(),
                date: new Date(dateInput + 'T00:00:00').toLocaleString(),
                sessionName: activity.trim(),
                reason: reason.trim(),
                manualEntry: true
            });
            
            // Update member stats
            if (recordType === 'tardy') {
                member.tardiness++;
            } else if (recordType === 'absent') {
                member.absences++;
            } else if (recordType === 'missed_activity') {
                member.missedActivities++;
            } else if (recordType === 'late_submission') {
                member.lateSubmissions++;
            }
            
            // Recalculate deductions
            const autoDeductions = member.tardiness * 0.5 + member.absences * 1 + member.missedActivities * 1.5 + member.lateSubmissions * 0.5;
            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
            member.deductions = autoDeductions + manualDeductions;
            
            // Refresh the interface
            clearManualIssueInterface();
            createManualIssueInterface();
            
            alert(`${statType.charAt(0).toUpperCase() + statType.slice(1)} issue added successfully!`);
        }
        
        // Function to remove manual issue
        function removeManualIssue(statType, recordIndex) {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can remove issues.');
                return;
            }
            
            const member = members[currentMember];
            
            // Map stat type to record type
            const typeMap = {
                'tardiness': 'tardy',
                'absences': 'absent',
                'missed-activities': 'missed_activity',
                'late-submissions': 'late_submission'
            };
            
            const recordType = typeMap[statType];
            const records = member.attendanceRecords?.filter(r => r.type === recordType) || [];
            
            if (recordIndex >= 0 && recordIndex < records.length) {
                const recordToRemove = records[recordIndex];
                
                // Confirm deletion
                if (!confirm(`Are you sure you want to remove this ${statType.slice(0, -1)} record?

Title: ${recordToRemove.title || 'Manual Entry'}
Date: ${recordToRemove.date}
Reason: ${recordToRemove.reason}`)) {
                    return;
                }
                
                // Find and remove the record from the full attendanceRecords array
                const fullRecordIndex = member.attendanceRecords.findIndex(record => 
                    record.type === recordType && 
                    record.date === recordToRemove.date &&
                    record.reason === recordToRemove.reason
                );
                
                if (fullRecordIndex !== -1) {
                    member.attendanceRecords.splice(fullRecordIndex, 1);
                    
                    // Update member stats
                    if (recordType === 'tardy') {
                        member.tardiness = Math.max(0, member.tardiness - 1);
                    } else if (recordType === 'absent') {
                        member.absences = Math.max(0, member.absences - 1);
                    } else if (recordType === 'missed_activity') {
                        member.missedActivities = Math.max(0, member.missedActivities - 1);
                    } else if (recordType === 'late_submission') {
                        member.lateSubmissions = Math.max(0, member.lateSubmissions - 1);
                    }
                    
                    // Recalculate deductions
                    const autoDeductions = member.tardiness * 0.5 + member.absences * 1 + member.missedActivities * 1.5 + member.lateSubmissions * 0.5;
                    const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
                    member.deductions = autoDeductions + manualDeductions;
                    
                    // Refresh the interface
                    clearManualIssueInterface();
                    createManualIssueInterface();
                    
                    alert('Issue removed successfully!');
                } else {
                    alert('Error: Could not find the record to remove.');
                }
            }
        }
        
        // Function to clear manual issue interface
        function clearManualIssueInterface() {
            const managementDivs = [
                'edit-mode-header',
                'tardiness-management',
                'absences-management', 
                'missed-activities-management',
                'late-submissions-management',
                'deductions-management'
            ];
            
            managementDivs.forEach(id => {
                const div = document.getElementById(id);
                if (div) {
                    div.remove();
                }
            });
        }
        
        // Function to add automatic deduction
        function addAutomaticDeduction() {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can add deductions.');
                return;
            }
            
            const member = members[currentMember];
            
            // Get deduction type
            const type = prompt('Select deduction type:\n1. Tardiness (0.5 pts)\n2. Absence (1.0 pts)\n3. Missed Activity (1.5 pts)\n4. Late Submission (0.5 pts)\n\nEnter number (1-4):');
            
            if (!type || !['1', '2', '3', '4'].includes(type)) {
                alert('Invalid selection. Please enter 1, 2, 3, or 4.');
                return;
            }
            
            const typeMap = {
                '1': { name: 'Tardiness', recordType: 'tardy', rate: 0.5, statField: 'tardiness' },
                '2': { name: 'Absence', recordType: 'absent', rate: 1.0, statField: 'absences' },
                '3': { name: 'Missed Activity', recordType: 'missed_activity', rate: 1.5, statField: 'missedActivities' },
                '4': { name: 'Late Submission', recordType: 'late_submission', rate: 0.5, statField: 'lateSubmissions' }
            };
            
            const selectedType = typeMap[type];
            
            // Get details
            const title = prompt(`Enter the title/name for this ${selectedType.name}:`);
            if (!title || !title.trim()) {
                alert('Title is required.');
                return;
            }
            
            const dateInput = prompt('Enter the date (YYYY-MM-DD format):');
            if (!dateInput || !dateInput.trim()) {
                alert('Date is required.');
                return;
            }
            
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(dateInput)) {
                alert('Please enter date in YYYY-MM-DD format (e.g., 2024-01-15)');
                return;
            }
            
            const activity = prompt('Enter the activity/session name:');
            if (!activity || !activity.trim()) {
                alert('Activity name is required.');
                return;
            }
            
            const reason = prompt(`Enter the reason for this ${selectedType.name}:`);
            if (!reason || !reason.trim()) {
                alert('Reason is required.');
                return;
            }
            
            // Create attendance record
            if (!member.attendanceRecords) {
                member.attendanceRecords = [];
            }
            
            member.attendanceRecords.push({
                type: selectedType.recordType,
                title: title.trim(),
                date: new Date(dateInput + 'T00:00:00').toLocaleString(),
                sessionName: activity.trim(),
                reason: reason.trim(),
                manualEntry: true
            });
            
            // Update member stats
            member[selectedType.statField]++;
            
            // Recalculate deductions
            const autoDeductions = member.tardiness * 0.5 + member.absences * 1 + member.missedActivities * 1.5 + member.lateSubmissions * 0.5;
            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
            member.deductions = autoDeductions + manualDeductions;
            
            // Refresh the interface
            clearManualIssueInterface();
            createManualIssueInterface();
            
            // Update main display
            document.getElementById('tardiness').textContent = member.tardiness;
            document.getElementById('absences').textContent = member.absences;
            document.getElementById('missed-activities').textContent = member.missedActivities;
            document.getElementById('late-submissions').textContent = member.lateSubmissions;
            document.getElementById('deductions').textContent = member.deductions.toFixed(1);
            
            // Save changes
            saveToLocalStorage();
            
            alert(`${selectedType.name} added successfully!`);
        }
        
        // Function to add manual deduction
        function addManualDeduction() {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can add deductions.');
                return;
            }
            
            const member = members[currentMember];
            
            // Get deduction details
            const amountStr = prompt('Enter deduction amount (points):');
            if (!amountStr || !amountStr.trim()) {
                alert('Amount is required.');
                return;
            }
            
            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid positive number.');
                return;
            }
            
            const reason = prompt('Enter the reason for this deduction:');
            if (!reason || !reason.trim()) {
                alert('Reason is required.');
                return;
            }
            
            const sessionName = prompt('Enter the session/activity name (optional):') || 'Manual Entry';
            
            // Create manual deduction record
            if (!member.deductionRecords) {
                member.deductionRecords = [];
            }
            
            member.deductionRecords.push({
                amount: amount,
                reason: reason.trim(),
                date: new Date().toLocaleString(),
                sessionName: sessionName.trim()
            });
            
            // Recalculate deductions
            const autoDeductions = member.tardiness * 0.5 + member.absences * 1 + member.missedActivities * 1.5 + member.lateSubmissions * 0.5;
            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
            member.deductions = autoDeductions + manualDeductions;
            
            // Refresh the interface
            clearManualIssueInterface();
            createManualIssueInterface();
            
            // Update main display
            document.getElementById('deductions').textContent = member.deductions.toFixed(1);
            
            // Save changes
            saveToLocalStorage();
            
            alert(`Manual deduction of ${amount.toFixed(1)} points added successfully!`);
        }
        
        // Function to remove specific automatic deduction
        function removeSpecificAutoDeduction(recordType, recordIndex) {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can remove deductions.');
                return;
            }
            
            const member = members[currentMember];
            const record = member.attendanceRecords[recordIndex];
            
            if (!record || record.type !== recordType) {
                alert('Error: Could not find the record to remove.');
                return;
            }
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to remove this ${recordType} incident?

Title: ${record.title || 'Manual Entry'}
Date: ${record.date}
Reason: ${record.reason}`)) {
                return;
            }
            
            // Remove the record
            member.attendanceRecords.splice(recordIndex, 1);
            
            // Update member stats
            if (recordType === 'tardy') {
                member.tardiness = Math.max(0, member.tardiness - 1);
            } else if (recordType === 'absent') {
                member.absences = Math.max(0, member.absences - 1);
            } else if (recordType === 'missed_activity') {
                member.missedActivities = Math.max(0, member.missedActivities - 1);
            } else if (recordType === 'late_submission') {
                member.lateSubmissions = Math.max(0, member.lateSubmissions - 1);
            }
            
            // Recalculate deductions
            const autoDeductions = member.tardiness * 0.5 + member.absences * 1 + member.missedActivities * 1.5 + member.lateSubmissions * 0.5;
            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
            member.deductions = autoDeductions + manualDeductions;
            
            // Refresh the interface
            clearManualIssueInterface();
            createManualIssueInterface();
            
            // Update main display
            document.getElementById('tardiness').textContent = member.tardiness;
            document.getElementById('absences').textContent = member.absences;
            document.getElementById('missed-activities').textContent = member.missedActivities;
            document.getElementById('late-submissions').textContent = member.lateSubmissions;
            document.getElementById('deductions').textContent = member.deductions.toFixed(1);
            
            // Save changes
            saveToLocalStorage();
            
            alert('Automatic deduction removed successfully!');
        }
        
        // Function to remove manual deduction
        function removeManualDeduction(recordIndex) {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can remove deductions.');
                return;
            }
            
            const member = members[currentMember];
            const record = member.deductionRecords[recordIndex];
            
            if (!record) {
                alert('Error: Could not find the record to remove.');
                return;
            }
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to remove this manual deduction?

Amount: ${record.amount.toFixed(1)} points
Reason: ${record.reason}
Date: ${record.date}`)) {
                return;
            }
            
            // Remove the record
            member.deductionRecords.splice(recordIndex, 1);
            
            // Recalculate deductions
            const autoDeductions = member.tardiness * 0.5 + member.absences * 1 + member.missedActivities * 1.5 + member.lateSubmissions * 0.5;
            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
            member.deductions = autoDeductions + manualDeductions;
            
            // Refresh the interface
            clearManualIssueInterface();
            createManualIssueInterface();
            
            // Update main display
            document.getElementById('deductions').textContent = member.deductions.toFixed(1);
            
            // Save changes
            saveToLocalStorage();
            
            alert('Manual deduction removed successfully!');
        }
        
        // Function to clear manual issue interface
        function clearManualIssueInterface() {
            const managementDivs = [
                'edit-mode-header',
                'tardiness-management',
                'absences-management', 
                'missed-activities-management',
                'late-submissions-management',
                'deductions-management'
            ];
            
            managementDivs.forEach(id => {
                const div = document.getElementById(id);
                if (div) {
                    div.remove();
                }
            });
        }

        // Function to save stats
        function saveStats() {
            const member = members[currentMember];
            
            // Update display with current values (stats are managed through manual interface)
            document.getElementById('tardiness').textContent = member.tardiness;
            document.getElementById('absences').textContent = member.absences;
            document.getElementById('missed-activities').textContent = member.missedActivities;
            document.getElementById('late-submissions').textContent = member.lateSubmissions;
            document.getElementById('deductions').textContent = member.deductions.toFixed(1);
            
            // Save to localStorage
            saveToLocalStorage();
            
            cancelEdit();
            
            alert('Stats updated successfully!');
        }

        // Function to cancel edit
        function cancelEdit() {
            editMode = false;
            
            // Clear manual issue interface
            clearManualIssueInterface();
            
            // Show stat values
            document.getElementById('tardiness').style.display = 'block';
            document.getElementById('absences').style.display = 'block';
            document.getElementById('missed-activities').style.display = 'block';
            document.getElementById('late-submissions').style.display = 'block';
            document.getElementById('deductions').style.display = 'block';
            
            // Hide save and cancel buttons, show edit button
            document.getElementById('save-btn').style.display = 'none';
            document.getElementById('cancel-btn').style.display = 'none';
            document.querySelector('button[onclick="toggleEditMode()"]').style.display = 'inline-block';
        }

        // Function to open payment modal
        function openPaymentModal() {
            document.getElementById('payment-member-name').textContent = members[currentMember].name;
            document.getElementById('payment-modal').style.display = 'flex';
            updatePaymentModal();
        }

        // Function to close payment modal
        function closePaymentModal() {
            document.getElementById('payment-modal').style.display = 'none';
        }

        // Function to update payment modal
        function updatePaymentModal() {
            const paymentContainer = document.getElementById('contribution-payments');
            paymentContainer.innerHTML = '';
            
            if (contributions.length === 0) {
                paymentContainer.innerHTML = '<p>No contributions available.</p>';
                return;
            }
            
            // Show pending requests for current member if they are a member
            if (userRole === 'member') {
                const memberRequests = pendingPaymentRequests.filter(r => 
                    r.memberId === currentMember && r.status === 'pending'
                );
                
                if (memberRequests.length > 0) {
                    const requestsDiv = document.createElement('div');
                    requestsDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px; margin-bottom: 20px;';
                    
                    let requestsHTML = '<h4 style="margin: 0 0 10px 0; color: #856404;">üìã Pending Approval Requests</h4>';
                    memberRequests.forEach(request => {
                        const typeLabels = {
                            'partial_payment': 'Partial Payment',
                            'mark_paid': 'Mark as Paid',
                            'mark_unpaid': 'Mark as Unpaid'
                        };
                        requestsHTML += `
                            <div style="margin-bottom: 8px; font-size: 14px; color: #856404;">
                                ‚è≥ <strong>${typeLabels[request.type]}</strong> for "${request.contributionPurpose}"
                                ${request.amount > 0 ? ` - ‚Ç±${request.amount.toFixed(2)}` : ''}
                                <br><small style="color: #6c757d;">Requested: ${request.requestDate}</small>
                            </div>
                        `;
                    });
                    requestsHTML += '<p style="margin: 10px 0 0 0; font-size: 12px; color: #856404; font-style: italic;">Your requests are waiting for admin approval.</p>';
                    
                    requestsDiv.innerHTML = requestsHTML;
                    paymentContainer.appendChild(requestsDiv);
                }
            }
            
            contributions.forEach(contribution => {
                const member = members[currentMember];
                const payment = member.payments.find(p => p.contributionId === contribution.id);
                
                // Calculate per-member amount
                const totalMembers = Object.keys(members).length;
                const perMemberAmount = contribution.amount / totalMembers;
                
                const isPaid = payment ? payment.paid : false;
                const partialAmount = payment ? payment.partialAmount || 0 : 0;
                const isPartial = partialAmount > 0 && partialAmount < perMemberAmount;
                
                const paymentItem = document.createElement('div');
                paymentItem.className = 'event-item';
                paymentItem.style.marginBottom = '15px';
                
                let statusText = 'NOT PAID';
                let statusColor = 'red';
                if (isPaid) {
                    statusText = 'PAID';
                    statusColor = 'green';
                } else if (isPartial) {
                    statusText = `PARTIAL (‚Ç±${partialAmount.toFixed(2)} / ‚Ç±${perMemberAmount.toFixed(2)})`;
                    statusColor = 'orange';
                }
                
                paymentItem.innerHTML = `
                    <div class="event-title">‚Ç±${perMemberAmount.toFixed(2)} - ${contribution.purpose}</div>
                    <div class="event-details">
                        <strong>Your Share:</strong> ‚Ç±${perMemberAmount.toFixed(2)} (of ‚Ç±${contribution.amount.toFixed(2)} total)<br>
                        Deadline: ${new Date(contribution.deadline).toLocaleString()}<br>
                        Status: <span style="color: ${statusColor}; font-weight: bold;">${statusText}</span>
                        <br><br>
                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                            <input type="number" id="partial-${contribution.id}" placeholder="Partial amount" step="0.01" min="0" max="${perMemberAmount.toFixed(2)}" style="width: 120px; padding: 5px;">
                            <button class="btn btn-primary" onclick="addPartialPayment(${contribution.id})" style="font-size: 12px;">Add Partial</button>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn ${isPaid ? 'btn-success' : 'btn-primary'}" onclick="togglePayment(${contribution.id})">
                                ${isPaid ? 'Mark as Unpaid' : 'Mark as Paid'}
                            </button>
                            <button class="btn" onclick="showPaymentHistory(${contribution.id})" style="font-size: 12px;">View History</button>
                        </div>
                    </div>
                `;
                
                paymentContainer.appendChild(paymentItem);
            });
        }

        // Function to add partial payment
        function addPartialPayment(contributionId) {
            const partialInput = document.getElementById(`partial-${contributionId}`);
            const amount = parseFloat(partialInput.value);
            
            if (!amount || amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            const contribution = contributions.find(c => c.id === contributionId);
            const totalMembers = Object.keys(members).length;
            const perMemberAmount = contribution.amount / totalMembers;
            
            if (amount > perMemberAmount) {
                alert(`Partial payment cannot exceed your share of ‚Ç±${perMemberAmount.toFixed(2)}`);
                return;
            }
            
            // Check if user is a member - create approval request
            if (userRole === 'member') {
                const request = {
                    id: Date.now(),
                    memberId: currentMember,
                    memberName: members[currentMember].name,
                    contributionId: contributionId,
                    contributionPurpose: contribution.purpose,
                    type: 'partial_payment',
                    amount: amount,
                    perMemberAmount: perMemberAmount,
                    requestDate: new Date().toLocaleString(),
                    status: 'pending'
                };
                
                pendingPaymentRequests.push(request);
                updatePendingRequestsCount();
                saveToLocalStorage();
                
                partialInput.value = '';
                alert(`Payment request of ‚Ç±${amount.toFixed(2)} submitted for admin approval.`);
                return;
            }
            
            // Admin can add directly (existing functionality)
            const member = members[currentMember];
            let payment = member.payments.find(p => p.contributionId === contributionId);
            
            if (!payment) {
                payment = {
                    contributionId: contributionId,
                    paid: false,
                    partialAmount: 0,
                    paymentHistory: []
                };
                member.payments.push(payment);
            }
            
            // Add to payment history
            payment.paymentHistory.push({
                amount: amount,
                date: new Date().toLocaleString(),
                type: 'partial'
            });
            
            payment.partialAmount = (payment.partialAmount || 0) + amount;
            
            // Check if fully paid (comparing to per-member amount)
            if (payment.partialAmount >= perMemberAmount) {
                payment.paid = true;
                payment.paymentHistory.push({
                    amount: 0,
                    date: new Date().toLocaleString(),
                    type: 'completed'
                });
            }
            
            partialInput.value = '';
            updatePaymentModal();
            updatePaymentStatus(currentMember);
            saveToLocalStorage();
        }

        // Function to show payment history
        function showPaymentHistory(contributionId) {
            const member = members[currentMember];
            const payment = member.payments.find(p => p.contributionId === contributionId);
            const contribution = contributions.find(c => c.id === contributionId);
            const totalMembers = Object.keys(members).length;
            const perMemberAmount = contribution.amount / totalMembers;
            
            if (!payment || !payment.paymentHistory || payment.paymentHistory.length === 0) {
                alert('No payment history available for this contribution.');
                return;
            }
            
            let historyText = `Payment History for: ${contribution.purpose}\n`;
            historyText += `Your Share: ‚Ç±${perMemberAmount.toFixed(2)} (of ‚Ç±${contribution.amount.toFixed(2)} total)\n\n`;
            
            payment.paymentHistory.forEach((entry, index) => {
                if (entry.type === 'partial') {
                    historyText += `${index + 1}. Partial Payment: ‚Ç±${entry.amount.toFixed(2)} on ${entry.date}\n`;
                } else if (entry.type === 'completed') {
                    historyText += `${index + 1}. Your Share Completed on ${entry.date}\n`;
                } else if (entry.type === 'full_payment') {
                    historyText += `${index + 1}. Full Payment: ‚Ç±${entry.amount.toFixed(2)} on ${entry.date}\n`;
                    if (entry.note) historyText += `    Note: ${entry.note}\n`;
                } else if (entry.type === 'payment_removed') {
                    historyText += `${index + 1}. Payment Removed on ${entry.date}\n`;
                    if (entry.note) historyText += `    Note: ${entry.note}\n`;
                } else if (entry.type === 'auto_completion') {
                    historyText += `${index + 1}. Auto-Completion: ‚Ç±${entry.amount.toFixed(2)} on ${entry.date}\n`;
                    if (entry.note) historyText += `    Note: ${entry.note}\n`;
                } else if (entry.type === 'marked_complete') {
                    historyText += `${index + 1}. Marked Complete on ${entry.date}\n`;
                    if (entry.note) historyText += `    Note: ${entry.note}\n`;
                }
            });
            
            historyText += `\nTotal Paid: ‚Ç±${(payment.partialAmount || 0).toFixed(2)} / ‚Ç±${perMemberAmount.toFixed(2)}`;
            
            alert(historyText);
        }

        // Function to toggle payment status
        function togglePayment(contributionId) {
            const contribution = contributions.find(c => c.id === contributionId);
            const totalMembers = Object.keys(members).length;
            const perMemberAmount = contribution.amount / totalMembers;
            
            // Check if user is a member - create approval request
            if (userRole === 'member') {
                const member = members[currentMember];
                const payment = member.payments.find(p => p.contributionId === contributionId);
                const currentPartialAmount = payment ? (payment.partialAmount || 0) : 0;
                const isPaid = payment ? payment.paid : false;
                
                let requestType, amount, description;
                
                if (isPaid) {
                    requestType = 'mark_unpaid';
                    amount = 0;
                    description = `Request to mark as unpaid (remove ‚Ç±${currentPartialAmount.toFixed(2)} payment)`;
                } else {
                    const remainingAmount = perMemberAmount - currentPartialAmount;
                    if (remainingAmount > 0) {
                        requestType = 'mark_paid';
                        amount = remainingAmount;
                        description = `Request to mark as paid (add ‚Ç±${remainingAmount.toFixed(2)} to complete payment)`;
                    } else {
                        requestType = 'mark_paid';
                        amount = 0;
                        description = 'Request to mark as paid (already fully paid, just need status update)';
                    }
                }
                
                const request = {
                    id: Date.now(),
                    memberId: currentMember,
                    memberName: members[currentMember].name,
                    contributionId: contributionId,
                    contributionPurpose: contribution.purpose,
                    type: requestType,
                    amount: amount,
                    perMemberAmount: perMemberAmount,
                    currentPartialAmount: currentPartialAmount,
                    description: description,
                    requestDate: new Date().toLocaleString(),
                    status: 'pending'
                };
                
                pendingPaymentRequests.push(request);
                updatePendingRequestsCount();
                saveToLocalStorage();
                
                alert(`Payment status change request submitted for admin approval.\n\n${description}`);
                return;
            }
            
            // Admin can toggle directly (existing functionality)
            const member = members[currentMember];
            const paymentIndex = member.payments.findIndex(p => p.contributionId === contributionId);
            
            if (paymentIndex >= 0) {
                const payment = member.payments[paymentIndex];
                const currentPartialAmount = payment.partialAmount || 0;
                
                if (payment.paid) {
                    // If currently paid, mark as unpaid and reset to 0
                    payment.paid = false;
                    payment.partialAmount = 0;
                    
                    // Add to payment history
                    if (!payment.paymentHistory) payment.paymentHistory = [];
                    payment.paymentHistory.push({
                        amount: 0,
                        date: new Date().toLocaleString(),
                        type: 'payment_removed',
                        note: `Removed ‚Ç±${currentPartialAmount.toFixed(2)} payment`
                    });
                } else {
                    // If not paid, calculate remaining amount needed and add it
                    const remainingAmount = perMemberAmount - currentPartialAmount;
                    
                    if (remainingAmount > 0) {
                        payment.partialAmount = perMemberAmount;
                        payment.paid = true;
                        
                        // Add to payment history
                        if (!payment.paymentHistory) payment.paymentHistory = [];
                        payment.paymentHistory.push({
                            amount: remainingAmount,
                            date: new Date().toLocaleString(),
                            type: 'auto_completion',
                            note: `Auto-added ‚Ç±${remainingAmount.toFixed(2)} to complete payment`
                        });
                    } else {
                        // Already fully paid, just mark as paid
                        payment.paid = true;
                        
                        if (!payment.paymentHistory) payment.paymentHistory = [];
                        payment.paymentHistory.push({
                            amount: 0,
                            date: new Date().toLocaleString(),
                            type: 'marked_complete',
                            note: 'Marked as complete (already fully paid)'
                        });
                    }
                }
            } else {
                // No existing payment record, create new one with full amount
                member.payments.push({
                    contributionId: contributionId,
                    paid: true,
                    partialAmount: perMemberAmount,
                    paymentHistory: [{
                        amount: perMemberAmount,
                        date: new Date().toLocaleString(),
                        type: 'full_payment',
                        note: `Full payment of ‚Ç±${perMemberAmount.toFixed(2)}`
                    }]
                });
            }
            
            updatePaymentModal();
            updatePaymentStatus(currentMember);
            saveToLocalStorage();
        }

        // Function to show contribution summary
        function showContributionSummary() {
            document.getElementById('contribution-summary-modal').style.display = 'flex';
            updateContributionSummary();
        }

        // Function to close contribution summary modal
        function closeContributionSummaryModal() {
            document.getElementById('contribution-summary-modal').style.display = 'none';
        }

        // Function to show My Sessions modal
        function showMySessionsModal() {
            document.getElementById('my-sessions-modal').style.display = 'flex';
            updateMySessionsOverview();
        }

        // Function to close My Sessions modal
        function closeMySessionsModal() {
            document.getElementById('my-sessions-modal').style.display = 'none';
        }

        // Function to update My Sessions overview
        function updateMySessionsOverview() {
            updateMySessionsStats();
            renderMySessions();
        }

        // Function to update session statistics
        function updateMySessionsStats() {
            const statsContainer = document.getElementById('session-stats');
            
            // Calculate statistics
            const totalSessions = sessions.length;
            const completedSessions = sessions.filter(s => s.completed).length;
            const pendingSessions = sessions.filter(s => !s.completed && !s.cancelled).length;
            const cancelledSessions = sessions.filter(s => s.cancelled).length;
            
            const now = new Date();
            const upcomingSessions = sessions.filter(s => {
                return !s.completed && !s.cancelled && new Date(s.startTime) > now;
            }).length;
            
            const inProgressSessions = sessions.filter(s => {
                const startTime = new Date(s.startTime);
                const endTime = new Date(s.endTime);
                return !s.completed && !s.cancelled && startTime <= now && now <= endTime;
            }).length;
            
            const overdueSessions = sessions.filter(s => {
                const endTime = new Date(s.endTime);
                return !s.completed && !s.cancelled && endTime < now;
            }).length;
            
            // Calculate completion rate
            const completionRate = totalSessions > 0 ? ((completedSessions / totalSessions) * 100).toFixed(1) : 0;
            
            statsContainer.innerHTML = `
                <div>
                    <div style="font-size: 24px; font-weight: bold;">${totalSessions}</div>
                    <div style="font-size: 14px; opacity: 0.9;">Total Sessions</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${completedSessions}</div>
                    <div style="font-size: 14px; opacity: 0.9;">Completed</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${pendingSessions}</div>
                    <div style="font-size: 14px; opacity: 0.9;">Pending</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${cancelledSessions}</div>
                    <div style="font-size: 14px; opacity: 0.9;">Cancelled</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #3498db;">${upcomingSessions}</div>
                    <div style="font-size: 14px; opacity: 0.9;">Upcoming</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #9b59b6;">${inProgressSessions}</div>
                    <div style="font-size: 14px; opacity: 0.9;">In Progress</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #f39c12;">${overdueSessions}</div>
                    <div style="font-size: 14px; opacity: 0.9;">Overdue</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold; color: #1abc9c;">${completionRate}%</div>
                    <div style="font-size: 14px; opacity: 0.9;">Completion Rate</div>
                </div>
            `;
        }

        // Function to render My Sessions
        function renderMySessions(filteredSessions = null) {
            const sessionsToRender = filteredSessions || sessions;
            
            // Clear all section lists
            document.getElementById('active-sessions-list').innerHTML = '';
            document.getElementById('completed-sessions-list').innerHTML = '';
            document.getElementById('canceled-sessions-list').innerHTML = '';
            
            if (sessionsToRender.length === 0) {
                document.getElementById('active-sessions-list').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <h4>üìÖ No Active Sessions</h4>
                        <p>No active sessions found.</p>
                        <button class="btn btn-primary admin-only" onclick="openSessionModal(); closeMySessionsModal();">+ Add First Session</button>
                    </div>
                `;
                document.getElementById('active-sessions-count').textContent = '0 sessions';
                document.getElementById('completed-sessions-count').textContent = '0 sessions';
                document.getElementById('canceled-sessions-count').textContent = '0 sessions';
                return;
            }
            
            // Categorize sessions
            const now = new Date();
            const activeSessions = [];
            const completedSessions = [];
            const canceledSessions = [];
            
            sessionsToRender.forEach(session => {
                if (session.cancelled) {
                    canceledSessions.push(session);
                } else if (session.completed) {
                    completedSessions.push(session);
                } else {
                    // Active sessions include: pending, upcoming, in progress, and overdue
                    activeSessions.push(session);
                }
            });
            
            // Update counts
            document.getElementById('active-sessions-count').textContent = `${activeSessions.length} sessions`;
            document.getElementById('completed-sessions-count').textContent = `${completedSessions.length} sessions`;
            document.getElementById('canceled-sessions-count').textContent = `${canceledSessions.length} sessions`;
            
            // Sort sessions within each category by creation date (newest first)
            const sortedActiveSessions = [...activeSessions].sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
            const sortedCompletedSessions = [...completedSessions].sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
            const sortedCanceledSessions = [...canceledSessions].sort((a, b) => new Date(b.createdDate) - new Date(a.createdDate));
            
            // Render each section
            renderSessionSection(sortedActiveSessions, 'active-sessions-list', 'active');
            renderSessionSection(sortedCompletedSessions, 'completed-sessions-list', 'completed');
            renderSessionSection(sortedCanceledSessions, 'canceled-sessions-list', 'canceled');
        }
        
        // Function to render sessions in a specific section
        function renderSessionSection(sessionsList, containerId, sectionType) {
            const container = document.getElementById(containerId);
            
            if (sessionsList.length === 0) {
                let emptyMessage = '';
                let emptyIcon = '';
                
                switch(sectionType) {
                    case 'active':
                        emptyIcon = 'üìÖ';
                        emptyMessage = 'No active sessions at the moment.';
                        break;
                    case 'completed':
                        emptyIcon = '‚úÖ';
                        emptyMessage = 'No completed sessions yet.';
                        break;
                    case 'canceled':
                        emptyIcon = '‚ùå';
                        emptyMessage = 'No canceled sessions.';
                        break;
                }
                
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #999; font-style: italic;">
                        <div style="font-size: 24px; margin-bottom: 10px;">${emptyIcon}</div>
                        <p>${emptyMessage}</p>
                    </div>
                `;
                return;
            }
            
            const now = new Date();
            
            sessionsList.forEach(session => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'event-item';
                sessionItem.style.marginBottom = '15px';
                
                // Get attendees names
                let attendees = '';
                session.attendees.forEach(a => {
                    attendees += members[a].name.split(',')[0] + ', ';
                });
                attendees = attendees.slice(0, -2);
                
                // Time information
                const startTime = new Date(session.startTime);
                const endTime = new Date(session.endTime);
                const duration = Math.round((endTime - startTime) / (1000 * 60));
                
                let status = '';
                let statusColor = '';
                let statusIcon = '';
                let additionalInfo = '';
                let actionButtons = '';
                
                // Always show delete button for admins
                if (userRole === 'admin') {
                    actionButtons = `<button class="btn btn-danger admin-only" onclick="deleteSessionFromMySessions(${session.id})" style="font-size: 12px; padding: 6px 12px; background: #dc3545; margin-top: 10px;">üóëÔ∏è Delete Session</button>`;
                }
                
                if (session.completed) {
                    status = 'Completed';
                    statusColor = '#27ae60';
                    statusIcon = '‚úÖ';
                    
                    if (session.issues && session.issues.length > 0) {
                        additionalInfo = `<div style="color: #e74c3c; margin-top: 8px; padding: 8px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">üìù Issues: ${session.reason}</div>`;
                    } else {
                        additionalInfo = `<div style="color: #27ae60; margin-top: 8px; padding: 8px; background: #e8f5e8; border-left: 4px solid #4caf50; border-radius: 4px;">‚úÖ ${session.reason}</div>`;
                    }
                    
                    if (session.completionDate) {
                        additionalInfo += `<div style="color: #666; font-size: 12px; margin-top: 5px;">Completed: ${session.completionDate}</div>`;
                    }
                    additionalInfo += actionButtons;
                } else if (session.cancelled) {
                    status = 'Canceled';
                    statusColor = '#e74c3c';
                    statusIcon = '‚ùå';
                    additionalInfo = `<div style="color: #e74c3c; margin-top: 8px; padding: 8px; background: #ffebee; border-left: 4px solid #f44336; border-radius: 4px;">‚ùå ${session.cancellationReason}</div>`;
                    
                    if (session.cancellationDate) {
                        additionalInfo += `<div style="color: #666; font-size: 12px; margin-top: 5px;">Canceled: ${session.cancellationDate}</div>`;
                    }
                    additionalInfo += actionButtons;
                } else {
                    // Determine active session status
                    if (startTime > now) {
                        status = 'Upcoming';
                        statusColor = '#3498db';
                        statusIcon = 'üïí';
                    } else if (startTime <= now && now <= endTime) {
                        status = 'In Progress';
                        statusColor = '#9b59b6';
                        statusIcon = '‚ñ∂Ô∏è';
                    } else if (endTime < now) {
                        status = 'Overdue';
                        statusColor = '#f39c12';
                        statusIcon = '‚ö†Ô∏è';
                    } else {
                        status = 'Pending';
                        statusColor = '#f39c12';
                        statusIcon = 'üîÑ';
                    }
                    
                    // Show action buttons for active sessions
                    additionalInfo = `
                        <div style="margin-top: 15px; display: flex; gap: 8px; flex-wrap: wrap;" class="admin-only">
                            <button class="btn btn-success" onclick="completeSession(${session.id})" style="font-size: 12px; padding: 6px 12px;">Complete</button>
                            <button class="btn btn-primary" onclick="manualCompleteSession(${session.id})" style="font-size: 12px; padding: 6px 12px;">Manual Complete</button>
                            <button class="btn btn-warning" onclick="rescheduleSession(${session.id})" style="font-size: 12px; padding: 6px 12px;">Reschedule</button>
                            <button class="btn btn-danger" onclick="cancelSession(${session.id})" style="font-size: 12px; padding: 6px 12px;">Cancel</button>
                            <button class="btn btn-danger" onclick="deleteSessionFromMySessions(${session.id})" style="font-size: 12px; padding: 6px 12px; background: #dc3545;">üóëÔ∏è Delete</button>
                        </div>
                    `;
                    
                    // Show reschedule history if exists
                    if (session.rescheduleHistory && session.rescheduleHistory.length > 0) {
                        additionalInfo += `<div style="color: #007bff; margin-top: 8px; padding: 6px; background: #e3f2fd; border-radius: 4px; font-size: 12px;">üîÑ Rescheduled ${session.rescheduleHistory.length} time(s)</div>`;
                    }
                }
                
                sessionItem.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div>
                            <span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-right: 8px;">${session.category}</span>
                            <strong>${session.name}</strong>
                        </div>
                        <div style="background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap;">
                            ${statusIcon} <span>${status}</span>
                        </div>
                    </div>
                    <div class="event-details">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 8px;">
                            <div><strong>Start:</strong> ${startTime.toLocaleString()}</div>
                            <div><strong>End:</strong> ${endTime.toLocaleString()}</div>
                            <div><strong>Duration:</strong> ${duration} minutes</div>
                            <div><strong>Created:</strong> ${session.createdDate}</div>
                        </div>
                        <div style="margin-bottom: 8px;"><strong>Attendees (${session.attendees.length}):</strong> ${attendees}</div>
                        ${additionalInfo}
                    </div>
                `;
                
                container.appendChild(sessionItem);
            });
        }

        // Function to filter sessions by status
        function filterMySessionsByStatus(status) {
            let filteredSessions;
            
            switch(status) {
                case 'pending':
                    // Show only active sessions (pending, upcoming, in progress, overdue)
                    filteredSessions = sessions.filter(s => !s.completed && !s.cancelled);
                    break;
                case 'completed':
                    filteredSessions = sessions.filter(s => s.completed);
                    break;
                case 'cancelled':
                    filteredSessions = sessions.filter(s => s.cancelled);
                    break;
                default:
                    filteredSessions = sessions;
            }
            
            renderMySessions(filteredSessions);
        }



        // Function to delete session from My Sessions
        function deleteSessionFromMySessions(sessionId) {
            // Check if user has permission to delete sessions
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can delete sessions.');
                return;
            }
            
            const session = sessions.find(s => s.id === sessionId);
            if (!session) {
                alert('Session not found.');
                return;
            }
            
            // Double confirmation for safety
            const confirmMessage = `Are you sure you want to DELETE this session?

"üìÖ ${session.name}"

Category: ${session.category}
Start: ${new Date(session.startTime).toLocaleString()}
Attendees: ${session.attendees.length} members

‚ö†Ô∏è This action cannot be undone!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Second confirmation with typed confirmation
            const typedConfirmation = prompt(`To confirm deletion, type "DELETE SESSION" (case sensitive):`);
            if (typedConfirmation !== 'DELETE SESSION') {
                alert('Deletion cancelled. Text did not match.');
                return;
            }
            
            try {
                // Remove session from sessions array
                const sessionIndex = sessions.findIndex(s => s.id === sessionId);
                if (sessionIndex === -1) {
                    alert('Session not found in database.');
                    return;
                }
                
                // Store session info for recently deleted (optional)
                const deletedSession = sessions[sessionIndex];
                
                // Remove associated issues from member records
                if (deletedSession.issues && deletedSession.issues.length > 0) {
                    deletedSession.issues.forEach(issue => {
                        const member = members[issue.memberId];
                        if (member) {
                            // Decrease member stats
                            if (issue.type === 'tardy') {
                                member.tardiness = Math.max(0, member.tardiness - 1);
                            } else if (issue.type === 'absent') {
                                member.absences = Math.max(0, member.absences - 1);
                            } else if (issue.type === 'missed_activity') {
                                member.missedActivities = Math.max(0, member.missedActivities - 1);
                            } else if (issue.type === 'late_submission') {
                                member.lateSubmissions = Math.max(0, member.lateSubmissions - 1);
                            }
                            
                            // Remove from attendance records
                            if (member.attendanceRecords) {
                                member.attendanceRecords = member.attendanceRecords.filter(record => {
                                    // Remove records that match this session and issue type
                                    return !(record.sessionName === deletedSession.name && 
                                           record.type === issue.type && 
                                           record.reason === issue.reason);
                                });
                            }
                            
                            // Recalculate deductions
                            const autoDeductions = member.tardiness * 0.5 + 
                                                  member.absences * 1 + 
                                                  member.missedActivities * 1.5 + 
                                                  member.lateSubmissions * 0.5;
                            const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
                            member.deductions = autoDeductions + manualDeductions;
                        }
                    });
                }
                
                // Remove the session
                sessions.splice(sessionIndex, 1);
                
                // Update local storage
                saveToLocalStorage();
                
                // Refresh the My Sessions view
                updateMySessionsOverview();
                
                // Also refresh the main sessions view if visible
                if (document.getElementById('sessions-tab').style.display !== 'none') {
                    renderSessions();
                }
                
                // Show success message
                const issuesCount = deletedSession.issues ? deletedSession.issues.length : 0;
                let successMessage = `‚úÖ Session "${deletedSession.name}" has been successfully deleted.`;
                if (issuesCount > 0) {
                    successMessage += `\n\nüóëÔ∏è Also removed ${issuesCount} associated issue record(s) from member attendance history.`;
                }
                alert(successMessage);
                
                console.log('Session deleted:', deletedSession);
                
            } catch (error) {
                console.error('Error deleting session:', error);
                alert('‚ùå Error deleting session. Please try again.');
            }
        }

        // Function to show bulk delete options
        function showBulkDeleteOptions() {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can bulk delete sessions.');
                return;
            }
            
            if (sessions.length === 0) {
                alert('No sessions available to delete.');
                return;
            }
            
            const options = [
                'Delete all completed sessions',
                'Delete all cancelled sessions',
                'Delete all pending sessions',
                'Delete sessions older than 30 days',
                'Delete sessions older than 90 days',
                'Cancel'
            ];
            
            let choice = prompt('üóëÔ∏è Bulk Delete Options:\n\n' + options.map((opt, i) => (i + 1) + '. ' + opt).join('\n') + '\n\nEnter option number (1-' + options.length + '):');
            
            if (!choice || choice === options.length.toString() || choice.toLowerCase() === 'cancel') {
                return;
            }
            
            choice = parseInt(choice);
            if (isNaN(choice) || choice < 1 || choice > options.length - 1) {
                alert('Invalid option selected.');
                return;
            }
            
            let sessionsToDelete = [];
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            const ninetyDaysAgo = new Date(now.getTime() - (90 * 24 * 60 * 60 * 1000));
            
            switch(choice) {
                case 1: // Delete all completed sessions
                    sessionsToDelete = sessions.filter(s => s.completed);
                    break;
                case 2: // Delete all cancelled sessions
                    sessionsToDelete = sessions.filter(s => s.cancelled);
                    break;
                case 3: // Delete all pending sessions
                    sessionsToDelete = sessions.filter(s => !s.completed && !s.cancelled);
                    break;
                case 4: // Delete sessions older than 30 days
                    sessionsToDelete = sessions.filter(s => new Date(s.startTime) < thirtyDaysAgo);
                    break;
                case 5: // Delete sessions older than 90 days
                    sessionsToDelete = sessions.filter(s => new Date(s.startTime) < ninetyDaysAgo);
                    break;
            }
            
            if (sessionsToDelete.length === 0) {
                alert('üí≠ No sessions match the selected criteria.');
                return;
            }
            
            const confirmMessage = '‚ö†Ô∏è BULK DELETE CONFIRMATION\n\nYou are about to delete ' + sessionsToDelete.length + ' session(s):\n"' + options[choice - 1] + '"\n\nThis action cannot be undone!\n\nProceed with deletion?';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Final typed confirmation
            const typedConfirmation = prompt('To confirm bulk deletion of ' + sessionsToDelete.length + ' sessions, type "BULK DELETE" (case sensitive):');
            if (typedConfirmation !== 'BULK DELETE') {
                alert('Bulk deletion cancelled. Text did not match.');
                return;
            }
            
            try {
                // Remove sessions and their associated issues
                sessionsToDelete.forEach(sessionToDelete => {
                    // Remove associated issues from member records first
                    if (sessionToDelete.issues && sessionToDelete.issues.length > 0) {
                        sessionToDelete.issues.forEach(issue => {
                            const member = members[issue.memberId];
                            if (member) {
                                // Decrease member stats
                                if (issue.type === 'tardy') {
                                    member.tardiness = Math.max(0, member.tardiness - 1);
                                } else if (issue.type === 'absent') {
                                    member.absences = Math.max(0, member.absences - 1);
                                } else if (issue.type === 'missed_activity') {
                                    member.missedActivities = Math.max(0, member.missedActivities - 1);
                                } else if (issue.type === 'late_submission') {
                                    member.lateSubmissions = Math.max(0, member.lateSubmissions - 1);
                                }
                                
                                // Remove from attendance records
                                if (member.attendanceRecords) {
                                    member.attendanceRecords = member.attendanceRecords.filter(record => {
                                        // Remove records that match this session and issue type
                                        return !(record.sessionName === sessionToDelete.name && 
                                               record.type === issue.type && 
                                               record.reason === issue.reason);
                                    });
                                }
                                
                                // Recalculate deductions
                                const autoDeductions = member.tardiness * 0.5 + 
                                                      member.absences * 1 + 
                                                      member.missedActivities * 1.5 + 
                                                      member.lateSubmissions * 0.5;
                                const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
                                member.deductions = autoDeductions + manualDeductions;
                            }
                        });
                    }
                    
                    // Remove the session from sessions array
                    const index = sessions.findIndex(s => s.id === sessionToDelete.id);
                    if (index !== -1) {
                        sessions.splice(index, 1);
                    }
                });
                
                // Update local storage
                saveToLocalStorage();
                
                // Refresh views
                updateMySessionsOverview();
                if (document.getElementById('sessions-tab').style.display !== 'none') {
                    renderSessions();
                }
                
                // Count total issues cleaned up
                let totalIssuesRemoved = 0;
                sessionsToDelete.forEach(session => {
                    if (session.issues && session.issues.length > 0) {
                        totalIssuesRemoved += session.issues.length;
                    }
                });
                
                let successMessage = `‚úÖ Successfully deleted ${sessionsToDelete.length} sessions.`;
                if (totalIssuesRemoved > 0) {
                    successMessage += `\n\nüóëÔ∏è Also removed ${totalIssuesRemoved} associated issue record(s) from member attendance histories.`;
                }
                alert(successMessage);
                
            } catch (error) {
                console.error('Error in bulk delete:', error);
                alert('‚ùå Error during bulk deletion. Some sessions may not have been deleted.');
            }
        }

        // Function to delete completed sessions only
        function deleteCompletedSessions() {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can delete sessions.');
                return;
            }
            
            const completedSessions = sessions.filter(s => s.completed);
            
            if (completedSessions.length === 0) {
                alert('üí≠ No completed sessions found to delete.');
                return;
            }
            
            const confirmMessage = '‚ö†Ô∏è Delete Completed Sessions\n\nYou are about to delete ' + completedSessions.length + ' completed session(s).\n\nThis action cannot be undone!\n\nProceed with deletion?';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Final typed confirmation
            const typedConfirmation = prompt('To confirm deletion of ' + completedSessions.length + ' completed sessions, type "DELETE COMPLETED" (case sensitive):');
            if (typedConfirmation !== 'DELETE COMPLETED') {
                alert('Deletion cancelled. Text did not match.');
                return;
            }
            
            try {
                // Remove completed sessions and their associated issues
                completedSessions.forEach(sessionToDelete => {
                    // Remove associated issues from member records first
                    if (sessionToDelete.issues && sessionToDelete.issues.length > 0) {
                        sessionToDelete.issues.forEach(issue => {
                            const member = members[issue.memberId];
                            if (member) {
                                // Decrease member stats
                                if (issue.type === 'tardy') {
                                    member.tardiness = Math.max(0, member.tardiness - 1);
                                } else if (issue.type === 'absent') {
                                    member.absences = Math.max(0, member.absences - 1);
                                } else if (issue.type === 'missed_activity') {
                                    member.missedActivities = Math.max(0, member.missedActivities - 1);
                                } else if (issue.type === 'late_submission') {
                                    member.lateSubmissions = Math.max(0, member.lateSubmissions - 1);
                                }
                                
                                // Remove from attendance records
                                if (member.attendanceRecords) {
                                    member.attendanceRecords = member.attendanceRecords.filter(record => {
                                        // Remove records that match this session and issue type
                                        return !(record.sessionName === sessionToDelete.name && 
                                               record.type === issue.type && 
                                               record.reason === issue.reason);
                                    });
                                }
                                
                                // Recalculate deductions
                                const autoDeductions = member.tardiness * 0.5 + 
                                                      member.absences * 1 + 
                                                      member.missedActivities * 1.5 + 
                                                      member.lateSubmissions * 0.5;
                                const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
                                member.deductions = autoDeductions + manualDeductions;
                            }
                        });
                    }
                    
                    // Remove the session from sessions array
                    const index = sessions.findIndex(s => s.id === sessionToDelete.id);
                    if (index !== -1) {
                        sessions.splice(index, 1);
                    }
                });
                
                // Update local storage
                saveToLocalStorage();
                
                // Refresh views
                updateMySessionsOverview();
                if (document.getElementById('sessions-tab').style.display !== 'none') {
                    renderSessions();
                }
                
                // Count total issues cleaned up
                let totalIssuesRemoved = 0;
                completedSessions.forEach(session => {
                    if (session.issues && session.issues.length > 0) {
                        totalIssuesRemoved += session.issues.length;
                    }
                });
                
                let successMessage = `‚úÖ Successfully deleted ${completedSessions.length} completed sessions.`;
                if (totalIssuesRemoved > 0) {
                    successMessage += `\n\nüóëÔ∏è Also removed ${totalIssuesRemoved} associated issue record(s) from member attendance histories.`;
                }
                alert(successMessage);
                
            } catch (error) {
                console.error('Error deleting completed sessions:', error);
                alert('‚ùå Error deleting completed sessions. Please try again.');
            }
        }

        // Function for selective delete of completed and cancelled sessions
        function selectiveDeleteCompleted() {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can delete sessions.');
                return;
            }
            
            // Debug: log all sessions to see their status
            console.log('All sessions:', sessions);
            console.log('Sessions count:', sessions.length);
            
            // Get both completed and cancelled sessions
            const deletableSessions = sessions.filter(s => s.completed || s.cancelled);
            
            // Debug: log filtered sessions
            console.log('Deletable sessions:', deletableSessions);
            console.log('Deletable sessions count:', deletableSessions.length);
            
            if (deletableSessions.length === 0) {
                alert('üí≠ No completed or cancelled sessions found to select from.\n\nDebug info: Total sessions = ' + sessions.length);
                return;
            }
            
            // Create selection modal
            showSelectiveDeleteModal(deletableSessions);
        }

        // Function to show selective delete modal
        function showSelectiveDeleteModal(deletableSessions) {
            // Create modal HTML
            const modalHTML = `
                <div id="selective-delete-modal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h2>‚òëÔ∏è Select Sessions to Delete</h2>
                            <span class="close" onclick="closeSelectiveDeleteModal()">&times;</span>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                <strong>‚ö†Ô∏è Warning:</strong> Selected sessions will be permanently deleted. This action cannot be undone!
                            </p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                                <button class="btn btn-primary" onclick="selectAllDeletableSessions(true)" style="font-size: 12px;">Select All</button>
                                <button class="btn" onclick="selectAllDeletableSessions(false)" style="font-size: 12px;">Deselect All</button>
                                <span id="selected-count" style="margin-left: 15px; color: #666; font-weight: bold;">0 selected</span>
                            </div>
                        </div>
                        
                        <div id="deletable-sessions-list" style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 15px;">
                            <!-- Sessions will be populated here -->
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-danger" onclick="deleteSelectedSessions()" style="margin-right: 10px;">üóëÔ∏è Delete Selected</button>
                            <button class="btn" onclick="closeSelectiveDeleteModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('selective-delete-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Populate sessions list
            populateDeletableSessionsList(deletableSessions);
        }

        // Function to populate deletable sessions list with checkboxes
        function populateDeletableSessionsList(deletableSessions) {
            console.log('populateDeletableSessionsList called with:', deletableSessions);
            const listContainer = document.getElementById('deletable-sessions-list');
            console.log('List container found:', listContainer);
            
            // Clear existing content first
            listContainer.innerHTML = '';
            
            // Check if there are no deletable sessions
            if (deletableSessions.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 30px; color: #999; font-style: italic;"><div style="font-size: 24px; margin-bottom: 10px;">üì≠</div><p>No completed or cancelled sessions found.</p></div>';
                return;
            }
            
            // Sort sessions by completion/cancellation date (newest first)
            const sortedSessions = [...deletableSessions].sort((a, b) => {
                const dateA = new Date(a.completionDate || a.cancellationDate || a.createdDate);
                const dateB = new Date(b.completionDate || b.cancellationDate || b.createdDate);
                return dateB - dateA;
            });
            
            sortedSessions.forEach(session => {
                const sessionDiv = document.createElement('div');
                sessionDiv.className = 'event-item';
                sessionDiv.style.cssText = 'margin-bottom: 10px; border: 1px solid #e0e0e0; border-radius: 6px; padding: 15px; background: #f9f9f9;';
                
                // Get attendees names safely
                let attendees = '';
                if (session.attendees && session.attendees.length > 0) {
                    session.attendees.forEach(a => {
                        if (members[a] && members[a].name) {
                            attendees += members[a].name.split(',')[0] + ', ';
                        }
                    });
                    attendees = attendees.slice(0, -2) || 'No attendees';
                } else {
                    attendees = 'No attendees';
                }
                
                // Determine session status and styling
                let statusIcon, statusColor, statusText, statusDate;
                if (session.cancelled) {
                    statusIcon = '‚ùå';
                    statusColor = '#e74c3c';
                    statusText = 'Cancelled';
                    statusDate = session.cancellationDate || 'Date not recorded';
                } else if (session.completed) {
                    const hasIssues = session.issues && session.issues.length > 0;
                    statusIcon = hasIssues ? 'üìã' : '‚úÖ';
                    statusColor = hasIssues ? '#e74c3c' : '#27ae60';
                    statusText = hasIssues ? 'Completed (Had Issues)' : 'Completed (No Issues)';
                    statusDate = session.completionDate || 'Date not recorded';
                }
                
                sessionDiv.innerHTML = `
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <label style="margin-top: 5px;">
                            <input type="checkbox" class="session-checkbox" data-session-id="${session.id}" onchange="updateSelectedCount()" style="transform: scale(1.2);">
                        </label>
                        
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <div>
                                    <span style="background: #3498db; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-right: 8px;">${session.category}</span>
                                    <strong>${session.name}</strong>
                                </div>
                                <div style="color: ${statusColor}; font-weight: bold; font-size: 12px;">
                                    ${statusIcon} ${statusText}
                                </div>
                            </div>
                            
                            <div style="font-size: 13px; color: #666; line-height: 1.4;">
                                <div><strong>Status Date:</strong> ${statusDate}</div>
                                <div><strong>Originally scheduled:</strong> ${new Date(session.startTime).toLocaleString()}</div>
                                <div><strong>Attendees (${session.attendees ? session.attendees.length : 0}):</strong> ${attendees}</div>
                                ${session.reason ? `<div style="color: ${statusColor}; margin-top: 5px;"><strong>Reason:</strong> ${session.reason}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                listContainer.appendChild(sessionDiv);
            });
            
            // Initial count update
            updateSelectedCount();
        }

        // Function to update selected count
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.session-checkbox');
            const selectedCheckboxes = document.querySelectorAll('.session-checkbox:checked');
            const countElement = document.getElementById('selected-count');
            
            if (countElement) {
                countElement.textContent = `${selectedCheckboxes.length} of ${checkboxes.length} selected`;
                countElement.style.color = selectedCheckboxes.length > 0 ? '#e74c3c' : '#666';
            }
        }

        // Function to select/deselect all deletable sessions
        function selectAllDeletableSessions(selectAll) {
            const checkboxes = document.querySelectorAll('.session-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            updateSelectedCount();
        }

        // Function to delete selected sessions
        function deleteSelectedSessions() {
            const selectedCheckboxes = document.querySelectorAll('.session-checkbox:checked');
            
            if (selectedCheckboxes.length === 0) {
                alert('üí≠ Please select at least one session to delete.');
                return;
            }
            
            const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.sessionId));
            const selectedSessions = sessions.filter(s => selectedIds.includes(s.id));
            
            const confirmMessage = `‚ö†Ô∏è SELECTIVE DELETE CONFIRMATION

You are about to delete ${selectedSessions.length} selected session(s):

` + 
                selectedSessions.map(s => {
                    const status = s.cancelled ? 'Cancelled' : 'Completed';
                    return `‚Ä¢ ${s.name} (${s.category}) - ${status}`;
                }).join('\n') + 
                '\n\nThis action cannot be undone!\n\nProceed with deletion?';
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Final typed confirmation
            const typedConfirmation = prompt('To confirm deletion of ' + selectedSessions.length + ' selected sessions, type "DELETE SELECTED" (case sensitive):');
            if (typedConfirmation !== 'DELETE SELECTED') {
                alert('Deletion cancelled. Text did not match.');
                return;
            }
            
            try {
                // Remove selected sessions and their associated issues
                selectedIds.forEach(sessionId => {
                    // Find the session to delete
                    const sessionToDelete = sessions.find(s => s.id === sessionId);
                    
                    if (sessionToDelete) {
                        // Remove associated issues from member records first
                        if (sessionToDelete.issues && sessionToDelete.issues.length > 0) {
                            sessionToDelete.issues.forEach(issue => {
                                const member = members[issue.memberId];
                                if (member) {
                                    // Decrease member stats
                                    if (issue.type === 'tardy') {
                                        member.tardiness = Math.max(0, member.tardiness - 1);
                                    } else if (issue.type === 'absent') {
                                        member.absences = Math.max(0, member.absences - 1);
                                    } else if (issue.type === 'missed_activity') {
                                        member.missedActivities = Math.max(0, member.missedActivities - 1);
                                    } else if (issue.type === 'late_submission') {
                                        member.lateSubmissions = Math.max(0, member.lateSubmissions - 1);
                                    }
                                    
                                    // Remove from attendance records
                                    if (member.attendanceRecords) {
                                        member.attendanceRecords = member.attendanceRecords.filter(record => {
                                            // Remove records that match this session and issue type
                                            return !(record.sessionName === sessionToDelete.name && 
                                                   record.type === issue.type && 
                                                   record.reason === issue.reason);
                                        });
                                    }
                                    
                                    // Recalculate deductions
                                    const autoDeductions = member.tardiness * 0.5 + 
                                                          member.absences * 1 + 
                                                          member.missedActivities * 1.5 + 
                                                          member.lateSubmissions * 0.5;
                                    const manualDeductions = (member.deductionRecords || []).reduce((total, record) => total + record.amount, 0);
                                    member.deductions = autoDeductions + manualDeductions;
                                }
                            });
                        }
                    }
                    
                    // Remove the session from sessions array
                    const index = sessions.findIndex(s => s.id === sessionId);
                    if (index !== -1) {
                        sessions.splice(index, 1);
                    }
                });
                
                // Update local storage
                saveToLocalStorage();
                
                // Close modal
                closeSelectiveDeleteModal();
                
                // Refresh views
                updateMySessionsOverview();
                if (document.getElementById('sessions-tab').style.display !== 'none') {
                    renderSessions();
                }
                
                // Count total issues cleaned up
                let totalIssuesRemoved = 0;
                selectedSessions.forEach(session => {
                    if (session.issues && session.issues.length > 0) {
                        totalIssuesRemoved += session.issues.length;
                    }
                });
                
                let successMessage = `‚úÖ Successfully deleted ${selectedSessions.length} selected sessions.`;
                if (totalIssuesRemoved > 0) {
                    successMessage += `\n\nüóëÔ∏è Also removed ${totalIssuesRemoved} associated issue record(s) from member attendance histories.`;
                }
                alert(successMessage);
                
            } catch (error) {
                console.error('Error deleting selected sessions:', error);
                alert('‚ùå Error deleting selected sessions. Please try again.');
            }
        }

        // Function to close selective delete modal
        function closeSelectiveDeleteModal() {
            const modal = document.getElementById('selective-delete-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Function to update contribution summary
        function updateContributionSummary() {
            const summaryContainer = document.getElementById('contribution-summary-content');
            
            if (contributions.length === 0) {
                summaryContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No contributions found.</p>';
                return;
            }

            const totalMembers = Object.keys(members).length;
            let totalContributions = 0;
            let totalCollected = 0;
            let summaryHTML = '';

            // Overview statistics
            contributions.forEach(contribution => {
                totalContributions += contribution.amount;
                
                Object.keys(members).forEach(memberId => {
                    const member = members[memberId];
                    const payment = member.payments.find(p => p.contributionId === contribution.id);
                    if (payment) {
                        totalCollected += (payment.partialAmount || 0);
                    }
                });
            });

            const perMemberTotal = totalContributions / totalMembers;
            
            summaryHTML += `
                <div style="background: linear-gradient(135deg, #3498db, #2c3e50); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 15px 0; text-align: center;">üìä Financial Overview</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">‚Ç±${totalContributions.toFixed(2)}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Total Contributions</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">‚Ç±${perMemberTotal.toFixed(2)}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Per Member Share</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">‚Ç±${totalCollected.toFixed(2)}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Total Collected</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: bold;">${totalMembers}</div>
                            <div style="font-size: 14px; opacity: 0.9;">Members</div>
                        </div>
                    </div>
                </div>
            `;

            // Individual contribution breakdown
            summaryHTML += '<h3 style="margin-bottom: 15px;">üí∞ Contribution Breakdown</h3>';
            
            contributions.forEach(contribution => {
                const perMemberAmount = contribution.amount / totalMembers;
                let paidCount = 0;
                let partialCount = 0;
                let totalPaidForContribution = 0;
                
                Object.keys(members).forEach(memberId => {
                    const member = members[memberId];
                    const payment = member.payments.find(p => p.contributionId === contribution.id);
                    if (payment) {
                        totalPaidForContribution += (payment.partialAmount || 0);
                        if (payment.paid) {
                            paidCount++;
                        } else if (payment.partialAmount > 0) {
                            partialCount++;
                        }
                    }
                });
                
                const progressPercentage = (totalPaidForContribution / contribution.amount) * 100;
                const deadlineDate = new Date(contribution.deadline);
                const isOverdue = deadlineDate < new Date();
                
                summaryHTML += `
                    <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div>
                                <h4 style="margin: 0 0 5px 0; color: #2c3e50;">${contribution.purpose}</h4>
                                <div style="font-size: 14px; color: #666;">Total: ‚Ç±${contribution.amount.toFixed(2)} | Per Member: ‚Ç±${perMemberAmount.toFixed(2)}</div>
                                <div style="font-size: 14px; color: ${isOverdue ? '#e74c3c' : '#27ae60'}; font-weight: bold;">Deadline: ${deadlineDate.toLocaleDateString()}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: bold; color: #27ae60;">‚Ç±${totalPaidForContribution.toFixed(2)}</div>
                                <div style="font-size: 14px; color: #666;">Collected</div>
                            </div>
                        </div>
                        
                        <div style="background: #ecf0f1; border-radius: 10px; height: 8px; margin-bottom: 10px; overflow: hidden;">
                            <div style="background: ${progressPercentage >= 100 ? '#27ae60' : progressPercentage >= 50 ? '#f39c12' : '#e74c3c'}; height: 100%; width: ${Math.min(progressPercentage, 100)}%; transition: width 0.3s ease;"></div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; font-size: 14px;">
                            <span style="color: #27ae60;">‚úÖ Paid: ${paidCount}</span>
                            <span style="color: #f39c12;">üîÑ Partial: ${partialCount}</span>
                            <span style="color: #e74c3c;">‚ùå Unpaid: ${totalMembers - paidCount - partialCount}</span>
                            <span style="color: #3498db;">${progressPercentage.toFixed(1)}% Complete</span>
                        </div>
                    </div>
                `;
            });

            // Member payment status
            summaryHTML += '<h3 style="margin: 25px 0 15px 0;">üë• Member Payment Status</h3>';
            summaryHTML += '<div style="overflow-x: auto;">';
            summaryHTML += '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
            
            // Table header
            summaryHTML += '<thead><tr style="background: #34495e; color: white;">';
            summaryHTML += '<th style="padding: 12px; text-align: left;">Member</th>';
            contributions.forEach(contribution => {
                summaryHTML += `<th style="padding: 12px; text-align: center; min-width: 120px;">${contribution.purpose.substring(0, 20)}${contribution.purpose.length > 20 ? '...' : ''}</th>`;
            });
            summaryHTML += '<th style="padding: 12px; text-align: center;">Total Paid</th>';
            summaryHTML += '<th style="padding: 12px; text-align: center;">Total Due</th>';
            summaryHTML += '</tr></thead><tbody>';
            
            // Table rows
            Object.keys(members).forEach((memberId, index) => {
                const member = members[memberId];
                let memberTotalPaid = 0;
                let memberTotalDue = 0;
                
                summaryHTML += `<tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-bottom: 1px solid #eee;">`;
                summaryHTML += `<td style="padding: 12px; font-weight: bold;">${member.name}</td>`;
                
                contributions.forEach(contribution => {
                    const perMemberAmount = contribution.amount / totalMembers;
                    const payment = member.payments.find(p => p.contributionId === contribution.id);
                    const paidAmount = payment ? (payment.partialAmount || 0) : 0;
                    
                    memberTotalPaid += paidAmount;
                    memberTotalDue += perMemberAmount;
                    
                    let statusIcon = '';
                    let statusColor = '';
                    
                    if (payment && payment.paid) {
                        statusIcon = '‚úÖ';
                        statusColor = '#27ae60';
                    } else if (paidAmount > 0) {
                        statusIcon = 'üîÑ';
                        statusColor = '#f39c12';
                    } else {
                        statusIcon = '‚ùå';
                        statusColor = '#e74c3c';
                    }
                    
                    summaryHTML += `<td style="padding: 12px; text-align: center; color: ${statusColor};">${statusIcon}<br>‚Ç±${paidAmount.toFixed(2)}</td>`;
                });
                
                summaryHTML += `<td style="padding: 12px; text-align: center; font-weight: bold; color: #27ae60;">‚Ç±${memberTotalPaid.toFixed(2)}</td>`;
                summaryHTML += `<td style="padding: 12px; text-align: center; font-weight: bold; color: #3498db;">‚Ç±${memberTotalDue.toFixed(2)}</td>`;
                summaryHTML += '</tr>';
            });
            
            summaryHTML += '</tbody></table></div>';

            // Expenses Summary Section
            summaryHTML += '<h3 style="margin: 25px 0 15px 0;">üí∏ Expenses Summary</h3>';
            
            if (expenses.length === 0) {
                summaryHTML += '<p style="text-align: center; color: #666; padding: 40px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">No expenses recorded yet.</p>';
            } else {
                // Calculate expense totals by category
                let totalExpenses = 0;
                const categoryTotals = {};
                
                expenses.forEach(expense => {
                    totalExpenses += expense.amount;
                    if (categoryTotals[expense.category]) {
                        categoryTotals[expense.category] += expense.amount;
                    } else {
                        categoryTotals[expense.category] = expense.amount;
                    }
                });
                
                // Calculate remaining budget
                const budgetRemaining = totalCollected - totalExpenses;
                
                // Overview statistics for expenses
                summaryHTML += `
                    <div style="background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; text-align: center;">
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">‚Ç±${totalExpenses.toFixed(2)}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Total Spent</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">‚Ç±${budgetRemaining.toFixed(2)}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Budget Remaining</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">${expenses.length}</div>
                                <div style="font-size: 14px; opacity: 0.9;">Total Transactions</div>
                            </div>
                            <div>
                                <div style="font-size: 24px; font-weight: bold;">${totalCollected > 0 ? ((totalExpenses / totalCollected) * 100).toFixed(1) : 0}%</div>
                                <div style="font-size: 14px; opacity: 0.9;">Budget Utilized</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Category breakdown
                summaryHTML += '<h4 style="margin-bottom: 15px;">üìä Expenses by Category</h4>';
                summaryHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">';
                
                const categoryColors = {
                    'supplies': '#3498db',
                    'food': '#e67e22',
                    'transportation': '#9b59b6',
                    'materials': '#27ae60',
                    'other': '#95a5a6'
                };
                
                Object.entries(categoryTotals).forEach(([category, total]) => {
                    const percentage = totalExpenses > 0 ? ((total / totalExpenses) * 100).toFixed(1) : 0;
                    const color = categoryColors[category] || '#95a5a6';
                    const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                    
                    summaryHTML += `
                        <div style="background: white; border: 1px solid ${color}; border-radius: 8px; padding: 15px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                            <div style="font-size: 18px; font-weight: bold; color: ${color}; margin-bottom: 5px;">‚Ç±${total.toFixed(2)}</div>
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">${categoryName}</div>
                            <div style="font-size: 12px; color: ${color}; font-weight: bold;">${percentage}% of total</div>
                        </div>
                    `;
                });
                
                summaryHTML += '</div>';
                
                // Recent expenses table
                summaryHTML += '<h4 style="margin-bottom: 15px;">üìã Recent Expenses</h4>';
                summaryHTML += '<div style="overflow-x: auto;">';
                summaryHTML += '<table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
                
                // Table header
                summaryHTML += `
                    <thead>
                        <tr style="background: #e74c3c; color: white;">
                            <th style="padding: 12px; text-align: left;">Date</th>
                            <th style="padding: 12px; text-align: left;">Description</th>
                            <th style="padding: 12px; text-align: left;">Category</th>
                            <th style="padding: 12px; text-align: right;">Amount</th>
                            <th style="padding: 12px; text-align: left;">Added By</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                
                // Sort expenses by date (newest first) and show last 10
                const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 10);
                
                sortedExpenses.forEach((expense, index) => {
                    const expenseDate = new Date(expense.date);
                    const categoryName = expense.category.charAt(0).toUpperCase() + expense.category.slice(1);
                    const categoryColor = categoryColors[expense.category] || '#95a5a6';
                    const addedBy = expense.addedBy || expense.memberRequest ? expense.addedBy || 'Member Request' : 'Admin';
                    
                    summaryHTML += `
                        <tr style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; border-bottom: 1px solid #eee;">
                            <td style="padding: 12px; font-weight: bold;">${expenseDate.toLocaleDateString()}</td>
                            <td style="padding: 12px;">${expense.description}</td>
                            <td style="padding: 12px;">
                                <span style="background: ${categoryColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                                    ${categoryName}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: right; font-weight: bold; color: #e74c3c;">‚Ç±${expense.amount.toFixed(2)}</td>
                            <td style="padding: 12px; color: #666;">${addedBy}</td>
                        </tr>
                    `;
                });
                
                summaryHTML += '</tbody></table></div>';
                
                if (expenses.length > 10) {
                    summaryHTML += `<p style="text-align: center; color: #666; margin-top: 10px; font-style: italic;">Showing 10 most recent expenses (${expenses.length} total)</p>`;
                }
            }
            
            summaryContainer.innerHTML = summaryHTML;
        }

        // Function to switch between tabs
        function switchTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            const targetTab = document.getElementById(`${tabName}-tab`);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            // Update active tab button
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find and activate the clicked tab button
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(button => {
                if (button.onclick && button.onclick.toString().includes(`'${tabName}'`)) {
                    button.classList.add('active');
                }
            });
        }

        // Function to open event modal
        function openEventModal() {
            document.getElementById('event-modal').style.display = 'flex';
        }

        // Function to close event modal
        function closeEventModal() {
            document.getElementById('event-modal').style.display = 'none';
        }

        // Function to open meeting modal
        function openMeetingModal() {
            document.getElementById('meeting-modal').style.display = 'flex';
        }

        // Function to close meeting modal
        function closeMeetingModal() {
            document.getElementById('meeting-modal').style.display = 'none';
        }

        // Function to open contribution modal
        function openContributionModal() {
            // Reset form and modal state
            editingContributionId = null;
            document.getElementById('contribution-modal-title').textContent = 'Money Contributions';
            document.getElementById('save-contribution-btn').textContent = 'Save Contribution';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('per-member-display').innerHTML = '';
            
            // Clear form
            document.getElementById('contribution-amount').value = '';
            document.getElementById('contribution-purpose').value = '';
            document.getElementById('contribution-deadline').value = '';
            
            document.getElementById('contribution-modal').style.display = 'flex';
        }

        // Function to close contribution modal
        function closeContributionModal() {
            editingContributionId = null;
            document.getElementById('contribution-modal').style.display = 'none';
            
            // Reset modal state
            document.getElementById('contribution-modal-title').textContent = 'Money Contributions';
            document.getElementById('save-contribution-btn').textContent = 'Save Contribution';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            document.getElementById('per-member-display').innerHTML = '';
            
            // Clear form
            document.getElementById('contribution-amount').value = '';
            document.getElementById('contribution-purpose').value = '';
            document.getElementById('contribution-deadline').value = '';
        }

        // Function to select all members for event or meeting
        function selectAll(type) {
            const checkboxes = document.querySelectorAll(`#${type}-modal input[type="checkbox"]`);
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
            });
        }

        // Function to save event
        function saveEvent() {
            const name = document.getElementById('event-name').value;
            const deadline = document.getElementById('event-deadline').value;
            
            if (!name || !deadline) {
                alert('Please fill in all fields');
                return;
            }

            const participants = [];
            if (document.getElementById('event-patalinghug').checked) participants.push('patalinghug');
            if (document.getElementById('event-abon').checked) participants.push('abon');
            if (document.getElementById('event-caritativo').checked) participants.push('caritativo');
            if (document.getElementById('event-delossantos').checked) participants.push('delossantos');
            if (document.getElementById('event-martos').checked) participants.push('martos');

            if (participants.length === 0) {
                alert('Please select at least one participant');
                return;
            }

            const event = {
                id: Date.now(),
                name,
                deadline,
                participants,
                completed: false,
                missed: [],
                late: []
            };

            events.push(event);
            renderEvents();
            closeEventModal();

            // Clear form
            document.getElementById('event-name').value = '';
            document.getElementById('event-deadline').value = '';
            document.querySelectorAll('#event-modal input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Function to save meeting
        function saveMeeting() {
            const type = document.getElementById('meeting-type').value;
            const typeText = type === 'group-discussion' ? 'Group Discussion' : 'Paper Making';
            
            const attendees = [];
            if (document.getElementById('meeting-patalinghug').checked) attendees.push('patalinghug');
            if (document.getElementById('meeting-abon').checked) attendees.push('abon');
            if (document.getElementById('meeting-caritativo').checked) attendees.push('caritativo');
            if (document.getElementById('meeting-delossantos').checked) attendees.push('delossantos');
            if (document.getElementById('meeting-martos').checked) attendees.push('martos');

            if (attendees.length === 0) {
                alert('Please select at least one attendee');
                return;
            }

            const meeting = {
                id: Date.now(),
                type: typeText,
                date: new Date().toLocaleString(),
                attendees,
                completed: false,
                tardy: [],
                absent: []
            };

            meetings.push(meeting);
            renderMeetings();
            closeMeetingModal();

            // Clear form
            document.getElementById('meeting-type').value = 'group-discussion';
            document.querySelectorAll('#meeting-modal input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // Function to save contribution
        let editingContributionId = null;
        
        function saveContribution() {
            const amount = document.getElementById('contribution-amount').value;
            const purpose = document.getElementById('contribution-purpose').value;
            const deadline = document.getElementById('contribution-deadline').value;
            
            if (!amount || !purpose || !deadline) {
                alert('Please fill in all fields');
                return;
            }

            if (parseFloat(amount) <= 0) {
                alert('Please enter a valid amount greater than 0');
                return;
            }

            // Calculate rounded per-member amount and adjust total
            const totalMembers = Object.keys(members).length;
            const rawPerMember = parseFloat(amount) / totalMembers;
            const roundedPerMember = Math.ceil(rawPerMember);
            const adjustedTotalAmount = roundedPerMember * totalMembers;

            if (editingContributionId) {
                // Update existing contribution
                const contribution = contributions.find(c => c.id === editingContributionId);
                if (contribution) {
                    contribution.amount = adjustedTotalAmount;
                    contribution.purpose = purpose;
                    contribution.deadline = deadline;
                    contribution.editedDate = new Date().toLocaleString();
                }
                editingContributionId = null;
            } else {
                // Create new contribution
                const contribution = {
                    id: Date.now(),
                    amount: adjustedTotalAmount,
                    purpose,
                    deadline,
                    createdDate: new Date().toLocaleString()
                };
                contributions.push(contribution);
            }

            // Show confirmation message with details
            const originalAmount = parseFloat(amount);
            if (originalAmount !== adjustedTotalAmount) {
                alert(`Contribution saved successfully!

üí∞ Your entered amount: ‚Ç±${originalAmount.toFixed(2)}
üîÑ Adjusted amount: ‚Ç±${adjustedTotalAmount.toFixed(2)}
üë• Per member: ‚Ç±${roundedPerMember.toFixed(2)} each (${totalMembers} members)

‚ú® The system automatically adjusted the total to ensure each member contributes a whole number amount.`);
            } else {
                alert(`Contribution saved successfully!

üí∞ Total amount: ‚Ç±${adjustedTotalAmount.toFixed(2)}
üë• Per member: ‚Ç±${roundedPerMember.toFixed(2)} each (${totalMembers} members)`);
            }

            renderContributions();
            closeContributionModal();
            saveToLocalStorage();
        }
        
        function calculatePerMember() {
            const amount = parseFloat(document.getElementById('contribution-amount').value);
            const display = document.getElementById('per-member-display');
            
            if (amount && amount > 0) {
                const totalMembers = Object.keys(members).length;
                const rawPerMember = amount / totalMembers;
                const roundedPerMember = Math.ceil(rawPerMember); // Round up to nearest whole number
                const adjustedTotalAmount = roundedPerMember * totalMembers;
                
                // Show calculation details
                let displayHTML = `
                    <div style="color: #2c3e50; margin-bottom: 8px;">
                        üí∞ Each member contributes: <strong>‚Ç±${roundedPerMember.toFixed(2)}</strong> (${totalMembers} members total)
                    </div>
                `;
                
                // Only show adjustment info if there was actually a change
                if (adjustedTotalAmount !== amount) {
                    displayHTML += `
                        <div style="color: #e67e22; font-size: 12px; background: #fef5e7; padding: 8px; border-radius: 4px; border-left: 3px solid #f39c12;">
                            üìä <strong>Automatic Adjustment:</strong><br>
                            Original total: ‚Ç±${amount.toFixed(2)} (‚Ç±${rawPerMember.toFixed(2)} per member)<br>
                            Adjusted total: <strong style="color: #27ae60;">‚Ç±${adjustedTotalAmount.toFixed(2)}</strong> (‚Ç±${roundedPerMember.toFixed(2)} per member)
                            <br><small style="color: #8e44ad;">‚ú® Rounded up to nearest whole number per member</small>
                        </div>
                    `;
                } else {
                    displayHTML += `
                        <div style="color: #27ae60; font-size: 12px;">
                            ‚úÖ Perfect! No adjustment needed - already whole numbers
                        </div>
                    `;
                }
                
                display.innerHTML = displayHTML;
            } else {
                display.innerHTML = '';
            }
        }
        
        function editContribution(contributionId) {
            // Check if user has permission to edit contributions
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can edit contributions.');
                return;
            }
            
            const contribution = contributions.find(c => c.id === contributionId);
            if (!contribution) return;
            
            editingContributionId = contributionId;
            
            // Populate form with existing data
            document.getElementById('contribution-amount').value = contribution.amount;
            document.getElementById('contribution-purpose').value = contribution.purpose;
            document.getElementById('contribution-deadline').value = contribution.deadline;
            
            // Update modal title and buttons
            document.getElementById('contribution-modal-title').textContent = 'Edit Money Contribution';
            document.getElementById('save-contribution-btn').textContent = 'Update Contribution';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            
            // Show per-member calculation
            calculatePerMember();
            
            // Open modal
            document.getElementById('contribution-modal').style.display = 'flex';
        }
        
        function cancelEditContribution() {
            editingContributionId = null;
            closeContributionModal();
        }
        
        function deleteContribution(contributionId) {
            // Check if user has permission to delete contributions
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can delete contributions.');
                return;
            }
            
            const contribution = contributions.find(c => c.id === contributionId);
            if (!contribution) return;
            
            if (!confirm(`Are you sure you want to delete the ‚Ç±${contribution.amount.toFixed(2)} contribution for "${contribution.purpose}"?\n\nThis will also remove all payment records for this contribution.`)) {
                return;
            }
            
            // Remove contribution
            const index = contributions.findIndex(c => c.id === contributionId);
            if (index !== -1) {
                contributions.splice(index, 1);
            }
            
            // Remove payment records from all members
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                if (member.payments) {
                    member.payments = member.payments.filter(p => p.contributionId !== contributionId);
                }
            });
            
            renderContributions();
            saveToLocalStorage();
            alert('Contribution deleted successfully!');
        }

        // Function to complete an event
        function completeEvent(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event || event.completed) return;
            
            currentEvent = event;
            document.getElementById('complete-event-title').textContent = event.name;
            
            // Create checklist for members
            const checklist = document.getElementById('event-members-checklist');
            checklist.innerHTML = '';
            
            event.participants.forEach(participant => {
                const member = members[participant];
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="event-missed-${participant}" value="${participant}" data-type="missed">
                    <label for="event-missed-${participant}">${member.name} missed the activity</label>
                    <br>
                    <input type="checkbox" id="event-late-${participant}" value="${participant}" data-type="late">
                    <label for="event-late-${participant}">${member.name} submitted late</label>
                `;
                checklist.appendChild(div);
            });
            
            document.getElementById('complete-event-modal').style.display = 'flex';
        }

        // Function to complete a meeting
        function completeMeeting(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting || meeting.completed) return;
            
            currentMeeting = meeting;
            document.getElementById('complete-meeting-title').textContent = meeting.type;
            
            // Create checklist for members
            const checklist = document.getElementById('meeting-members-checklist');
            checklist.innerHTML = '';
            
            meeting.attendees.forEach(attendee => {
                const member = members[attendee];
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="meeting-tardy-${attendee}" value="${attendee}" data-type="tardy">
                    <label for="meeting-tardy-${attendee}">${member.name} was tardy</label>
                    <br>
                    <input type="checkbox" id="meeting-absent-${attendee}" value="${attendee}" data-type="absent">
                    <label for="meeting-absent-${attendee}">${member.name} was absent</label>
                `;
                checklist.appendChild(div);
            });
            
            document.getElementById('complete-meeting-modal').style.display = 'flex';
        }

        // Function to close complete event modal
        function closeCompleteEventModal() {
            document.getElementById('complete-event-modal').style.display = 'none';
        }

        // Function to close complete meeting modal
        function closeCompleteMeetingModal() {
            document.getElementById('complete-meeting-modal').style.display = 'none';
        }

        // Function to submit event completion
        function submitEventCompletion() {
            const missed = [];
            const late = [];
            
            // Get all checked checkboxes
            const checkboxes = document.querySelectorAll('#event-members-checklist input[type="checkbox"]:checked');
            
            // Always require a general reason when completing an event
            const generalReason = document.getElementById('event-reason').value.trim();
            if (!generalReason) {
                alert('Please provide a general reason or explanation for completing this event');
                return;
            }
            
            // If there are issues, ask for specific reasons for each affected member
            if (checkboxes.length > 0) {
                const memberReasons = {};
                let allReasonsProvided = true;
                
                checkboxes.forEach(checkbox => {
                    const memberId = checkbox.value;
                    const memberName = members[memberId].name.split(',')[0];
                    const type = checkbox.dataset.type;
                    const issueType = type === 'missed' ? 'missed this activity' : 'submitted late';
                    
                    // Ask for specific reason for this member's issue
                    const specificReason = prompt(`Please provide a specific reason why ${memberName} ${issueType}:`);
                    if (!specificReason || !specificReason.trim()) {
                        allReasonsProvided = false;
                        alert(`Please provide a reason for ${memberName}'s ${issueType.replace('this ', '').replace('ed', 'ion')}.`);
                        return;
                    }
                    memberReasons[memberId] = specificReason.trim();
                });
                
                if (!allReasonsProvided) {
                    return;
                }
                
                // Process each affected member with their specific reason
                checkboxes.forEach(checkbox => {
                    const memberId = checkbox.value;
                    const type = checkbox.dataset.type;
                    const specificReason = memberReasons[memberId];
                    
                    if (type === 'missed') {
                        missed.push(memberId);
                        members[memberId].missedActivities++;
                        
                        // Record detailed attendance data with specific reason
                        if (!members[memberId].attendanceRecords) {
                            members[memberId].attendanceRecords = [];
                        }
                        members[memberId].attendanceRecords.push({
                            type: 'missed_activity',
                            date: new Date().toLocaleString(),
                            eventName: currentEvent.name,
                            reason: specificReason
                        });
                    } else if (type === 'late') {
                        late.push(memberId);
                        members[memberId].lateSubmissions++;
                        
                        // Record detailed attendance data with specific reason
                        if (!members[memberId].attendanceRecords) {
                            members[memberId].attendanceRecords = [];
                        }
                        members[memberId].attendanceRecords.push({
                            type: 'late_submission',
                            date: new Date().toLocaleString(),
                            eventName: currentEvent.name,
                            reason: specificReason
                        });
                    }
                    
                    // Update deductions
                    members[memberId].deductions = members[memberId].tardiness * 0.5 + 
                                                  members[memberId].absences * 1 + 
                                                  members[memberId].missedActivities * 1.5 + 
                                                  members[memberId].lateSubmissions * 0.5;
                });
            }
            
            // Update event
            currentEvent.missed = missed;
            currentEvent.late = late;
            currentEvent.completed = true;
            currentEvent.completionDate = new Date().toLocaleString();
            currentEvent.reason = generalReason;
            
            // Update display if the current member is being viewed
            const activeMember = document.querySelector('.member-btn.active');
            if (activeMember) {
                const memberId = getActiveMemberId();
                showMember(memberId);
            }
            
            renderEvents();
            closeCompleteEventModal();
            
            // Clear form
            document.getElementById('event-reason').value = '';
        }

        // Function to submit meeting completion
        function submitMeetingCompletion() {
            const tardy = [];
            const absent = [];
            
            // Get all checked checkboxes
            const checkboxes = document.querySelectorAll('#meeting-members-checklist input[type="checkbox"]:checked');
            
            // Always require a general reason when completing a meeting
            const generalReason = document.getElementById('meeting-reason').value.trim();
            if (!generalReason) {
                alert('Please provide a general reason or explanation for completing this meeting');
                return;
            }
            
            // If there are issues, ask for specific reasons for each affected member
            if (checkboxes.length > 0) {
                const memberReasons = {};
                let allReasonsProvided = true;
                
                checkboxes.forEach(checkbox => {
                    const memberId = checkbox.value;
                    const memberName = members[memberId].name.split(',')[0];
                    const type = checkbox.dataset.type;
                    const issueType = type === 'tardy' ? 'was tardy' : 'was absent';
                    
                    // Ask for specific reason for this member's issue
                    const specificReason = prompt(`Please provide a specific reason why ${memberName} ${issueType}:`);
                    if (!specificReason || !specificReason.trim()) {
                        allReasonsProvided = false;
                        alert(`Please provide a reason for ${memberName}'s ${issueType.replace('was ', '')}.`);
                        return;
                    }
                    memberReasons[memberId] = specificReason.trim();
                });
                
                if (!allReasonsProvided) {
                    return;
                }
                
                // Process each affected member with their specific reason
                checkboxes.forEach(checkbox => {
                    const memberId = checkbox.value;
                    const type = checkbox.dataset.type;
                    const specificReason = memberReasons[memberId];
                    
                    if (type === 'tardy') {
                        tardy.push(memberId);
                        members[memberId].tardiness++;
                        
                        // Record detailed attendance data with specific reason
                        if (!members[memberId].attendanceRecords) {
                            members[memberId].attendanceRecords = [];
                        }
                        members[memberId].attendanceRecords.push({
                            type: 'tardy',
                            date: new Date().toLocaleString(),
                            meetingType: currentMeeting.type,
                            reason: specificReason
                        });
                    } else if (type === 'absent') {
                        absent.push(memberId);
                        members[memberId].absences++;
                        
                        // Record detailed attendance data with specific reason
                        if (!members[memberId].attendanceRecords) {
                            members[memberId].attendanceRecords = [];
                        }
                        members[memberId].attendanceRecords.push({
                            type: 'absent',
                            date: new Date().toLocaleString(),
                            meetingType: currentMeeting.type,
                            reason: specificReason
                        });
                    }
                    
                    // Update deductions
                    members[memberId].deductions = members[memberId].tardiness * 0.5 + 
                                                  members[memberId].absences * 1 + 
                                                  members[memberId].missedActivities * 1.5 + 
                                                  members[memberId].lateSubmissions * 0.5;
                });
            }
            
            // Update meeting
            currentMeeting.tardy = tardy;
            currentMeeting.absent = absent;
            currentMeeting.completed = true;
            currentMeeting.completionDate = new Date().toLocaleString();
            currentMeeting.reason = generalReason;
            
            // Update display if the current member is being viewed
            const activeMember = document.querySelector('.member-btn.active');
            if (activeMember) {
                const memberId = getActiveMemberId();
                showMember(memberId);
            }
            
            renderMeetings();
            closeCompleteMeetingModal();
            
            // Clear form
            document.getElementById('meeting-reason').value = '';
        }

        // Function to render events
        function renderEvents() {
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = '';
            
            if (events.length === 0) {
                eventsList.innerHTML = '<p>No events recorded yet.</p>';
                return;
            }
            
            events.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                
                let participants = '';
                event.participants.forEach(p => {
                    participants += members[p].name.split(',')[0] + ', ';
                });
                participants = participants.slice(0, -2);
                
                let status = event.completed ? 
                    `<span style="color: green;">Completed</span>` : 
                    `<span style="color: orange;">Pending</span>`;
                
                let issues = '';
                let completionButton = '';
                
                if (event.completed) {
                    if (event.missed.length > 0 || event.late.length > 0) {
                        issues = `<div style="color: red; margin-top: 5px;">Issues recorded: ${event.reason}</div>`;
                    } else {
                        issues = `<div style="color: green; margin-top: 5px;">No issues recorded - ${event.reason}</div>`;
                    }
                    if (event.completionDate) {
                        issues += `<div style="color: #666; font-size: 12px; margin-top: 3px;">Completed on: ${event.completionDate}</div>`;
                    }
                } else {
                    completionButton = `<button class="btn btn-success" onclick="manualCompleteEvent(${event.id})" style="margin-top: 10px; font-size: 12px;">Mark as Completed</button>`;
                }
                
                eventItem.innerHTML = `
                    <div class="event-title">${event.name} ${status}</div>
                    <div class="event-details">
                        Deadline: ${new Date(event.deadline).toLocaleString()}<br>
                        Participants: ${participants}
                        ${issues}
                        ${completionButton}
                    </div>
                `;
                
                eventsList.appendChild(eventItem);
            });
        }

        // Function to render contributions
        function renderContributions() {
            const contributionsList = document.getElementById('contributions-list');
            contributionsList.innerHTML = '';
            
            if (contributions.length === 0) {
                contributionsList.innerHTML = '<p>No money contributions recorded yet.</p>';
                return;
            }
            
            contributions.forEach(contribution => {
                const contributionItem = document.createElement('div');
                contributionItem.className = 'event-item';
                
                const deadline = new Date(contribution.deadline);
                const now = new Date();
                const isPastDeadline = now > deadline;
                
                // Calculate total members and individual contribution
                const totalMembers = Object.keys(members).length;
                const perMemberAmount = (contribution.amount / totalMembers).toFixed(2);
                
                contributionItem.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            ‚Ç±${contribution.amount.toFixed(2)} Contribution ${isPastDeadline ? '<span style="color: red;">(Past Deadline)</span>' : ''}
                            <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                <strong>Per Member:</strong> ‚Ç±${perMemberAmount} each (${totalMembers} members)
                            </div>
                        </div>
                        <div class="admin-only" style="display: flex; gap: 5px;">
                            <button class="btn btn-primary" onclick="editContribution(${contribution.id})" style="padding: 4px 8px; font-size: 12px;">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="deleteContribution(${contribution.id})" style="padding: 4px 8px; font-size: 12px;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div class="event-details">
                        Purpose: ${contribution.purpose}<br>
                        Deadline: ${deadline.toLocaleString()}<br>
                        Created: ${contribution.createdDate}
                        ${contribution.editedDate ? `<br><span style="color: #666; font-size: 12px;">Last edited: ${contribution.editedDate}</span>` : ''}
                    </div>
                `;
                
                contributionsList.appendChild(contributionItem);
            });
        }

        // Function to render meetings
        function renderMeetings() {
            const meetingsList = document.getElementById('meetings-list');
            meetingsList.innerHTML = '';
            
            if (meetings.length === 0) {
                meetingsList.innerHTML = '<p>No meetings recorded yet.</p>';
                return;
            }
            
            meetings.forEach(meeting => {
                const meetingItem = document.createElement('div');
                meetingItem.className = 'meeting-item';
                
                let attendees = '';
                meeting.attendees.forEach(a => {
                    attendees += members[a].name.split(',')[0] + ', ';
                });
                attendees = attendees.slice(0, -2);
                
                let status = meeting.completed ? 
                    `<span style="color: green;">Completed</span>` : 
                    `<span style="color: orange;">Pending</span>`;
                
                let issues = '';
                let completionButton = '';
                
                if (meeting.completed) {
                    if (meeting.tardy.length > 0 || meeting.absent.length > 0) {
                        issues = `<div style="color: red; margin-top: 5px;">Issues recorded: ${meeting.reason}</div>`;
                    } else {
                        issues = `<div style="color: green; margin-top: 5px;">No issues recorded - ${meeting.reason}</div>`;
                    }
                    if (meeting.completionDate) {
                        issues += `<div style="color: #666; font-size: 12px; margin-top: 3px;">Completed on: ${meeting.completionDate}</div>`;
                    }
                } else {
                    completionButton = `<button class="btn btn-success" onclick="manualCompleteMeeting(${meeting.id})" style="margin-top: 10px; font-size: 12px;">Mark as Completed</button>`;
                }
                
                meetingItem.innerHTML = `
                    <div class="meeting-title">${meeting.type} ${status}</div>
                    <div class="meeting-details">
                        Date: ${meeting.date}<br>
                        Attendees: ${attendees}
                        ${issues}
                        ${completionButton}
                    </div>
                `;
                
                meetingsList.appendChild(meetingItem);
            });
        }

        // Function to calculate grades
        function calculateGrades() {
            // Update grading criteria from inputs
            gradingCriteria.tardinessPenalty = parseFloat(document.getElementById('tardiness-penalty').value) || -1;
            gradingCriteria.absencePenalty = parseFloat(document.getElementById('absence-penalty').value) || -2;
            gradingCriteria.missedActivityPenalty = parseFloat(document.getElementById('missed-activity-penalty').value) || -3;
            gradingCriteria.lateSubmissionPenalty = parseFloat(document.getElementById('late-submission-penalty').value) || -1;
            
            // Update penalty displays for members
            updatePenaltyDisplays();
            
            const gradesList = document.getElementById('grades-list');
            gradesList.innerHTML = '';
            
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                
                // Calculate grade
                const grade = gradingCriteria.baseGrade + 
                    (member.tardiness * gradingCriteria.tardinessPenalty) +
                    (member.absences * gradingCriteria.absencePenalty) +
                    (member.missedActivities * gradingCriteria.missedActivityPenalty) +
                    (member.lateSubmissions * gradingCriteria.lateSubmissionPenalty) -
                    member.deductions;
                
                const finalGrade = Math.max(0, Math.min(100, grade)); // Clamp between 0-100
                
                // Determine letter grade
                let letterGrade = 'F';
                if (finalGrade >= 97) letterGrade = 'A+';
                else if (finalGrade >= 93) letterGrade = 'A';
                else if (finalGrade >= 90) letterGrade = 'A-';
                else if (finalGrade >= 87) letterGrade = 'B+';
                else if (finalGrade >= 83) letterGrade = 'B';
                else if (finalGrade >= 80) letterGrade = 'B-';
                else if (finalGrade >= 77) letterGrade = 'C+';
                else if (finalGrade >= 73) letterGrade = 'C';
                else if (finalGrade >= 70) letterGrade = 'C-';
                else if (finalGrade >= 67) letterGrade = 'D+';
                else if (finalGrade >= 60) letterGrade = 'D';
                
                const gradeItem = document.createElement('div');
                gradeItem.className = 'event-item';
                gradeItem.style.marginBottom = '15px';
                
                const gradeColor = finalGrade >= 80 ? 'green' : finalGrade >= 70 ? 'orange' : 'red';
                
                gradeItem.innerHTML = `
                    <div class="event-title">${member.name}</div>
                    <div class="event-details">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                            <div><strong>Tardiness:</strong> ${member.tardiness} (${(member.tardiness * gradingCriteria.tardinessPenalty).toFixed(1)} pts)</div>
                            <div><strong>Absences:</strong> ${member.absences} (${(member.absences * gradingCriteria.absencePenalty).toFixed(1)} pts)</div>
                            <div><strong>Missed Activities:</strong> ${member.missedActivities} (${(member.missedActivities * gradingCriteria.missedActivityPenalty).toFixed(1)} pts)</div>
                            <div><strong>Late Submissions:</strong> ${member.lateSubmissions} (${(member.lateSubmissions * gradingCriteria.lateSubmissionPenalty).toFixed(1)} pts)</div>
                            <div><strong>Additional Deductions:</strong> ${member.deductions.toFixed(1)} pts</div>
                        </div>
                        <div style="font-size: 18px; font-weight: bold; color: ${gradeColor};">
                            Final Grade: ${finalGrade.toFixed(1)}% (${letterGrade})
                        </div>
                    </div>
                `;
                
                gradesList.appendChild(gradeItem);
            });
        }

        // Function to generate alerts
        function generateAlerts() {
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '';
            
            const now = new Date();
            const alerts = [];
            
            // Check for upcoming contribution deadlines
            contributions.forEach(contribution => {
                const deadline = new Date(contribution.deadline);
                const daysUntilDeadline = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
                
                if (daysUntilDeadline <= 3 && daysUntilDeadline > 0) {
                    alerts.push({
                        type: 'warning',
                        message: `Contribution deadline approaching: ‚Ç±${contribution.amount} for "${contribution.purpose}" due in ${daysUntilDeadline} day(s)`,
                        priority: 'medium'
                    });
                } else if (daysUntilDeadline <= 0) {
                    alerts.push({
                        type: 'danger',
                        message: `Overdue contribution: ‚Ç±${contribution.amount} for "${contribution.purpose}" was due ${Math.abs(daysUntilDeadline)} day(s) ago`,
                        priority: 'high'
                    });
                }
            });
            
            // Check for unpaid contributions
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                contributions.forEach(contribution => {
                    const payment = member.payments.find(p => p.contributionId === contribution.id);
                    if (!payment || !payment.paid) {
                        alerts.push({
                            type: 'info',
                            message: `${member.name.split(',')[0]} has not paid ‚Ç±${contribution.amount} for "${contribution.purpose}"`,
                            priority: 'low'
                        });
                    }
                });
            });
            
            // Check for performance warnings
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                if (member.absences >= 3) {
                    alerts.push({
                        type: 'warning',
                        message: `${member.name.split(',')[0]} has ${member.absences} absences - performance warning`,
                        priority: 'medium'
                    });
                }
                if (member.tardiness >= 5) {
                    alerts.push({
                        type: 'warning',
                        message: `${member.name.split(',')[0]} has ${member.tardiness} tardiness incidents`,
                        priority: 'medium'
                    });
                }
            });
            
            // Sort alerts by priority
            alerts.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<div class="event-item"><div class="event-title" style="color: green;">No alerts at this time</div></div>';
                return;
            }
            
            alerts.forEach(alert => {
                const alertItem = document.createElement('div');
                alertItem.className = 'event-item';
                alertItem.style.marginBottom = '10px';
                
                const colors = {
                    danger: '#e74c3c',
                    warning: '#f39c12',
                    info: '#3498db'
                };
                
                alertItem.innerHTML = `
                    <div class="event-title" style="color: ${colors[alert.type]}; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">${alert.type === 'danger' ? 'üö®' : alert.type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                        ${alert.message}
                    </div>
                `;
                
                alertsList.appendChild(alertItem);
            });
        }

        // Function to draw performance chart
        function drawPerformanceChart() {
            const canvas = document.getElementById('performanceChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Get totals
            let totalTardiness = 0, totalAbsences = 0, totalMissedActivities = 0, totalLateSubmissions = 0;
            
            Object.values(members).forEach(member => {
                totalTardiness += member.tardiness;
                totalAbsences += member.absences;
                totalMissedActivities += member.missedActivities;
                totalLateSubmissions += member.lateSubmissions;
            });
            
            const data = [
                { label: 'Tardiness', value: totalTardiness, color: '#f39c12' },
                { label: 'Absences', value: totalAbsences, color: '#e74c3c' },
                { label: 'Missed Activities', value: totalMissedActivities, color: '#9b59b6' },
                { label: 'Late Submissions', value: totalLateSubmissions, color: '#3498db' }
            ];
            
            const maxValue = Math.max(...data.map(d => d.value)) || 1;
            const barWidth = 60;
            const barSpacing = 20;
            const chartHeight = 150;
            const startX = 30;
            const startY = 170;
            
            data.forEach((item, index) => {
                const barHeight = (item.value / maxValue) * chartHeight;
                const x = startX + index * (barWidth + barSpacing);
                const y = startY - barHeight;
                
                // Draw bar
                ctx.fillStyle = item.color;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw value on top
                ctx.fillStyle = '#2c3e50';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.value, x + barWidth/2, y - 5);
                
                // Draw label
                ctx.save();
                ctx.translate(x + barWidth/2, startY + 15);
                ctx.rotate(-Math.PI/6);
                ctx.textAlign = 'center';
                ctx.font = '10px Arial';
                ctx.fillText(item.label, 0, 0);
                ctx.restore();
            });
        }

        // Function to draw comparison chart
        function drawComparisonChart() {
            const canvas = document.getElementById('comparisonChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const memberNames = Object.keys(members);
            const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12'];
            
            const barWidth = 50;
            const barSpacing = 15;
            const chartHeight = 150;
            const startX = 30;
            const startY = 170;
            
            // Calculate total issues for each member
            const memberTotals = memberNames.map(memberId => {
                const member = members[memberId];
                return member.tardiness + member.absences + member.missedActivities + member.lateSubmissions;
            });
            
            const maxTotal = Math.max(...memberTotals) || 1;
            
            memberNames.forEach((memberId, index) => {
                const member = members[memberId];
                const total = memberTotals[index];
                const barHeight = (total / maxTotal) * chartHeight;
                const x = startX + index * (barWidth + barSpacing);
                const y = startY - barHeight;
                
                // Draw bar
                ctx.fillStyle = colors[index % colors.length];
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw value on top
                ctx.fillStyle = '#2c3e50';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(total, x + barWidth/2, y - 5);
                
                // Draw member name
                ctx.save();
                ctx.translate(x + barWidth/2, startY + 15);
                ctx.textAlign = 'center';
                ctx.font = '10px Arial';
                ctx.fillText(member.name.split(',')[0], 0, 0);
                ctx.restore();
            });
        }

        // Function to update financial summary
        function updateFinancialSummary() {
            const financialSummary = document.getElementById('financialSummary');
            if (!financialSummary) return;
            
            let totalContributions = 0;
            let totalPaid = 0;
            let totalUnpaid = 0;
            
            contributions.forEach(contribution => {
                const totalMembers = Object.keys(members).length;
                const contributionTotal = contribution.amount;
                totalContributions += contributionTotal;
                
                Object.keys(members).forEach(memberId => {
                    const member = members[memberId];
                    const payment = member.payments.find(p => p.contributionId === contribution.id);
                    const perMemberAmount = contribution.amount / totalMembers;
                    
                    if (payment) {
                        // Use partialAmount for consistency with other calculations
                        const paidAmount = payment.partialAmount || 0;
                        totalPaid += paidAmount;
                        totalUnpaid += (perMemberAmount - paidAmount);
                    } else {
                        totalUnpaid += perMemberAmount;
                    }
                });
            });
            
            financialSummary.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; text-align: center;">
                    <h4>Total Expected</h4>
                    <div style="font-size: 20px; font-weight: bold; color: #2c3e50;">‚Ç±${totalContributions.toFixed(2)}</div>
                </div>
                <div style="background: #d4edda; padding: 15px; border-radius: 6px; text-align: center;">
                    <h4>Total Paid</h4>
                    <div style="font-size: 20px; font-weight: bold; color: #155724;">‚Ç±${totalPaid.toFixed(2)}</div>
                </div>
                <div style="background: #f8d7da; padding: 15px; border-radius: 6px; text-align: center;">
                    <h4>Total Unpaid</h4>
                    <div style="font-size: 20px; font-weight: bold; color: #721c24;">‚Ç±${totalUnpaid.toFixed(2)}</div>
                </div>
                <div style="background: #cce5ff; padding: 15px; border-radius: 6px; text-align: center;">
                    <h4>Collection Rate</h4>
                    <div style="font-size: 20px; font-weight: bold; color: #004085;">${totalContributions > 0 ? ((totalPaid / totalContributions) * 100).toFixed(1) : 0}%</div>
                </div>
            `;
        }

        // Function to add expense
        function addExpense() {
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            const date = document.getElementById('expense-date').value;
            
            if (!description || !amount || !date) {
                alert('Please fill in all fields');
                return;
            }
            
            if (amount <= 0) {
                alert('Please enter a valid amount greater than 0');
                return;
            }
            
            // Check if user is a member - create approval request
            if (userRole === 'member') {
                const request = {
                    id: Date.now(),
                    type: 'expense',
                    memberId: currentUser,
                    memberName: members[currentUser].name,
                    description: description,
                    amount: amount,
                    category: category,
                    date: date,
                    requestDate: new Date().toLocaleString(),
                    status: 'pending'
                };
                
                pendingExpenseRequests.push(request);
                updatePendingRequestsCount();
                saveToLocalStorage();
                
                alert(`Expense request submitted for admin approval!

Description: ${description}
Amount: ‚Ç±${amount.toFixed(2)}
Category: ${category.charAt(0).toUpperCase() + category.slice(1)}`);
                
                // Clear form
                document.getElementById('expense-description').value = '';
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-category').value = 'supplies';
                document.getElementById('expense-date').value = '';
                return;
            }
            
            const expense = {
                id: Date.now(),
                description,
                amount,
                category,
                date,
                createdDate: new Date().toLocaleString()
            };
            
            expenses.push(expense);
            renderExpenses();
            updateBudgetSummary();
            
            // Clear form
            document.getElementById('expense-description').value = '';
            document.getElementById('expense-amount').value = '';
            document.getElementById('expense-category').value = 'supplies';
            document.getElementById('expense-date').value = '';
            
            alert('Expense added successfully!');
        }

        // Function to render expenses
        function renderExpenses() {
            const expenseList = document.getElementById('expense-list');
            expenseList.innerHTML = '';
            
            if (expenses.length === 0) {
                expenseList.innerHTML = '<p>No expenses recorded yet.</p>';
                return;
            }
            
            // Sort expenses by date (newest first)
            const sortedExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedExpenses.forEach(expense => {
                const expenseItem = document.createElement('div');
                expenseItem.className = 'event-item';
                expenseItem.style.marginBottom = '10px';
                
                expenseItem.innerHTML = `
                    <div class="event-title">‚Ç±${expense.amount.toFixed(2)} - ${expense.description}</div>
                    <div class="event-details">
                        Category: ${expense.category.charAt(0).toUpperCase() + expense.category.slice(1)}<br>
                        Date: ${new Date(expense.date).toLocaleDateString()}<br>
                        Added: ${expense.createdDate}
                    </div>
                `;
                
                expenseList.appendChild(expenseItem);
            });
        }

        // Function to update budget summary
        function updateBudgetSummary() {
            const budgetSummary = document.getElementById('budget-summary');
            
            // Calculate totals
            let totalCollected = 0;
            let totalSpent = 0;
            const categoryTotals = {};
            
            // Calculate total money collected
            contributions.forEach(contribution => {
                Object.keys(members).forEach(memberId => {
                    const member = members[memberId];
                    const payment = member.payments.find(p => p.contributionId === contribution.id);
                    if (payment) {
                        // Always use partialAmount for consistency with money summary
                        totalCollected += (payment.partialAmount || 0);
                    }
                });
            });
            
            // Calculate total expenses by category
            expenses.forEach(expense => {
                totalSpent += expense.amount;
                if (categoryTotals[expense.category]) {
                    categoryTotals[expense.category] += expense.amount;
                } else {
                    categoryTotals[expense.category] = expense.amount;
                }
            });
            
            const remaining = totalCollected - totalSpent;
            
            let categoryBreakdown = '';
            Object.keys(categoryTotals).forEach(category => {
                categoryBreakdown += `<div><strong>${category.charAt(0).toUpperCase() + category.slice(1)}:</strong> ‚Ç±${categoryTotals[category].toFixed(2)}</div>`;
            });
            
            budgetSummary.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: #d4edda; padding: 15px; border-radius: 6px; text-align: center;">
                        <h4>Total Collected</h4>
                        <div style="font-size: 20px; font-weight: bold; color: #155724;">‚Ç±${totalCollected.toFixed(2)}</div>
                    </div>
                    <div style="background: #f8d7da; padding: 15px; border-radius: 6px; text-align: center;">
                        <h4>Total Spent</h4>
                        <div style="font-size: 20px; font-weight: bold; color: #721c24;">‚Ç±${totalSpent.toFixed(2)}</div>
                    </div>
                    <div style="background: ${remaining >= 0 ? '#d1ecf1' : '#f8d7da'}; padding: 15px; border-radius: 6px; text-align: center;">
                        <h4>Remaining</h4>
                        <div style="font-size: 20px; font-weight: bold; color: ${remaining >= 0 ? '#0c5460' : '#721c24'};">‚Ç±${remaining.toFixed(2)}</div>
                    </div>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                    <h5>Expenses by Category:</h5>
                    ${categoryBreakdown || '<div>No expenses recorded yet.</div>'}
                </div>
            `;
        }

        // Function to open notes modal
        function openNotesModal() {
            document.getElementById('notes-member-name').textContent = members[currentMember].name;
            document.getElementById('notes-modal').style.display = 'flex';
            updateNotesDisplay();
        }

        // Function to close notes modal
        function closeNotesModal() {
            document.getElementById('notes-modal').style.display = 'none';
            document.getElementById('note-text').value = '';
            document.getElementById('note-category').value = 'general';
        }
        
        // Payment Approval System Functions
        
        // Function to open approval requests modal
        function openApprovalRequestsModal() {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can view approval requests.');
                return;
            }
            
            document.getElementById('approval-requests-modal').style.display = 'flex';
            updateApprovalRequestsList();
        }
        
        // Function to close approval requests modal
        function closeApprovalRequestsModal() {
            document.getElementById('approval-requests-modal').style.display = 'none';
        }
        
        // Function to update pending requests count
        function updatePendingRequestsCount() {
            const pendingPaymentCount = pendingPaymentRequests.filter(r => r.status === 'pending').length;
            const pendingSessionCount = pendingSessionRequests.filter(r => r.status === 'pending').length;
            const pendingExpenseCount = pendingExpenseRequests.filter(r => r.status === 'pending').length;
            const totalPendingCount = pendingPaymentCount + pendingSessionCount + pendingExpenseCount;
            const countElement = document.getElementById('pending-requests-count');
            
            if (totalPendingCount > 0) {
                countElement.textContent = totalPendingCount;
                countElement.style.display = 'inline';
            } else {
                countElement.style.display = 'none';
            }
        }
        
        // Function to update approval requests list
        function updateApprovalRequestsList() {
            const container = document.getElementById('approval-requests-list');
            const pendingPaymentRequests_filtered = pendingPaymentRequests.filter(r => r.status === 'pending');
            const pendingSessionRequests_filtered = pendingSessionRequests.filter(r => r.status === 'pending');
            const pendingExpenseRequests_filtered = pendingExpenseRequests.filter(r => r.status === 'pending');
            
            container.innerHTML = '';
            
            // Session Approval Requests Section
            if (pendingSessionRequests_filtered.length > 0) {
                const sessionHeader = document.createElement('div');
                sessionHeader.innerHTML = '<h3 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">üìã Session Approval Requests</h3>';
                container.appendChild(sessionHeader);
                
                pendingSessionRequests_filtered.forEach(request => {
                    const requestItem = document.createElement('div');
                    requestItem.className = 'event-item';
                    requestItem.style.marginBottom = '15px';
                    requestItem.style.borderLeft = '4px solid #3498db';
                    
                    const typeLabels = {
                        'complete': 'Complete Session',
                        'manual_complete': 'Manual Complete',
                        'reschedule': 'Reschedule Session',
                        'cancel': 'Cancel Session',
                        'delete': 'Delete Session'
                    };
                    
                    const typeColors = {
                        'complete': '#27ae60',
                        'manual_complete': '#2980b9',
                        'reschedule': '#f39c12',
                        'cancel': '#e74c3c',
                        'delete': '#c0392b'
                    };
                    
                    requestItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px; color: #2c3e50;">
                                    <span style="background: ${typeColors[request.type]}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 8px;">
                                        ${typeLabels[request.type]}
                                    </span>
                                    ${request.memberName}
                                </div>
                                <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 8px;">
                                    <strong>Session:</strong> ${request.sessionCategory} - ${request.sessionName}
                                </div>
                                <div style="font-size: 13px; color: #666; margin-top: 5px;">${request.description}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px; min-width: 120px;">
                                <button class="btn btn-success" onclick="approveSessionRequest(${request.id})" style="font-size: 11px; padding: 4px 8px;">‚úì Approve</button>
                                <button class="btn btn-danger" onclick="rejectSessionRequest(${request.id})" style="font-size: 11px; padding: 4px 8px;">‚úó Reject</button>
                            </div>
                        </div>
                        <div class="event-details" style="font-size: 12px; color: #95a5a6;">
                            <strong>Requested:</strong> ${request.requestDate}
                        </div>
                    `;
                    
                    container.appendChild(requestItem);
                });
            }
            
            // Expense Approval Requests Section
            if (pendingExpenseRequests_filtered.length > 0) {
                if (pendingSessionRequests_filtered.length > 0) {
                    const divider = document.createElement('div');
                    divider.style.cssText = 'margin: 30px 0; border-top: 1px solid #ddd;';
                    container.appendChild(divider);
                }
                
                const expenseHeader = document.createElement('div');
                expenseHeader.innerHTML = '<h3 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #28a745; padding-bottom: 10px;">üí∞ Expense Approval Requests</h3>';
                container.appendChild(expenseHeader);
                
                pendingExpenseRequests_filtered.forEach(request => {
                    const requestItem = document.createElement('div');
                    requestItem.className = 'event-item';
                    requestItem.style.marginBottom = '15px';
                    requestItem.style.borderLeft = '4px solid #28a745';
                    
                    const categoryLabels = {
                        'supplies': 'Supplies',
                        'food': 'Food',
                        'transportation': 'Transportation',
                        'materials': 'Materials',
                        'other': 'Other'
                    };
                    
                    requestItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px; color: #2c3e50;">
                                    <span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 8px;">
                                        Add Expense
                                    </span>
                                    ${request.memberName}
                                </div>
                                <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 8px;">
                                    <strong>Description:</strong> ${request.description}
                                </div>
                                <div style="font-size: 14px; color: #27ae60; font-weight: bold; margin-bottom: 5px;">
                                    Amount: ‚Ç±${request.amount.toFixed(2)}
                                </div>
                                <div style="font-size: 13px; color: #666;">
                                    <strong>Category:</strong> ${categoryLabels[request.category]} | <strong>Date:</strong> ${new Date(request.date).toLocaleDateString()}
                                </div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px; min-width: 120px;">
                                <button class="btn btn-success" onclick="approveExpenseRequest(${request.id})" style="font-size: 11px; padding: 4px 8px;">‚úì Approve</button>
                                <button class="btn btn-danger" onclick="rejectExpenseRequest(${request.id})" style="font-size: 11px; padding: 4px 8px;">‚úó Reject</button>
                            </div>
                        </div>
                        <div class="event-details" style="font-size: 12px; color: #95a5a6;">
                            <strong>Requested:</strong> ${request.requestDate}
                        </div>
                    `;
                    
                    container.appendChild(requestItem);
                });
            }
            
            // Payment Approval Requests Section
            if (pendingPaymentRequests_filtered.length > 0) {
                if (pendingSessionRequests_filtered.length > 0 || pendingExpenseRequests_filtered.length > 0) {
                    const divider = document.createElement('div');
                    divider.style.cssText = 'margin: 30px 0; border-top: 1px solid #ddd;';
                    container.appendChild(divider);
                }
                
                const paymentHeader = document.createElement('div');
                paymentHeader.innerHTML = '<h3 style="margin: 0 0 15px 0; color: #2c3e50; border-bottom: 2px solid #e67e22; padding-bottom: 10px;">üí∞ Payment Approval Requests</h3>';
                container.appendChild(paymentHeader);
            }
            
            if (pendingSessionRequests_filtered.length === 0 && pendingPaymentRequests_filtered.length === 0 && pendingExpenseRequests_filtered.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; font-style: italic;">No pending approval requests.</p>';
                return;
            }
            
            pendingPaymentRequests_filtered.forEach(request => {
                const requestItem = document.createElement('div');
                requestItem.className = 'event-item';
                requestItem.style.marginBottom = '15px';
                requestItem.style.borderLeft = '4px solid #f39c12';
                
                const typeLabels = {
                    'partial_payment': 'Partial Payment',
                    'mark_paid': 'Mark as Paid',
                    'mark_unpaid': 'Mark as Unpaid'
                };
                
                const typeColors = {
                    'partial_payment': '#3498db',
                    'mark_paid': '#27ae60',
                    'mark_unpaid': '#e74c3c'
                };
                
                requestItem.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: bold; color: #2c3e50; margin-bottom: 5px;">
                                <span style="background: ${typeColors[request.type]}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 8px;">
                                    ${typeLabels[request.type]}
                                </span>
                                ${request.memberName.split(',')[0]}
                            </div>
                            <div style="font-size: 14px; color: #7f8c8d; margin-bottom: 8px;">
                                <strong>Contribution:</strong> ${request.contributionPurpose}
                            </div>
                            ${request.amount > 0 ? `<div style="font-size: 14px; color: #27ae60; font-weight: bold;">Amount: ‚Ç±${request.amount.toFixed(2)}</div>` : ''}
                            ${request.description ? `<div style="font-size: 13px; color: #666; margin-top: 5px;">${request.description}</div>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 5px; min-width: 120px;">
                            <button class="btn btn-success" onclick="approvePaymentRequest(${request.id})" style="font-size: 11px; padding: 4px 8px;">‚úì Approve</button>
                            <button class="btn btn-danger" onclick="rejectPaymentRequest(${request.id})" style="font-size: 11px; padding: 4px 8px;">‚úó Reject</button>
                        </div>
                    </div>
                    <div class="event-details" style="font-size: 12px; color: #95a5a6;">
                        <strong>Requested:</strong> ${request.requestDate}
                        <br><strong>Member Share:</strong> ‚Ç±${request.perMemberAmount.toFixed(2)}
                        ${request.currentPartialAmount !== undefined ? `<br><strong>Current Paid:</strong> ‚Ç±${request.currentPartialAmount.toFixed(2)}` : ''}
                    </div>
                `;
                
                container.appendChild(requestItem);
            });
        }
        
        // Function to approve payment request
        function approvePaymentRequest(requestId) {
            const request = pendingPaymentRequests.find(r => r.id === requestId);
            if (!request || request.status !== 'pending') {
                alert('Request not found or already processed.');
                return;
            }
            
            const member = members[request.memberId];
            let payment = member.payments.find(p => p.contributionId === request.contributionId);
            
            // Process the request based on type
            if (request.type === 'partial_payment') {
                if (!payment) {
                    payment = {
                        contributionId: request.contributionId,
                        paid: false,
                        partialAmount: 0,
                        paymentHistory: []
                    };
                    member.payments.push(payment);
                }
                
                // Add to payment history
                payment.paymentHistory.push({
                    amount: request.amount,
                    date: new Date().toLocaleString(),
                    type: 'partial',
                    note: 'Approved by admin'
                });
                
                payment.partialAmount = (payment.partialAmount || 0) + request.amount;
                
                // Check if fully paid
                if (payment.partialAmount >= request.perMemberAmount) {
                    payment.paid = true;
                    payment.paymentHistory.push({
                        amount: 0,
                        date: new Date().toLocaleString(),
                        type: 'completed',
                        note: 'Auto-completed after partial payment approval'
                    });
                }
                
            } else if (request.type === 'mark_paid') {
                if (!payment) {
                    payment = {
                        contributionId: request.contributionId,
                        paid: true,
                        partialAmount: request.perMemberAmount,
                        paymentHistory: []
                    };
                    member.payments.push(payment);
                } else {
                    payment.paid = true;
                    if (request.amount > 0) {
                        payment.partialAmount = (payment.partialAmount || 0) + request.amount;
                    }
                }
                
                // Add to payment history
                if (!payment.paymentHistory) payment.paymentHistory = [];
                payment.paymentHistory.push({
                    amount: request.amount,
                    date: new Date().toLocaleString(),
                    type: request.amount > 0 ? 'auto_completion' : 'marked_complete',
                    note: 'Approved by admin'
                });
                
            } else if (request.type === 'mark_unpaid') {
                if (payment) {
                    payment.paid = false;
                    const previousAmount = payment.partialAmount || 0;
                    payment.partialAmount = 0;
                    
                    // Add to payment history
                    if (!payment.paymentHistory) payment.paymentHistory = [];
                    payment.paymentHistory.push({
                        amount: 0,
                        date: new Date().toLocaleString(),
                        type: 'payment_removed',
                        note: `Removed ‚Ç±${previousAmount.toFixed(2)} payment - Approved by admin`
                    });
                }
            }
            
            // Mark request as approved
            request.status = 'approved';
            request.processedDate = new Date().toLocaleString();
            
            updateApprovalRequestsList();
            updatePendingRequestsCount();
            saveToLocalStorage();
            
            alert(`Payment request from ${request.memberName.split(',')[0]} has been approved.`);
        }
        
        // Function to reject payment request
        function rejectPaymentRequest(requestId) {
            const request = pendingPaymentRequests.find(r => r.id === requestId);
            if (!request || request.status !== 'pending') {
                alert('Request not found or already processed.');
                return;
            }
            
            const reason = prompt('Enter reason for rejection (optional):');
            
            // Mark request as rejected
            request.status = 'rejected';
            request.processedDate = new Date().toLocaleString();
            request.rejectionReason = reason;
            
            updateApprovalRequestsList();
            updatePendingRequestsCount();
            saveToLocalStorage();
            
            alert(`Payment request from ${request.memberName.split(',')[0]} has been rejected.`);
        }
        
        // Function to approve session request
        function approveSessionRequest(requestId) {
            const request = pendingSessionRequests.find(r => r.id === requestId);
            if (!request || request.status !== 'pending') {
                alert('Request not found or already processed.');
                return;
            }
            
            const session = sessions.find(s => s.id === request.sessionId);
            if (!session) {
                alert('Session not found.');
                return;
            }
            
            // Process the request based on type
            if (request.type === 'complete') {
                // Auto complete session
                const now = new Date();
                const endTime = new Date(session.endTime);
                
                if (now < endTime) {
                    if (!confirm('Session end time has not passed yet. Are you sure you want to approve early completion?')) {
                        return;
                    }
                }
                
                openCompleteSessionModal(session);
                
            } else if (request.type === 'manual_complete') {
                // Manual complete session
                openCompleteSessionModal(session);
                
            } else if (request.type === 'reschedule') {
                // Reschedule session - open reschedule modal for admin
                currentSession = session;
                document.getElementById('reschedule-session-title').textContent = `${session.category} - ${session.name}`;
                
                // Pre-fill current times
                const startTime = new Date(session.startTime);
                const endTime = new Date(session.endTime);
                
                // Format for datetime-local input
                const formatForInput = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    return `${year}-${month}-${day}T${hours}:${minutes}`;
                };
                
                document.getElementById('reschedule-start').value = formatForInput(startTime);
                document.getElementById('reschedule-end').value = formatForInput(endTime);
                
                document.getElementById('reschedule-modal').style.display = 'flex';
                
            } else if (request.type === 'cancel') {
                // Cancel session
                if (!confirm(`Are you sure you want to approve the cancellation of "${session.name}"? This action cannot be undone.`)) {
                    return;
                }
                
                const reason = prompt('Enter reason for cancellation:', request.description.replace('Request to cancel session. Reason: ', ''));
                if (!reason || !reason.trim()) {
                    alert('Please provide a reason for canceling the session.');
                    return;
                }
                
                // Add cancellation information
                session.cancelled = true;
                session.cancellationDate = new Date().toLocaleString();
                session.cancellationReason = reason.trim();
                
                renderSessions();
                
            } else if (request.type === 'delete') {
                // Delete session
                if (!confirm(`Are you sure you want to approve the deletion of "${session.name}"? This action cannot be undone.`)) {
                    return;
                }
                
                const sessionIndex = sessions.findIndex(s => s.id === request.sessionId);
                if (sessionIndex !== -1) {
                    sessions.splice(sessionIndex, 1);
                    renderSessions();
                }
            }
            
            // Mark request as approved
            request.status = 'approved';
            request.processedDate = new Date().toLocaleString();
            
            updateApprovalRequestsList();
            updatePendingRequestsCount();
            saveToLocalStorage();
            
            alert(`Session ${getActionDisplayName(request.type).toLowerCase()} request from ${request.memberName} has been approved.`);
        }
        
        // Function to reject session request
        function rejectSessionRequest(requestId) {
            const request = pendingSessionRequests.find(r => r.id === requestId);
            if (!request || request.status !== 'pending') {
                alert('Request not found or already processed.');
                return;
            }
            
            const reason = prompt('Enter reason for rejection (optional):');
            
            // Mark request as rejected
            request.status = 'rejected';
            request.processedDate = new Date().toLocaleString();
            request.rejectionReason = reason;
            
            updateApprovalRequestsList();
            updatePendingRequestsCount();
            saveToLocalStorage();
            
            alert(`Session ${getActionDisplayName(request.type).toLowerCase()} request from ${request.memberName} has been rejected.`);
        }
        
        // Function to approve expense request
        function approveExpenseRequest(requestId) {
            const request = pendingExpenseRequests.find(r => r.id === requestId);
            if (!request || request.status !== 'pending') {
                alert('Request not found or already processed.');
                return;
            }
            
            // Add the expense to the main budget system
            const expense = {
                id: Date.now(),
                description: request.description,
                amount: request.amount,
                category: request.category,
                date: request.date,
                addedBy: request.memberName,
                addedDate: new Date().toLocaleString(),
                approvedBy: 'Admin',
                memberRequest: true
            };
            
            expenses.push(expense);
            
            // Mark request as approved
            request.status = 'approved';
            request.processedDate = new Date().toLocaleString();
            
            // Update displays
            updateBudgetSummary();
            renderExpenses();
            updateApprovalRequestsList();
            updatePendingRequestsCount();
            saveToLocalStorage();
            
            alert(`Expense request from ${request.memberName} has been approved and added to budget.\n\nDescription: ${request.description}\nAmount: ‚Ç±${request.amount.toFixed(2)}`);
        }
        
        // Function to reject expense request
        function rejectExpenseRequest(requestId) {
            const request = pendingExpenseRequests.find(r => r.id === requestId);
            if (!request || request.status !== 'pending') {
                alert('Request not found or already processed.');
                return;
            }
            
            const reason = prompt('Enter reason for rejection (optional):');
            
            // Mark request as rejected
            request.status = 'rejected';
            request.processedDate = new Date().toLocaleString();
            request.rejectionReason = reason;
            
            updateApprovalRequestsList();
            updatePendingRequestsCount();
            saveToLocalStorage();
            
            alert(`Expense request from ${request.memberName} has been rejected.`);
        }
        
        // Function to update penalty displays for member view
        function updatePenaltyDisplays() {
            // Update penalty displays with current grading criteria values
            const memberViewElements = {
                'tardiness-penalty': gradingCriteria.tardinessPenalty,
                'absence-penalty': gradingCriteria.absencePenalty,
                'missed-activity-penalty': gradingCriteria.missedActivityPenalty,
                'late-submission-penalty': gradingCriteria.lateSubmissionPenalty
            };
            
            Object.entries(memberViewElements).forEach(([elementId, penaltyValue]) => {
                const input = document.getElementById(elementId);
                if (input && input.parentNode) {
                    const memberViewDiv = input.parentNode.querySelector('.member-view');
                    if (memberViewDiv) {
                        memberViewDiv.textContent = `${penaltyValue.toFixed(1)} points per incident`;
                    }
                }
            });
        }

        // Function to add member note
        function addMemberNote() {
            // Check if user has permission to add notes
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can add notes.');
                return;
            }
            
            const noteText = document.getElementById('note-text').value.trim();
            const category = document.getElementById('note-category').value;
            
            if (!noteText) {
                alert('Please enter a note');
                return;
            }
            
            const note = {
                id: Date.now(),
                text: noteText,
                category: category,
                date: new Date().toLocaleString(),
                author: 'Admin' // In a full system, this would be the logged-in user
            };
            
            if (!members[currentMember].notes) {
                members[currentMember].notes = [];
            }
            
            members[currentMember].notes.unshift(note); // Add to beginning
            updateNotesDisplay();
            renderAllNotes();
            saveToLocalStorage(); // Save changes immediately
            
            // Clear form
            document.getElementById('note-text').value = '';
            document.getElementById('note-category').value = 'general';
        }
        
        // Function to edit note
        function editNote(memberId, noteId) {
            // Check if user has permission to edit notes
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can edit notes.');
                return;
            }
            
            const noteTextDiv = document.getElementById(`note-text-${noteId}`);
            const editForm = document.getElementById(`edit-form-${noteId}`);
            
            noteTextDiv.style.display = 'none';
            editForm.style.display = 'block';
        }
        
        // Function to cancel note edit
        function cancelNoteEdit(noteId) {
            const noteTextDiv = document.getElementById(`note-text-${noteId}`);
            const editForm = document.getElementById(`edit-form-${noteId}`);
            
            noteTextDiv.style.display = 'block';
            editForm.style.display = 'none';
        }
        
        // Function to save note edit
        function saveNoteEdit(memberId, noteId) {
            // Check if user has permission to save note edits
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can edit notes.');
                return;
            }
            
            const newText = document.getElementById(`edit-text-${noteId}`).value.trim();
            const newCategory = document.getElementById(`edit-category-${noteId}`).value;
            
            if (!newText) {
                alert('Note text cannot be empty');
                return;
            }
            
            const member = members[memberId];
            const noteIndex = member.notes.findIndex(note => note.id === noteId);
            
            if (noteIndex !== -1) {
                member.notes[noteIndex].text = newText;
                member.notes[noteIndex].category = newCategory;
                member.notes[noteIndex].lastEdited = new Date().toLocaleString();
                
                updateNotesDisplay();
                renderAllNotes();
                saveToLocalStorage(); // Save changes immediately
                
                alert('Note updated successfully!');
            }
        }
        
        // Function to delete note
        function deleteNote(memberId, noteId) {
            // Check if user has permission to delete notes
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can delete notes.');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
                return;
            }
            
            const member = members[memberId];
            const noteIndex = member.notes.findIndex(note => note.id === noteId);
            
            if (noteIndex !== -1) {
                member.notes.splice(noteIndex, 1);
                updateNotesDisplay();
                renderAllNotes();
                saveToLocalStorage(); // Save changes immediately
                
                alert('Note deleted successfully!');
            }
        }

        // Function to update notes display in modal
        function updateNotesDisplay() {
            const notesList = document.getElementById('notes-list');
            const member = members[currentMember];
            
            if (!member.notes || member.notes.length === 0) {
                notesList.innerHTML = '<p>No notes recorded for this member.</p>';
                return;
            }
            
            notesList.innerHTML = '';
            member.notes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'event-item';
                noteItem.style.marginBottom = '10px';
                
                const categoryColors = {
                    general: '#6c757d',
                    attendance: '#dc3545',
                    performance: '#28a745',
                    behavior: '#ffc107',
                    financial: '#007bff'
                };
                
                noteItem.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="background: ${categoryColors[note.category]}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px;">
                            ${note.category.toUpperCase()}
                        </span>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editNote('${currentMember}', ${note.id})" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" title="Edit Note" class="admin-only">‚úèÔ∏è</button>
                            <button onclick="deleteNote('${currentMember}', ${note.id})" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" title="Delete Note" class="admin-only">üóëÔ∏è</button>
                            <span style="font-size: 12px; color: #666; margin-left: 5px;">${note.date}</span>
                        </div>
                    </div>
                    <div class="event-details" style="margin-top: 5px;" id="note-text-${note.id}">
                        ${note.text}
                        <br><small style="color: #888;">By: ${note.author}</small>
                    </div>
                    <div id="edit-form-${note.id}" style="display: none; margin-top: 10px;">
                        <textarea id="edit-text-${note.id}" class="form-control" rows="2" style="margin-bottom: 10px;">${note.text}</textarea>
                        <select id="edit-category-${note.id}" class="form-control" style="width: 150px; display: inline-block; margin-right: 10px;">
                            <option value="general" ${note.category === 'general' ? 'selected' : ''}>General</option>
                            <option value="attendance" ${note.category === 'attendance' ? 'selected' : ''}>Attendance</option>
                            <option value="performance" ${note.category === 'performance' ? 'selected' : ''}>Performance</option>
                            <option value="behavior" ${note.category === 'behavior' ? 'selected' : ''}>Behavior</option>
                            <option value="financial" ${note.category === 'financial' ? 'selected' : ''}>Financial</option>
                        </select>
                        <button onclick="saveNoteEdit('${currentMember}', ${note.id})" class="btn btn-success admin-only" style="font-size: 11px; padding: 4px 8px; margin-right: 5px;">Save</button>
                        <button onclick="cancelNoteEdit(${note.id})" class="btn" style="font-size: 11px; padding: 4px 8px;">Cancel</button>
                    </div>
                `;
                
                notesList.appendChild(noteItem);
            });
        }

        // Function to render all notes in the Notes tab
        function renderAllNotes() {
            const allNotesList = document.getElementById('all-notes-list');
            allNotesList.innerHTML = '';
            
            // Collect all notes from all members
            let allNotes = [];
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                if (member.notes && member.notes.length > 0) {
                    member.notes.forEach(note => {
                        allNotes.push({
                            ...note,
                            memberName: member.name,
                            memberId: memberId
                        });
                    });
                }
            });
            
            // Sort by date (newest first)
            allNotes.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allNotes.length === 0) {
                allNotesList.innerHTML = '<div class="event-item"><div class="event-title">No notes recorded yet.</div></div>';
                return;
            }
            
            allNotes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'event-item';
                noteItem.style.marginBottom = '15px';
                
                const categoryColors = {
                    general: '#6c757d',
                    attendance: '#dc3545',
                    performance: '#28a745',
                    behavior: '#ffc107',
                    financial: '#007bff'
                };
                
                noteItem.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="background: ${categoryColors[note.category]}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px;">
                                ${note.category.toUpperCase()}
                            </span>
                            <strong>${note.memberName.split(',')[0]}</strong>
                        </div>
                        <span style="font-size: 12px; color: #666;">${note.date}</span>
                    </div>
                    <div class="event-details" style="margin-top: 5px;">
                        ${note.text}
                        <br><small style="color: #888;">By: ${note.author}</small>
                    </div>
                `;
                
                allNotesList.appendChild(noteItem);
            });
        }

        // Function to filter notes
        function filterNotes() {
            const memberFilter = document.getElementById('notes-filter-member').value;
            const categoryFilter = document.getElementById('notes-filter-category').value;
            const allNotesList = document.getElementById('all-notes-list');
            
            // Collect and filter notes
            let filteredNotes = [];
            Object.keys(members).forEach(memberId => {
                if (memberFilter !== 'all' && memberId !== memberFilter) return;
                
                const member = members[memberId];
                if (member.notes && member.notes.length > 0) {
                    member.notes.forEach(note => {
                        if (categoryFilter !== 'all' && note.category !== categoryFilter) return;
                        
                        filteredNotes.push({
                            ...note,
                            memberName: member.name,
                            memberId: memberId
                        });
                    });
                }
            });
            
            // Sort by date (newest first)
            filteredNotes.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            allNotesList.innerHTML = '';
            
            if (filteredNotes.length === 0) {
                allNotesList.innerHTML = '<div class="event-item"><div class="event-title">No notes match the selected filters.</div></div>';
                return;
            }
            
            filteredNotes.forEach(note => {
                const noteItem = document.createElement('div');
                noteItem.className = 'event-item';
                noteItem.style.marginBottom = '15px';
                
                const categoryColors = {
                    general: '#6c757d',
                    attendance: '#dc3545',
                    performance: '#28a745',
                    behavior: '#ffc107',
                    financial: '#007bff'
                };
                
                noteItem.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="background: ${categoryColors[note.category]}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px;">
                                ${note.category.toUpperCase()}
                            </span>
                            <strong>${note.memberName.split(',')[0]}</strong>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button onclick="editNote('${note.memberId}', ${note.id})" style="background: #007bff; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" title="Edit Note" class="admin-only">‚úèÔ∏è</button>
                            <button onclick="deleteNote('${note.memberId}', ${note.id})" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer;" title="Delete Note" class="admin-only">üóëÔ∏è</button>
                            <span style="font-size: 12px; color: #666;">${note.date}</span>
                        </div>
                    </div>
                    <div class="event-details" style="margin-top: 5px;" id="note-text-${note.id}">
                        ${note.text}
                        <br><small style="color: #888;">By: ${note.author}</small>
                        ${note.lastEdited ? `<br><small style="color: #666;">Last edited: ${note.lastEdited}</small>` : ''}
                    </div>
                    <div id="edit-form-${note.id}" style="display: none; margin-top: 10px;">
                        <textarea id="edit-text-${note.id}" class="form-control" rows="2" style="margin-bottom: 10px;">${note.text}</textarea>
                        <select id="edit-category-${note.id}" class="form-control" style="width: 150px; display: inline-block; margin-right: 10px;">
                            <option value="general" ${note.category === 'general' ? 'selected' : ''}>General</option>
                            <option value="attendance" ${note.category === 'attendance' ? 'selected' : ''}>Attendance</option>
                            <option value="performance" ${note.category === 'performance' ? 'selected' : ''}>Performance</option>
                            <option value="behavior" ${note.category === 'behavior' ? 'selected' : ''}>Behavior</option>
                            <option value="financial" ${note.category === 'financial' ? 'selected' : ''}>Financial</option>
                        </select>
                        <button onclick="saveNoteEdit('${note.memberId}', ${note.id})" class="btn btn-success" style="font-size: 11px; padding: 4px 8px; margin-right: 5px;">Save</button>
                        <button onclick="cancelNoteEdit(${note.id})" class="btn" style="font-size: 11px; padding: 4px 8px;">Cancel</button>
                    </div>
                `;
                
                allNotesList.appendChild(noteItem);
            });
        }

        // Function to export data
        function exportData() {
            const exportData = {
                members: members,
                sessions: sessions,
                contributions: contributions,
                expenses: expenses,
                gradingCriteria: gradingCriteria,
                recentlyDeleted: recentlyDeleted,
                exportDate: new Date().toISOString(),
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `attendance_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('Data exported successfully!');
        }

        // Function to import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.members || !importedData.version) {
                        throw new Error('Invalid data format');
                    }
                    
                    // Confirm import
                    if (confirm('This will replace all current data. Are you sure you want to import?')) {
                        // Import data
                        members = importedData.members || {};
                        
                        // Handle both old format (events/meetings) and new format (sessions)
                        if (importedData.sessions) {
                            sessions = importedData.sessions;
                        } else {
                            // Convert old format to new format
                            sessions = [];
                            if (importedData.events) {
                                importedData.events.forEach(event => {
                                    sessions.push({
                                        id: event.id,
                                        category: 'Activity / Task',
                                        name: event.name,
                                        startTime: event.deadline,
                                        endTime: event.deadline,
                                        attendees: event.participants || [],
                                        completed: event.completed || false,
                                        issues: event.missed || [],
                                        createdDate: event.createdDate || new Date().toLocaleString(),
                                        completionDate: event.completionDate,
                                        reason: event.reason
                                    });
                                });
                            }
                            if (importedData.meetings) {
                                importedData.meetings.forEach(meeting => {
                                    sessions.push({
                                        id: meeting.id,
                                        category: 'Meeting ONLY',
                                        name: meeting.type,
                                        startTime: meeting.date,
                                        endTime: meeting.date,
                                        attendees: meeting.attendees || [],
                                        completed: meeting.completed || false,
                                        issues: meeting.tardy || [],
                                        createdDate: meeting.date || new Date().toLocaleString(),
                                        completionDate: meeting.completionDate,
                                        reason: meeting.reason
                                    });
                                });
                            }
                        }
                        
                        contributions = importedData.contributions || [];
                        expenses = importedData.expenses || [];
                        gradingCriteria = importedData.gradingCriteria || gradingCriteria;
                        
                        // Re-initialize display
                        init();
                        alert(`Data imported successfully from ${importedData.exportDate ? new Date(importedData.exportDate).toLocaleDateString() : 'unknown date'}!`);
                    }
                } catch (error) {
                    alert('Error importing data: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Clear the input
            event.target.value = '';
        }

        // Function to export attendance data to CSV
        function exportAttendanceCSV() {
            let csvContent = 'Member Name,Tardiness,Absences,Missed Activities,Late Submissions,Deductions,Total Contributions,Paid Amount,Remaining\n';
            
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                
                // Calculate financial data
                let totalContributions = 0;
                let paidAmount = 0;
                
                contributions.forEach(contribution => {
                    totalContributions += contribution.amount;
                    const payment = member.payments.find(p => p.contributionId === contribution.id);
                    if (payment) {
                        if (payment.paid) {
                            paidAmount += contribution.amount;
                        } else if (payment.partialAmount) {
                            paidAmount += payment.partialAmount;
                        }
                    }
                });
                
                const remaining = totalContributions - paidAmount;
                
                csvContent += `"${member.name}",${member.tardiness},${member.absences},${member.missedActivities},${member.lateSubmissions},${member.deductions},${totalContributions.toFixed(2)},${paidAmount.toFixed(2)},${remaining.toFixed(2)}\n`;
            });
            
            const csvBlob = new Blob([csvContent], {type: 'text/csv'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(csvBlob);
            link.download = `attendance_report_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            alert('CSV report exported successfully!');
        }

        // Function to backup system data
        function backupData() {
            const backupData = {
                ...exportData,
                backupDate: new Date().toISOString(),
                backupType: 'manual'
            };
            
            // Store in localStorage as backup
            localStorage.setItem('attendanceBackup_' + Date.now(), JSON.stringify(backupData));
            
            // Also download as file
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `attendance_backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('Data backed up successfully!');
        }

        // Global Search Functions
        function performGlobalSearch() {
            const searchTerm = document.getElementById('global-search').value.toLowerCase().trim();
            const searchType = document.getElementById('search-type').value;
            const dateFrom = document.getElementById('search-date-from').value;
            const dateTo = document.getElementById('search-date-to').value;
            
            if (!searchTerm && !dateFrom && !dateTo) {
                alert('Please enter a search term or select a date range');
                return;
            }
            
            const results = [];
            
            // Search Events
            if (searchType === 'all' || searchType === 'events') {
                events.forEach(event => {
                    let matches = false;
                    
                    if (searchTerm && (event.name.toLowerCase().includes(searchTerm) || 
                        (event.reason && event.reason.toLowerCase().includes(searchTerm)))) {
                        matches = true;
                    }
                    
                    if (dateFrom || dateTo) {
                        const eventDate = new Date(event.deadline).toISOString().split('T')[0];
                        if (dateFrom && eventDate < dateFrom) matches = false;
                        if (dateTo && eventDate > dateTo) matches = false;
                        if (!searchTerm && ((dateFrom && eventDate >= dateFrom) || (dateTo && eventDate <= dateTo))) matches = true;
                    }
                    
                    if (matches) {
                        results.push({
                            type: 'Event',
                            title: event.name,
                            details: `Deadline: ${new Date(event.deadline).toLocaleDateString()}`,
                            status: event.completed ? 'Completed' : 'Pending'
                        });
                    }
                });
            }
            
            // Search Meetings
            if (searchType === 'all' || searchType === 'meetings') {
                meetings.forEach(meeting => {
                    let matches = false;
                    
                    if (searchTerm && (meeting.type.toLowerCase().includes(searchTerm) || 
                        (meeting.reason && meeting.reason.toLowerCase().includes(searchTerm)))) {
                        matches = true;
                    }
                    
                    if (dateFrom || dateTo) {
                        const meetingDate = new Date(meeting.date).toISOString().split('T')[0];
                        if (dateFrom && meetingDate < dateFrom) matches = false;
                        if (dateTo && meetingDate > dateTo) matches = false;
                        if (!searchTerm && ((dateFrom && meetingDate >= dateFrom) || (dateTo && meetingDate <= dateTo))) matches = true;
                    }
                    
                    if (matches) {
                        results.push({
                            type: 'Meeting',
                            title: meeting.type,
                            details: `Date: ${meeting.date}`,
                            status: meeting.completed ? 'Completed' : 'Pending'
                        });
                    }
                });
            }
            
            // Search Contributions
            if (searchType === 'all' || searchType === 'contributions') {
                contributions.forEach(contribution => {
                    let matches = false;
                    
                    if (searchTerm && contribution.purpose.toLowerCase().includes(searchTerm)) {
                        matches = true;
                    }
                    
                    if (dateFrom || dateTo) {
                        const contribDate = new Date(contribution.deadline).toISOString().split('T')[0];
                        if (dateFrom && contribDate < dateFrom) matches = false;
                        if (dateTo && contribDate > dateTo) matches = false;
                        if (!searchTerm && ((dateFrom && contribDate >= dateFrom) || (dateTo && contribDate <= dateTo))) matches = true;
                    }
                    
                    if (matches) {
                        results.push({
                            type: 'Contribution',
                            title: `‚Ç±${contribution.amount.toFixed(2)} - ${contribution.purpose}`,
                            details: `Deadline: ${new Date(contribution.deadline).toLocaleDateString()}`,
                            status: 'Active'
                        });
                    }
                });
            }
            
            // Search Notes
            if (searchType === 'all' || searchType === 'notes') {
                Object.keys(members).forEach(memberId => {
                    const member = members[memberId];
                    if (member.notes) {
                        member.notes.forEach(note => {
                            if (searchTerm && (note.text.toLowerCase().includes(searchTerm) || 
                                note.category.toLowerCase().includes(searchTerm))) {
                                results.push({
                                    type: 'Note',
                                    title: `${member.name.split(',')[0]} - ${note.category}`,
                                    details: note.text.substring(0, 100) + (note.text.length > 100 ? '...' : ''),
                                    status: note.date
                                });
                            }
                        });
                    }
                });
            }
            
            // Search Expenses
            if (searchType === 'all' || searchType === 'expenses') {
                expenses.forEach(expense => {
                    let matches = false;
                    
                    if (searchTerm && (expense.description.toLowerCase().includes(searchTerm) || 
                        expense.category.toLowerCase().includes(searchTerm))) {
                        matches = true;
                    }
                    
                    if (dateFrom || dateTo) {
                        if (dateFrom && expense.date < dateFrom) matches = false;
                        if (dateTo && expense.date > dateTo) matches = false;
                        if (!searchTerm && ((dateFrom && expense.date >= dateFrom) || (dateTo && expense.date <= dateTo))) matches = true;
                    }
                    
                    if (matches) {
                        results.push({
                            type: 'Expense',
                            title: `‚Ç±${expense.amount.toFixed(2)} - ${expense.description}`,
                            details: `Category: ${expense.category}, Date: ${expense.date}`,
                            status: 'Recorded'
                        });
                    }
                });
            }
            
            displaySearchResults(results);
        }
        
        function displaySearchResults(results) {
            const searchResultsDiv = document.getElementById('search-results');
            const searchResultsContent = document.getElementById('search-results-content');
            
            if (results.length === 0) {
                searchResultsContent.innerHTML = '<p>No results found.</p>';
            } else {
                searchResultsContent.innerHTML = `<p><strong>${results.length} result(s) found:</strong></p>`;
                
                results.forEach(result => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'event-item';
                    resultItem.style.marginBottom = '10px';
                    
                    const typeColors = {
                        'Event': '#3498db',
                        'Meeting': '#2ecc71',
                        'Contribution': '#f39c12',
                        'Note': '#9b59b6',
                        'Expense': '#e74c3c'
                    };
                    
                    resultItem.innerHTML = `
                        <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="background: ${typeColors[result.type]}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 10px;">
                                    ${result.type.toUpperCase()}
                                </span>
                                ${result.title}
                            </div>
                            <small style="color: #666;">${result.status}</small>
                        </div>
                        <div class="event-details">${result.details}</div>
                    `;
                    
                    searchResultsContent.appendChild(resultItem);
                });
            }
            
            searchResultsDiv.style.display = 'block';
        }
        
        function clearSearch() {
            document.getElementById('global-search').value = '';
            document.getElementById('search-type').value = 'all';
            document.getElementById('search-date-from').value = '';
            document.getElementById('search-date-to').value = '';
            document.getElementById('search-results').style.display = 'none';
        }
        
        // Event Filtering Functions
        function filterEvents() {
            const statusFilter = document.getElementById('events-filter-status').value;
            const memberFilter = document.getElementById('events-filter-member').value;
            const dateFilter = document.getElementById('events-filter-date').value;
            
            let filteredEvents = events.filter(event => {
                if (statusFilter !== 'all') {
                    if (statusFilter === 'completed' && !event.completed) return false;
                    if (statusFilter === 'pending' && event.completed) return false;
                }
                
                if (memberFilter !== 'all') {
                    if (!event.participants.includes(memberFilter)) return false;
                }
                
                if (dateFilter) {
                    const eventDate = new Date(event.deadline).toISOString().split('T')[0];
                    if (eventDate !== dateFilter) return false;
                }
                
                return true;
            });
            
            renderFilteredEvents(filteredEvents);
        }
        
        function renderFilteredEvents(filteredEvents) {
            const eventsList = document.getElementById('events-list');
            eventsList.innerHTML = '';
            
            if (filteredEvents.length === 0) {
                eventsList.innerHTML = '<div class="event-item"><div class="event-title">No events match the selected filters.</div></div>';
                return;
            }
            
            filteredEvents.forEach(event => {
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                
                let participants = '';
                event.participants.forEach(p => {
                    participants += members[p].name.split(',')[0] + ', ';
                });
                participants = participants.slice(0, -2);
                
                let status = event.completed ? 
                    `<span style="color: green;">Completed</span>` : 
                    `<span style="color: orange;">Pending</span>`;
                
                let issues = '';
                let completionButton = '';
                
                if (event.completed) {
                    if (event.missed.length > 0 || event.late.length > 0) {
                        issues = `<div style="color: red; margin-top: 5px;">Issues recorded: ${event.reason}</div>`;
                    } else {
                        issues = `<div style="color: green; margin-top: 5px;">No issues recorded - ${event.reason}</div>`;
                    }
                    if (event.completionDate) {
                        issues += `<div style="color: #666; font-size: 12px; margin-top: 3px;">Completed on: ${event.completionDate}</div>`;
                    }
                } else {
                    completionButton = `<button class="btn btn-success" onclick="manualCompleteEvent(${event.id})" style="margin-top: 10px; font-size: 12px;">Mark as Completed</button>`;
                }
                
                eventItem.innerHTML = `
                    <div class="event-title">${event.name} ${status}</div>
                    <div class="event-details">
                        Deadline: ${new Date(event.deadline).toLocaleString()}<br>
                        Participants: ${participants}
                        ${issues}
                        ${completionButton}
                    </div>
                `;
                
                eventsList.appendChild(eventItem);
            });
        }
        
        function clearEventFilters() {
            document.getElementById('events-filter-status').value = 'all';
            document.getElementById('events-filter-member').value = 'all';
            document.getElementById('events-filter-date').value = '';
            renderEvents(); // Show all events
        }
        
        // Meeting Filtering Functions
        function filterMeetings() {
            const typeFilter = document.getElementById('meetings-filter-type').value;
            const statusFilter = document.getElementById('meetings-filter-status').value;
            const dateFilter = document.getElementById('meetings-filter-date').value;
            
            let filteredMeetings = meetings.filter(meeting => {
                if (typeFilter !== 'all' && meeting.type !== typeFilter) return false;
                
                if (statusFilter !== 'all') {
                    if (statusFilter === 'completed' && !meeting.completed) return false;
                    if (statusFilter === 'pending' && meeting.completed) return false;
                }
                
                if (dateFilter) {
                    const meetingDate = new Date(meeting.date).toISOString().split('T')[0];
                    if (meetingDate !== dateFilter) return false;
                }
                
                return true;
            });
            
            renderFilteredMeetings(filteredMeetings);
        }
        
        function renderFilteredMeetings(filteredMeetings) {
            const meetingsList = document.getElementById('meetings-list');
            meetingsList.innerHTML = '';
            
            if (filteredMeetings.length === 0) {
                meetingsList.innerHTML = '<div class="meeting-item"><div class="meeting-title">No meetings match the selected filters.</div></div>';
                return;
            }
            
            filteredMeetings.forEach(meeting => {
                const meetingItem = document.createElement('div');
                meetingItem.className = 'meeting-item';
                
                let attendees = '';
                meeting.attendees.forEach(a => {
                    attendees += members[a].name.split(',')[0] + ', ';
                });
                attendees = attendees.slice(0, -2);
                
                let status = meeting.completed ? 
                    `<span style="color: green;">Completed</span>` : 
                    `<span style="color: orange;">Pending</span>`;
                
                let issues = '';
                let completionButton = '';
                
                if (meeting.completed) {
                    if (meeting.tardy.length > 0 || meeting.absent.length > 0) {
                        issues = `<div style="color: red; margin-top: 5px;">Issues recorded: ${meeting.reason}</div>`;
                    } else {
                        issues = `<div style="color: green; margin-top: 5px;">No issues recorded - ${meeting.reason}</div>`;
                    }
                    if (meeting.completionDate) {
                        issues += `<div style="color: #666; font-size: 12px; margin-top: 3px;">Completed on: ${meeting.completionDate}</div>`;
                    }
                } else {
                    completionButton = `<button class="btn btn-success" onclick="manualCompleteMeeting(${meeting.id})" style="margin-top: 10px; font-size: 12px;">Mark as Completed</button>`;
                }
                
                meetingItem.innerHTML = `
                    <div class="meeting-title">${meeting.type} ${status}</div>
                    <div class="meeting-details">
                        Date: ${meeting.date}<br>
                        Attendees: ${attendees}
                        ${issues}
                        ${completionButton}
                    </div>
                `;
                
                meetingsList.appendChild(meetingItem);
            });
        }
        
        function clearMeetingFilters() {
            document.getElementById('meetings-filter-type').value = 'all';
            document.getElementById('meetings-filter-status').value = 'all';
            document.getElementById('meetings-filter-date').value = '';
            renderMeetings(); // Show all meetings
        }

        // Achievement System Functions
        function generateLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            
            // Calculate scores for each member
            const memberScores = Object.keys(members).map(memberId => {
                const member = members[memberId];
                const score = 100 - (member.tardiness * 2) - (member.absences * 5) - (member.missedActivities * 3) - (member.lateSubmissions * 1) - member.deductions;
                return {
                    id: memberId,
                    name: member.name,
                    score: Math.max(0, score),
                    tardiness: member.tardiness,
                    absences: member.absences,
                    missedActivities: member.missedActivities,
                    lateSubmissions: member.lateSubmissions
                };
            });
            
            // Sort by score (highest first)
            memberScores.sort((a, b) => b.score - a.score);
            
            leaderboard.innerHTML = '';
            
            let currentRank = 1;
            let currentScore = null;
            let membersInCurrentRank = 0;
            
            memberScores.forEach((member, index) => {
                // Handle ties: if score is different from previous, update rank
                if (currentScore !== null && member.score !== currentScore) {
                    currentRank += membersInCurrentRank;
                    membersInCurrentRank = 0;
                }
                currentScore = member.score;
                membersInCurrentRank++;
                
                const rankItem = document.createElement('div');
                rankItem.className = 'event-item';
                rankItem.style.marginBottom = '10px';
                
                const rankColors = {
                    1: '#ffd700', // Gold
                    2: '#c0c0c0', // Silver
                    3: '#cd7f32', // Bronze
                };
                
                const rankEmojis = {
                    1: 'ü•á', // Gold medal
                    2: 'ü•à', // Silver medal
                    3: 'ü•â', // Bronze medal
                };
                
                rankItem.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center;">
                            <span style="background: ${rankColors[currentRank] || '#6c757d'}; color: white; padding: 5px 10px; border-radius: 50%; margin-right: 15px; font-weight: bold;">
                                ${rankEmojis[currentRank] || currentRank}
                            </span>
                            <strong>${member.name.split(',')[0]}</strong>
                        </div>
                        <div style="font-size: 20px; font-weight: bold; color: ${member.score >= 90 ? 'green' : member.score >= 70 ? 'orange' : 'red'};">
                            ${member.score.toFixed(1)} pts
                        </div>
                    </div>
                    <div class="event-details">
                        Tardiness: ${member.tardiness} | Absences: ${member.absences} | Missed Activities: ${member.missedActivities} | Late Submissions: ${member.lateSubmissions}
                    </div>
                `;
                
                leaderboard.appendChild(rankItem);
            });
        }
        
        function generateAchievementBadges() {
            const badgesContainer = document.getElementById('achievement-badges');
            badgesContainer.innerHTML = '';
            
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                const badges = [];
                
                // Perfect Attendance Badge
                if (member.absences === 0) {
                    badges.push({
                        name: 'Perfect Attendance',
                        emoji: 'üèÜ',
                        color: '#28a745',
                        description: 'No absences recorded'
                    });
                }
                
                // Punctuality Badge
                if (member.tardiness === 0) {
                    badges.push({
                        name: 'Always On Time',
                        emoji: '‚è∞',
                        color: '#17a2b8',
                        description: 'No tardiness recorded'
                    });
                }
                
                // Reliable Badge
                if (member.missedActivities === 0) {
                    badges.push({
                        name: 'Reliable Member',
                        emoji: '‚≠ê',
                        color: '#ffc107',
                        description: 'No missed activities'
                    });
                }
                
                // Prompt Submitter Badge
                if (member.lateSubmissions === 0) {
                    badges.push({
                        name: 'Prompt Submitter',
                        emoji: 'üìÑ',
                        color: '#6f42c1',
                        description: 'No late submissions'
                    });
                }
                
                // Model Student Badge (all zeros)
                if (member.tardiness === 0 && member.absences === 0 && member.missedActivities === 0 && member.lateSubmissions === 0) {
                    badges.push({
                        name: 'Model Student',
                        emoji: 'üåü',
                        color: '#dc3545',
                        description: 'Perfect record across all categories'
                    });
                }
                
                // Contributor Badge (paid all contributions)
                let isFullContributor = true;
                contributions.forEach(contribution => {
                    const payment = member.payments.find(p => p.contributionId === contribution.id);
                    if (!payment || !payment.paid) {
                        isFullContributor = false;
                    }
                });
                
                if (isFullContributor && contributions.length > 0) {
                    badges.push({
                        name: 'Full Contributor',
                        emoji: 'üí∞',
                        color: '#fd7e14',
                        description: 'Paid all contributions on time'
                    });
                }
                
                // Create member badge section
                const memberSection = document.createElement('div');
                memberSection.style.marginBottom = '20px';
                
                const memberTitle = document.createElement('h5');
                memberTitle.textContent = member.name.split(',')[0];
                memberSection.appendChild(memberTitle);
                
                if (badges.length === 0) {
                    const noBadges = document.createElement('p');
                    noBadges.textContent = 'No badges earned yet. Keep improving!';
                    noBadges.style.color = '#6c757d';
                    noBadges.style.fontStyle = 'italic';
                    memberSection.appendChild(noBadges);
                } else {
                    const badgesDiv = document.createElement('div');
                    badgesDiv.style.display = 'flex';
                    badgesDiv.style.flexWrap = 'wrap';
                    badgesDiv.style.gap = '10px';
                    
                    badges.forEach(badge => {
                        const badgeElement = document.createElement('div');
                        badgeElement.style.background = badge.color;
                        badgeElement.style.color = 'white';
                        badgeElement.style.padding = '8px 12px';
                        badgeElement.style.borderRadius = '20px';
                        badgeElement.style.fontSize = '12px';
                        badgeElement.style.fontWeight = 'bold';
                        badgeElement.style.display = 'flex';
                        badgeElement.style.alignItems = 'center';
                        badgeElement.style.gap = '5px';
                        badgeElement.title = badge.description;
                        badgeElement.innerHTML = `${badge.emoji} ${badge.name}`;
                        
                        badgesDiv.appendChild(badgeElement);
                    });
                    
                    memberSection.appendChild(badgesDiv);
                }
                
                badgesContainer.appendChild(memberSection);
            });
        }
        
        function generateImprovementTracking() {
            const improvementContainer = document.getElementById('improvement-tracking');
            improvementContainer.innerHTML = '';
            
            // Since we don't have historical data, we'll show current status and suggestions
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                const memberSection = document.createElement('div');
                memberSection.className = 'event-item';
                memberSection.style.marginBottom = '15px';
                
                // Calculate improvement score
                const totalIssues = member.tardiness + member.absences + member.missedActivities + member.lateSubmissions;
                const improvementLevel = totalIssues === 0 ? 'Excellent' : 
                                       totalIssues <= 2 ? 'Good' : 
                                       totalIssues <= 5 ? 'Needs Improvement' : 'Critical';
                
                const levelColors = {
                    'Excellent': '#28a745',
                    'Good': '#17a2b8',
                    'Needs Improvement': '#ffc107',
                    'Critical': '#dc3545'
                };
                
                // Generate suggestions
                const suggestions = [];
                if (member.tardiness > 0) suggestions.push('Focus on punctuality');
                if (member.absences > 0) suggestions.push('Improve attendance');
                if (member.missedActivities > 0) suggestions.push('Participate in all activities');
                if (member.lateSubmissions > 0) suggestions.push('Submit work on time');
                if (suggestions.length === 0) suggestions.push('Keep up the excellent work!');
                
                memberSection.innerHTML = `
                    <div class="event-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>${member.name.split(',')[0]}</strong>
                        <span style="background: ${levelColors[improvementLevel]}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                            ${improvementLevel}
                        </span>
                    </div>
                    <div class="event-details">
                        <div><strong>Current Issues:</strong> ${totalIssues}</div>
                        <div><strong>Suggestions:</strong> ${suggestions.join(', ')}</div>
                        <div style="margin-top: 10px;"><strong>Progress Goal:</strong> Reduce total issues by 50% next month</div>
                    </div>
                `;
                
                improvementContainer.appendChild(memberSection);
            });
        }
        
        // Initialize the application
        function init() {
            // Load saved data from localStorage if available
            const savedData = localStorage.getItem('attendanceSystemData');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.members) members = data.members;
                    if (data.sessions) sessions = data.sessions;
                    if (data.contributions) contributions = data.contributions;
                    if (data.expenses) expenses = data.expenses;
                    if (data.gradingCriteria) gradingCriteria = data.gradingCriteria;
                    if (data.recentlyDeleted) recentlyDeleted = data.recentlyDeleted;
                    if (data.pendingPaymentRequests) pendingPaymentRequests = data.pendingPaymentRequests;
                    if (data.pendingSessionRequests) pendingSessionRequests = data.pendingSessionRequests;
                    if (data.pendingExpenseRequests) pendingExpenseRequests = data.pendingExpenseRequests;
                    if (data.userPasswords) userPasswords = data.userPasswords;
                } catch (error) {
                    console.error('Error loading saved data:', error);
                }
            }
            
            // Only initialize UI if user is logged in
            if (currentUser) {
                // Initialize displays
                renderSessions();
                renderContributions();
                renderExpenses();
                renderAllNotes();
                generateAlerts();
                drawPerformanceChart();
                updateFinancialSummary();
                updateBudgetSummary();
                updateSystemStats();
                updateRecentlyDeletedDisplay();
                generateLeaderboard();
                generateAchievementBadges();
                generateImprovementTracking();
                
                // Update penalty displays
                updatePenaltyDisplays();
                
                // Update pending requests count for admins
                if (userRole === 'admin') {
                    updatePendingRequestsCount();
                }
                
                // Initialize dynamic UI components
                updateMemberButtons();
                updateSessionModalAttendees();
                updateFilterDropdowns();
            }
            
            // Auto-save data every 30 seconds
            setInterval(saveToLocalStorage, 30000);
        }
        
        // Function to populate login member dropdown
        function populateLoginMembers() {
            console.log('populateLoginMembers called');
            const memberSelect = document.getElementById('member-select');
            if (!memberSelect) {
                console.log('member-select element not found');
                return;
            }
            
            console.log('Found member-select element');
            console.log('Available members:', Object.keys(members));
            
            // Clear existing options
            memberSelect.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '-- Choose Your Name --';
            memberSelect.appendChild(defaultOption);
            
            // Add all members to dropdown
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                const option = document.createElement('option');
                option.value = memberId;
                option.textContent = member.name;
                memberSelect.appendChild(option);
                console.log('Added member:', member.name);
            });
            
            console.log('Final dropdown options count:', memberSelect.options.length);
        }
        
        // Save data to localStorage
        function saveToLocalStorage() {
            const dataToSave = {
                members,
                sessions,
                contributions,
                expenses,
                gradingCriteria,
                recentlyDeleted,
                pendingPaymentRequests,
                pendingSessionRequests,
                pendingExpenseRequests,
                userPasswords,
                lastSaved: new Date().toISOString()
            };
            localStorage.setItem('attendanceSystemData', JSON.stringify(dataToSave));
        }
        
        // Update system stats
        function updateSystemStats() {
            document.getElementById('stats-members').textContent = Object.keys(members).length;
            document.getElementById('stats-sessions').textContent = sessions.length;
            document.getElementById('stats-contributions').textContent = contributions.length;
            document.getElementById('stats-expenses').textContent = expenses.length;
            
            let totalNotes = 0;
            Object.values(members).forEach(member => {
                if (member.notes) totalNotes += member.notes.length;
            });
            document.getElementById('stats-notes').textContent = totalNotes;
            
            document.getElementById('stats-updated').textContent = new Date().toLocaleString();
        }
        
        window.onload = function() {
            console.log('Page loaded - calling populateLoginMembers');
            
            // Show login screen initially
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
            
            // Populate login dropdown immediately
            populateLoginMembers();
            
            // Try multiple times in case of timing issues
            setTimeout(populateLoginMembers, 100);
            setTimeout(populateLoginMembers, 500);
        };
        
        function openChangePasswordModal() {
            if (userRole !== 'admin') {
                alert('Access denied. Only administrators can change passwords.');
                return;
            }
            
            // Debug logging
            console.log('Current admin password:', userPasswords.admin);
            console.log('All user passwords:', userPasswords);
            
            // Verify admin password first
            const adminPassword = prompt('Enter admin password to proceed:');
            if (!adminPassword) {
                return;
            }
            
            if (adminPassword !== userPasswords.admin) {
                alert('Incorrect admin password. Access denied.\n\nCurrent admin password is: ' + userPasswords.admin);
                return;
            }
            
            document.getElementById('change-password-modal').style.display = 'flex';
            populatePasswordManagement();
        }
        
        function closeChangePasswordModal() {
            document.getElementById('change-password-modal').style.display = 'none';
        }
        
        function populatePasswordManagement() {
            const container = document.getElementById('password-management-content');
            
            let html = `
                <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="margin-top: 0; color: #2c3e50; text-align: center;">Password Management</h3>
                    
                    <!-- Admin Password Section -->
                    <div style="margin-bottom: 20px; padding: 15px; border-radius: 6px; border-left: 4px solid #dc3545; background: #fff5f5;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #dc3545;">üîë Admin Password</h4>
                            <span style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">ADMIN</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Current Password:</strong> <span style="font-family: monospace; background: #e9ecef; padding: 2px 6px; border-radius: 3px;">${userPasswords.admin}</span>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="password" id="new-admin-password" class="form-control" placeholder="Enter new admin password" style="flex: 1;" autocomplete="new-password">
                            <button class="btn btn-danger" onclick="changeUserPassword('admin')" style="font-size: 12px;">Change Admin</button>
                        </div>
                    </div>
                    
                    <h4 style="color: #3498db; margin: 20px 0 15px 0; border-bottom: 2px solid #3498db; padding-bottom: 5px;">üë• Member Passwords</h4>
                    
                    <div style="display: grid; gap: 20px;">
            `;
            
            // Member passwords section only
            Object.keys(members).forEach(memberId => {
                const member = members[memberId];
                html += `
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; border-left: 4px solid #3498db;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #3498db;">üë§ ${member.name}</h4>
                            <span style="background: #3498db; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">MEMBER</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Current Password:</strong> <span style="font-family: monospace; background: #e9ecef; padding: 2px 6px; border-radius: 3px;">${userPasswords[memberId]}</span>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="password" id="new-${memberId}-password" class="form-control" placeholder="Enter new password for ${member.name.split(',')[0]}" style="flex: 1;" autocomplete="new-password">
                            <button class="btn btn-primary" onclick="changeUserPassword('${memberId}')" style="font-size: 12px;">Change</button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
                
                <div style="background: #d1ecf1; padding: 15px; border-radius: 6px; border-left: 4px solid #bee5eb;">
                    <h4 style="margin: 0 0 10px 0; color: #0c5460;">üìù Password Requirements</h4>
                    <ul style="margin: 0; color: #0c5460; font-size: 14px;">
                        <li>Passwords must be at least 3 characters long</li>
                        <li>Passwords are case-sensitive</li>
                        <li>Avoid using simple passwords like "123" or "password"</li>
                        <li>Changes take effect immediately</li>
                        <li>Admin password changes require current password verification</li>
                    </ul>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function changeUserPassword(userId) {
            // Handle admin password changes with extra security
            if (userId === 'admin') {
                const inputElement = document.getElementById(`new-${userId}-password`);
                console.log('Input element for', userId, ':', inputElement);
                
                if (!inputElement) {
                    alert('Error: Input field not found for ' + userId);
                    return;
                }
                
                const newPassword = inputElement.value.trim();
                console.log('Retrieved password value:', newPassword);
                console.log('Password length:', newPassword.length);
                
                if (!newPassword) {
                    alert('Please enter a new admin password.');
                    console.log('Password validation failed: empty password');
                    return;
                }
                
                if (newPassword.length < 3) {
                    alert('Admin password must be at least 3 characters long.');
                    return;
                }
                
                // Show verification modal for admin password change
                showAdminPasswordVerificationModal(newPassword, inputElement);
                return;
            }
            
            // Debug: Check if the input element exists
            const inputElement = document.getElementById(`new-${userId}-password`);
            console.log('Input element for', userId, ':', inputElement);
            
            if (!inputElement) {
                alert('Error: Input field not found for ' + userId);
                return;
            }
            
            const newPassword = inputElement.value.trim();
            console.log('Retrieved password value:', newPassword);
            console.log('Password length:', newPassword.length);
            
            if (!newPassword) {
                alert('Please enter a new password.');
                console.log('Password validation failed: empty password');
                return;
            }
            
            if (newPassword.length < 3) {
                alert('Password must be at least 3 characters long.');
                return;
            }
            
            // Continue with member password change
            proceedWithPasswordChange(userId, newPassword, inputElement);
        }
        
        function showAdminPasswordVerificationModal(newPassword, inputElement) {
            const modalHTML = `
                <div id="admin-verify-modal" class="modal" style="display: flex;">
                    <div class="modal-content" style="max-width: 400px;">
                        <div class="modal-header">
                            <h2>üîë Verify Current Admin Password</h2>
                        </div>
                        
                        <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <p style="margin: 0; color: #856404; font-size: 14px;">
                                <strong>Security Check:</strong> Please enter your current admin password to confirm this change.
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label for="current-admin-password">Current Admin Password:</label>
                            <input type="password" id="current-admin-password" class="form-control" placeholder="Enter current admin password" style="font-size: 16px; padding: 12px;" autocomplete="current-password">
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="btn btn-danger" onclick="verifyCurrentAdminPassword('${newPassword}')" style="margin-right: 10px;">Verify & Change Password</button>
                            <button class="btn" onclick="closeAdminVerifyModal()">Cancel</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if present
            const existingModal = document.getElementById('admin-verify-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Focus on the password input
            setTimeout(() => {
                const passwordInput = document.getElementById('current-admin-password');
                if (passwordInput) {
                    passwordInput.focus();
                }
            }, 100);
        }
        
        function verifyCurrentAdminPassword(newPassword) {
            const currentPasswordInput = document.getElementById('current-admin-password');
            const currentPassword = currentPasswordInput.value.trim();
            
            if (!currentPassword) {
                alert('Please enter your current admin password.');
                return;
            }
            
            if (currentPassword !== userPasswords.admin) {
                alert('Incorrect current admin password. Password change cancelled for security.');
                return;
            }
            
            // Close the verification modal
            closeAdminVerifyModal();
            
            // Get the original input element
            const inputElement = document.getElementById('new-admin-password');
            
            // Proceed with the password change
            proceedWithPasswordChange('admin', newPassword, inputElement);
        }
        
        function closeAdminVerifyModal() {
            const modal = document.getElementById('admin-verify-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function proceedWithPasswordChange(userId, newPassword, inputElement) {
            // Final confirmation
            const userName = userId === 'admin' ? 'Administrator' : members[userId].name;
            if (!confirm(`Are you sure you want to change the password for ${userName}?\n\nNew password: ${newPassword}`)) {
                return;
            }
            
            // Debug logging
            console.log('Changing password for:', userId);
            console.log('Old password:', userPasswords[userId]);
            console.log('New password:', newPassword);
            
            // Update the password in userPasswords
            userPasswords[userId] = newPassword;
            
            // Update member password (sync both locations) - only for members, not admin
            if (userId !== 'admin' && members[userId]) {
                members[userId].password = newPassword;
            }
            
            // Debug logging after update
            console.log('Updated userPasswords:', userPasswords);
            
            // Save to localStorage
            saveToLocalStorage();
            
            // Clear the input
            if (inputElement) {
                inputElement.value = '';
            }
            
            // Refresh the display
            populatePasswordManagement();
            
            alert(`‚úÖ Password changed successfully for ${userName}!\n\nNew password: ${newPassword}`);
        }
    </script>

    <!-- Change Password Modal -->
    <div id="change-password-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üîë Change User Passwords</h2>
                <span class="close" onclick="closeChangePasswordModal()">&times;</span>
            </div>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                <p style="margin: 0; color: #856404; font-size: 14px;">
                    <strong>‚ö†Ô∏è Warning:</strong> You must enter the admin password to change any password. Changes are permanent!
                </p>
            </div>
            
            <div id="password-management-content">
                <!-- Password management content will be populated here -->
            </div>
            
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="closeChangePasswordModal()">Close</button>
            </div>
        </div>
    </div>

</body>
</html>